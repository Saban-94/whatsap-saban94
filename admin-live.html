<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.住 - 注专转  转拽转</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { background-color: #f4f6f8; font-family: 'Segoe UI', sans-serif; }
        .sidebar { background: #263238; min-height: 100vh; color: white; padding: 20px; }
        .nav-link { color: #b0bec5; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px; }
        .nav-link:hover, .nav-link.active { background: #37474f; color: white; }
        .nav-link i { font-size: 20px; }
        
        .main-content { padding: 30px; }
        .card-custom { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); background: white; }
        
        /*  */
        .table th { border-top: none; color: #555; font-size: 0.9rem; }
        .table td { vertical-align: middle; }
        
        /* ' */
        .badge-type { padding: 5px 10px; border-radius: 6px; font-weight: normal; font-size: 0.85rem; }
        .b-crane { background: #e3f2fd; color: #1976d2; }
        .b-truck { background: #e8f5e9; color: #2e7d32; }
        .b-cont { background: #fff3e0; color: #ef6c00; }

        /*  */
        .modal-header { background: #008069; color: white; }
        .btn-saban { background: #008069; color: white; border: none; }
        .btn-saban:hover { background: #00695c; color: white; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar">
            <h4 class="mb-4 fw-bold text-center">.住 </h4>
            <div class="nav-link active" onclick="switchTab('live')"><i class="material-icons">dvr</i>  </div>
            <div class="nav-link" onclick="switchTab('history')"><i class="material-icons">history</i> 专 住专</div>
        </div>

        <div class="col-md-10 main-content">
            
            <div id="tab-live">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3> 转 驻注转</h3>
                    <button class="btn btn-saban" data-bs-toggle="modal" data-bs-target="#editModal" onclick="resetForm()">
                        <i class="material-icons" style="vertical-align:middle">add</i>  砖
                    </button>
                </div>
                
                <div class="card card-custom p-3">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>拽</th>
                                <th>转转</th>
                                <th>住</th>
                                <th></th>
                                <th>砖注转 住驻拽</th>
                                <th>驻注转</th>
                            </tr>
                        </thead>
                        <tbody id="live-table">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-history" style="display:none;">
                <h3 class="mb-4"> 专 爪注</h3>
                <div class="card card-custom p-3">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>转专</th>
                                <th>拽</th>
                                <th>住</th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="history-table">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"> 砖</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="orderForm">
                    <input type="hidden" id="edit-id"> <div class="mb-3">
                        <label>砖 拽</label>
                        <input type="text" id="in-name" class="form-control" required>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label>住驻专 </label>
                            <input type="text" id="in-orgId" class="form-control">
                        </div>
                        <div class="col-6 mb-3">
                            <label>住 </label>
                            <select id="in-type" class="form-select">
                                <option>祝 10 专</option>
                                <option>祝 15 专</option>
                                <option> 8 拽</option>
                                <option> 24 拽</option>
                                <option>砖转 专</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>转转</label>
                        <input type="text" id="in-addr" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>砖 </label>
                        <input type="text" id="in-driver" class="form-control">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label>转专 住驻拽</label>
                            <input type="date" id="in-date" class="form-control">
                        </div>
                        <div class="col-6 mb-3">
                            <label>砖注转 注</label>
                            <input type="time" id="in-time" class="form-control">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-saban w-100">砖专 砖</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60",
        projectId: "app-saban94-57361",
        appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let allOrders = [];

    // ---  转 ---
    const q = query(collection(db, "users"), orderBy("lastUpdate", "desc"));
    onSnapshot(q, (snap) => {
        allOrders = [];
        const liveTbody = document.getElementById('live-table');
        const histTbody = document.getElementById('history-table');
        liveTbody.innerHTML = ''; histTbody.innerHTML = '';

        snap.forEach(docSnap => {
            const d = docSnap.data();
            d.id = docSnap.id;
            allOrders.push(d);

            // 住 转转
            let badgeClass = 'b-truck';
            if(d.deliveryType.includes('祝')) badgeClass = 'b-crane';
            if(d.deliveryType.includes('')) badgeClass = 'b-cont';

            const row = document.createElement('tr');
            
            if(d.status === 4) {
                // 住专
                row.innerHTML = `
                    <td>${d.targetDate || '-'}</td>
                    <td>${d.name}</td>
                    <td><span class="badge-type ${badgeClass}">${d.deliveryType}</span></td>
                    <td>${d.driverName || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="window.editOrder('${d.id}')"><i class="material-icons" style="font-size:16px">edit</i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="window.deleteOrder('${d.id}')"><i class="material-icons" style="font-size:16px">delete</i></button>
                    </td>
                `;
                histTbody.appendChild(row);
            } else {
                // 驻注
                row.innerHTML = `
                    <td>${d.orgId || '---'}</td>
                    <td class="fw-bold">${d.name}</td>
                    <td>${d.address || ''}</td>
                    <td><span class="badge-type ${badgeClass}">${d.deliveryType}</span></td>
                    <td>${d.driverName || '<span class="text-muted">专 砖抓</span>'}</td>
                    <td class="fw-bold text-success">${d.targetTime || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="window.editOrder('${d.id}')">注专</button>
                        <button class="btn btn-sm btn-outline-success" onclick="window.markDone('${d.id}')">住驻拽</button>
                    </td>
                `;
                liveTbody.appendChild(row);
            }
        });
    });

    // --- 驻拽爪转 转 ---
    
    // 注专 
    window.switchTab = (tab) => {
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('tab-live').style.display = tab === 'live' ? 'block' : 'none';
        document.getElementById('tab-history').style.display = tab === 'history' ? 'block' : 'none';
    };

    // 驻住 驻住 住驻
    window.resetForm = () => {
        document.getElementById('orderForm').reset();
        document.getElementById('edit-id').value = '';
        document.getElementById('modalTitle').innerText = ' 砖';
        document.getElementById('in-date').valueAsDate = new Date();
    };

    // 驻转转 注专 ( 驻住 转 拽)
    window.editOrder = (id) => {
        const order = allOrders.find(o => o.id === id);
        if(!order) return;

        document.getElementById('edit-id').value = id;
        document.getElementById('in-name').value = order.name;
        document.getElementById('in-orgId').value = order.orgId || '';
        document.getElementById('in-type').value = order.deliveryType;
        document.getElementById('in-addr').value = order.address || '';
        document.getElementById('in-driver').value = order.driverName || '';
        document.getElementById('in-date').value = order.targetDate || '';
        document.getElementById('in-time').value = order.targetTime || '';

        document.getElementById('modalTitle').innerText = '注专转 ';
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
    };

    // 砖专 (住驻  注)
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        
        const data = {
            name: document.getElementById('in-name').value,
            orgId: document.getElementById('in-orgId').value,
            deliveryType: document.getElementById('in-type').value,
            address: document.getElementById('in-addr').value,
            driverName: document.getElementById('in-driver').value,
            targetDate: document.getElementById('in-date').value,
            targetTime: document.getElementById('in-time').value,
            lastUpdate: new Date()
        };

        if(id) {
            // 注
            await updateDoc(doc(db, "users", id), data);
        } else {
            // 砖
            data.status = 1;
            await addDoc(collection(db, "users"), data);
        }

        // 住专转 
        const modalEl = document.getElementById('editModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    });

    // 拽
    window.deleteOrder = async (id) => {
        if(confirm('拽 爪转转 住专?')) {
            await deleteDoc(doc(db, "users", id));
        }
    };

    // 注专 住专 (住驻拽)
    window.markDone = async (id) => {
        await updateDoc(doc(db, "users", id), { status: 4 });
    };

</script>
</body>
</html>
