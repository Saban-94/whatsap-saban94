<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.住 - 住专 </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 100px; }
        
        /* 住专 爪 */
        .sidebar {
            background: #263238; min-height: 100vh; color: white; padding: 20px;
            position: fixed; right: 0; top: 0; width: 250px; z-index: 1000;
        }
        .main-content { margin-right: 250px; padding: 30px; }
        
        .nav-btn {
            width: 100%; text-align: right; padding: 12px; margin-bottom: 8px;
            background: transparent; border: none; color: #b0bec5; border-radius: 8px;
            display: flex; align-items: center; gap: 10px; transition: 0.3s;
        }
        .nav-btn:hover, .nav-btn.active { background: #37474f; color: white; }
        .nav-btn i { font-size: 22px; }

        /* 专住 转 */
        .card-box { background: white; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); border: none; overflow: hidden; }
        .table thead th { background: #f8f9fa; border-bottom: 2px solid #e9ecef; color: #495057; font-weight: 600; }
        .table td { vertical-align: middle; }
        
        /* 驻转专 砖专 专 */
        .quick-client-btn {
            background: white; border: 1px solid #ddd; padding: 10px 15px; border-radius: 10px;
            cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; min-width: 120px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .quick-client-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: #008069; }
        .qc-icon { background: #e0f2f1; color: #00695c; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-bottom: 5px; }
        .qc-name { font-weight: bold; font-size: 0.9rem; }
        .qc-sub { font-size: 0.75rem; color: #777; }

        /* 驻转专  */
        .btn-icon { padding: 5px 10px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3 class="mb-4 text-center fw-bold" style="color:#00e676;">.住 住拽</h3>
    <button class="nav-btn active" onclick="showTab('live')"><i class="material-icons">dvr</i>  驻注</button>
    <button class="nav-btn" onclick="showTab('history')"><i class="material-icons">history</i> 专 住专</button>
    <button class="nav-btn" onclick="showTab('clients')"><i class="material-icons">people</i>  拽转</button>
    
    <div style="margin-top: 50px; border-top: 1px solid #444; padding-top: 20px;">
        <small class="text-muted">住 砖转:</small>
        <button class="btn btn-outline-light w-100 mt-2 btn-sm" data-bs-toggle="modal" data-bs-target="#newsModal">
            <i class="material-icons" style="vertical-align:middle; font-size:16px;">campaign</i> 注专 驻住 砖转
        </button>
    </div>
</div>

<div class="main-content">

    <div id="tab-live">
        <div class="mb-4">
            <h5 class="text-muted mb-3"><i class="material-icons" style="vertical-align:middle">rocket_launch</i> 砖专 专 (拽转 拽注)</h5>
            <div class="d-flex gap-3 flex-wrap" id="quick-bar">
                <div class="text-muted p-2">注 拽转...</div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold"> 转 驻注转</h3>
            <button class="btn btn-primary" onclick="openOrderModal()">
                <i class="material-icons" style="vertical-align:middle">add</i>  砖 ()
            </button>
        </div>

        <div class="card-box">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>转注</th>
                            <th>拽</th>
                            <th></th>
                            <th>转转 </th>
                            <th>住</th>
                            <th> 注</th>
                            <th>驻注转</th>
                        </tr>
                    </thead>
                    <tbody id="live-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-history" style="display:none;">
        <h3 class="fw-bold mb-3"> 专 爪注</h3>
        <div class="alert alert-info"> 爪转  转 砖住驻拽. 拽   住驻转.</div>
        <div class="card-box">
            <table class="table table-striped mb-0">
                <thead>
                    <tr>
                        <th>转专 爪注</th>
                        <th>拽</th>
                        <th></th>
                        <th>住</th>
                        <th>转转</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-clients" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold"> 专 拽转 砖专 专</h3>
            <button class="btn btn-success" onclick="openClientModal()">
                <i class="material-icons" style="vertical-align:middle">person_add</i> 住祝 拽
            </button>
        </div>
        <div class="card-box p-3">
            <table class="table">
                <thead><tr><th>砖 拽</th><th>转转 专专转 </th><th>住 专专转 </th><th>驻注转</th></tr></thead>
                <tbody id="clients-body"></tbody>
            </table>
        </div>
    </div>

</div>

<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">驻专 </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="orderForm">
                    <input type="hidden" id="o-id">
                    <div class="row g-2 mb-2">
                        <div class="col-4"><label>住' 转注</label><input type="text" id="o-oid" class="form-control" placeholder="1001"></div>
                        <div class="col-8"><label>砖 拽</label><input type="text" id="o-name" class="form-control" required></div>
                    </div>
                    <div class="mb-2">
                        <label>转转  ( 驻!)</label>
                        <input type="text" id="o-addr" class="form-control" placeholder="注专, 专 住驻专">
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6"><label> 砖抓</label><input type="text" id="o-driver" class="form-control"></div>
                        <div class="col-6"><label>住 </label>
                            <select id="o-type" class="form-select">
                                <option>祝 10 专</option>
                                <option>祝 15 专</option>
                                <option>祝 专注</option>
                                <option> 8 拽</option>
                                <option> 24 拽</option>
                                <option>砖转 专</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label>转专 注</label><input type="date" id="o-date" class="form-control"></div>
                        <div class="col-6"><label>砖注转 注</label><input type="time" id="o-time" class="form-control"></div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">砖专 砖 住</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="clientModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white"><h5 class="modal-title">拽 砖</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="clientForm">
                    <div class="mb-2"><label>砖 拽</label><input type="text" id="c-name" class="form-control" required></div>
                    <div class="mb-2"><label>转转 拽注</label><input type="text" id="c-addr" class="form-control"></div>
                    <div class="mb-2"><label>住 拽注</label>
                        <select id="c-type" class="form-select">
                            <option>祝 10 专</option><option> 8 拽</option><option>砖转 专</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success w-100 mt-2">砖专 拽</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newsModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white"><h5 class="modal-title">注专 驻住 砖转</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <label>注:</label>
                <input type="text" id="news-text" class="form-control mb-2">
                <label>爪注:</label>
                <select id="news-color" class="form-select mb-2">
                    <option value="blue"> (专)</option>
                    <option value="red"> (祝/专)</option>
                    <option value="green">专拽 (注 砖转)</option>
                </select>
                <button onclick="publishNews()" class="btn btn-dark w-100">注 住</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, setDoc, doc, onSnapshot, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const config = { apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60", projectId: "app-saban94-57361", appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa" };
    const db = getFirestore(initializeApp(config));
    
    let allOrders = [];
    let allClients = [];

    // --- 1. 注转 转 (Live & History) ---
    onSnapshot(query(collection(db, "users"), orderBy("lastUpdate", "desc")), (snap) => {
        allOrders = [];
        const live = document.getElementById('live-body');
        const hist = document.getElementById('history-body');
        live.innerHTML = ''; hist.innerHTML = '';

        snap.forEach(docSnap => {
            const d = docSnap.data(); d.id = docSnap.id; allOrders.push(d);
            
            if(d.status === 4) {
                // 住专
                hist.innerHTML += `
                    <tr>
                        <td>${d.targetDate || '-'}</td>
                        <td><b>${d.name}</b></td>
                        <td>${d.driverName || '-'}</td>
                        <td>${d.deliveryType}</td>
                        <td class="text-muted small">${d.address || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger btn-icon" onclick="window.del('${d.id}')" title="拽 爪转转">
                                <i class="material-icons" style="font-size:16px">delete</i>
                            </button>
                        </td>
                    </tr>
                `;
            } else {
                // 驻注
                live.innerHTML += `
                    <tr>
                        <td>${d.orgId || '--'}</td>
                        <td><b>${d.name}</b></td>
                        <td>${d.driverName || '<span class="badge bg-secondary">--</span>'}</td>
                        <td>${d.address || '<span class="text-danger">住专</span>'}</td>
                        <td><span class="badge bg-light text-dark border">${d.deliveryType}</span></td>
                        <td class="text-success fw-bold">${d.targetTime || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-icon" onclick="window.edit('${d.id}')"><i class="material-icons" style="font-size:16px">edit</i></button>
                            <button class="btn btn-sm btn-success btn-icon" onclick="window.markDone('${d.id}')"><i class="material-icons" style="font-size:16px">check</i></button>
                        </td>
                    </tr>
                `;
            }
        });
    });

    // --- 2. 注转 拽转 (Clients) ---
    onSnapshot(collection(db, "clients"), (snap) => {
        allClients = [];
        const bar = document.getElementById('quick-bar');
        const list = document.getElementById('clients-body');
        bar.innerHTML = ''; list.innerHTML = '';

        snap.forEach(docSnap => {
            const c = docSnap.data(); c.id = docSnap.id; allClients.push(c);
            
            // 驻转专 砖专 专
            bar.innerHTML += `
                <div class="quick-client-btn" onclick="window.quickLaunch('${c.id}')">
                    <div class="qc-icon"><i class="material-icons">person</i></div>
                    <div class="qc-name">${c.name}</div>
                    <div class="qc-sub">${c.type}</div>
                </div>
            `;

            // 砖专 转 
            list.innerHTML += `
                <tr>
                    <td><b>${c.name}</b></td>
                    <td>${c.address}</td>
                    <td>${c.type}</td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="window.delClient('${c.id}')">拽</button></td>
                </tr>
            `;
        });
    });

    // --- 拽 驻拽爪转 ---

    window.showTab = (tab) => {
        document.getElementById('tab-live').style.display = tab==='live'?'block':'none';
        document.getElementById('tab-history').style.display = tab==='history'?'block':'none';
        document.getElementById('tab-clients').style.display = tab==='clients'?'block':'none';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
    };

    //  砖 / 注专
    window.openOrderModal = () => {
        document.getElementById('orderForm').reset();
        document.getElementById('o-id').value = '';
        document.getElementById('o-date').valueAsDate = new Date();
        document.getElementById('modalTitle').innerText = ' 砖';
        new bootstrap.Modal(document.getElementById('orderModal')).show();
    };

    window.edit = (id) => {
        const o = allOrders.find(x => x.id === id);
        if(!o) return;
        document.getElementById('o-id').value = id;
        document.getElementById('o-name').value = o.name;
        document.getElementById('o-oid').value = o.orgId || '';
        document.getElementById('o-addr').value = o.address || '';
        document.getElementById('o-driver').value = o.driverName || '';
        document.getElementById('o-type').value = o.deliveryType;
        document.getElementById('o-date').value = o.targetDate || '';
        document.getElementById('o-time').value = o.targetTime || '';
        document.getElementById('modalTitle').innerText = '注专转 ';
        new bootstrap.Modal(document.getElementById('orderModal')).show();
    };

    // 砖专 专
    window.quickLaunch = (cid) => {
        const c = allClients.find(x => x.id === cid);
        if(!c) return;
        
        // 驻转   转
        openOrderModal();
        document.getElementById('o-name').value = c.name;
        document.getElementById('o-addr').value = c.address;
        document.getElementById('o-type').value = c.type;
        //  转专 砖注 转 注砖 + 砖注
        const now = new Date();
        now.setHours(now.getHours() + 1);
        document.getElementById('o-time').value = now.toTimeString().substring(0,5);
    };

    // 砖专转 
    document.getElementById('orderForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('o-id').value;
        const d = {
            name: document.getElementById('o-name').value,
            orgId: document.getElementById('o-oid').value,
            address: document.getElementById('o-addr').value,
            driverName: document.getElementById('o-driver').value,
            deliveryType: document.getElementById('o-type').value,
            targetDate: document.getElementById('o-date').value,
            targetTime: document.getElementById('o-time').value,
            lastUpdate: new Date()
        };

        if(id) { await updateDoc(doc(db,"users",id), d); }
        else { d.status = 1; await addDoc(collection(db,"users"), d); }
        
        bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
    };

    //  住住 拽
    window.markDone = async (id) => updateDoc(doc(db,"users",id), {status: 4});
    window.del = async (id) => { if(confirm('拽 爪转转?')) deleteDoc(doc(db,"users",id)); };

    //  拽转
    window.openClientModal = () => new bootstrap.Modal(document.getElementById('clientModal')).show();
    
    document.getElementById('clientForm').onsubmit = async (e) => {
        e.preventDefault();
        await addDoc(collection(db, "clients"), {
            name: document.getElementById('c-name').value,
            address: document.getElementById('c-addr').value,
            type: document.getElementById('c-type').value
        });
        bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide();
    };
    
    window.delClient = async (id) => { if(confirm('拽 拽?')) deleteDoc(doc(db,"clients",id)); };

    // 砖转
    window.publishNews = async () => {
        const txt = document.getElementById('news-text').value;
        const col = document.getElementById('news-color').value;
        let typ='info', tit='注', icon='campaign';
        
        if(col==='red') { typ='alert'; tit='专'; icon='warning'; }
        if(col==='green') { typ='success'; tit='注'; icon='celebration'; }

        await setDoc(doc(db, "settings", "news"), { text: txt, type: typ, title: tit, icon: icon });
        bootstrap.Modal.getInstance(document.getElementById('newsModal')).hide();
    };

</script>
</body>
</html>
