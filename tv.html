<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×—.×¡×‘×Ÿ - ×“×©×‘×•×¨×“ ×œ×•×’×™×¡×˜×™ ×××•×—×“ (Master V3)</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* === ×¡×’× ×•× ×•×ª ×‘×¡×™×¡ (××ª×•×š style.css ×•-tv.html) === */
        :root {
            --primary-color: #008069;
            --win-accent: #0078d4;
            --neon-blue: #00f2ff;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --bg-gradient: radial-gradient(circle at top right, #f0f4f8, #d9e2ec);
            --card-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        body { 
            background: #e2e2e2 url('https://img.freepik.com/free-vector/white-abstract-background_23-2148810353.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #201f1e;
            font-family: 'Heebo', sans-serif;
            margin: 0;
            overflow: hidden; /* ×× ×™×¢×ª ×’×œ×™×œ×” ×©×œ ×›×œ ×”××¡×š */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* === ×¡×¨×’×œ ××“×“×™× ×¢×œ×™×•×Ÿ === */
        .metrics-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 ×¢××•×“×•×ª ×›×•×œ×œ ×”×™×¡×˜×•×¨×™×” */
            gap: 15px;
            padding: 15px 20px;
            background: linear-gradient(90deg, #004d40, #008069);
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .metric-card {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
            transition: transform 0.2s;
            cursor: pointer;
        }
        
        .metric-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.25); }

        .big-num { font-size: 2.2rem; font-weight: 900; line-height: 1; display: block; }
        .label { font-size: 0.85rem; opacity: 0.9; }

        /* ××¤×§×˜ × ×—×© (×× ×™××¦×™×”) ×œ×›×¨×˜×™×¡ ×¤×¢×™×œ */
        .active-snake::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 4px;
            background: linear-gradient(90deg, transparent, var(--neon-blue), transparent);
            animation: snake-run 3s linear infinite;
        }
        @keyframes snake-run { 0% { left: -100%; } 100% { left: 100%; } }

        /* === ×¤×¨×™×¡×” ×¨××©×™×ª === */
        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            padding: 20px;
            flex: 1;
            overflow: hidden;
        }

        .panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.6);
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .panel-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid rgba(0,0,0,0.05); padding-bottom: 10px; margin-bottom: 15px;
        }
        .panel-header h3 { margin: 0; color: var(--primary-color); font-size: 1.3rem; }

        .scroll-feed { flex: 1; overflow-y: auto; padding-right: 5px; }
        
        /* === ×›×¨×˜×™×¡×™ ×”×–×× ×” === */
        .order-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-right: 6px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .order-card.status-1 { border-right-color: #ff3b30; animation: pulse-red 2s infinite; } /* ×—×“×© - ××“×•× ××”×‘×”×‘ */
        .order-card.status-2 { border-right-color: #fbc02d; } /* ×‘×˜×™×¤×•×œ - ×›×ª×•× */
        .order-card.status-3 { border-right-color: #00e676; } /* ×‘×“×¨×š - ×™×¨×•×§ */
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }

        .card-info h4 { margin: 0 0 5px 0; font-size: 1.2rem; }
        .card-details { font-size: 0.9rem; color: #555; display: flex; flex-direction: column; gap: 2px; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; background: #eee; margin-top: 5px; width: fit-content; }
        .tag.crane { background: #e3f2fd; color: #1976d2; }

        .card-actions { display: flex; flex-direction: column; gap: 8px; min-width: 140px; }
        .driver-input { padding: 6px; border: 1px solid #ccc; border-radius: 6px; width: 100%; font-family: inherit; font-size: 0.9rem; }
        .btn-action { border: none; padding: 8px; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-done { background: #2e7d32; } .btn-done:hover { background: #1b5e20; }
        
        /* === ×‘×× ×¨ ×”×–×× ×” ×“×—×•×¤×” === */
        .next-delivery-banner {
            background: linear-gradient(135deg, #0078d4, #00bcf2);
            color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 8px 20px rgba(0,120,212,0.3);
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* === ×›×¤×ª×•×¨ ×¤×œ×•×¡ ×¦×£ === */
        .fab-add {
            position: fixed; bottom: 30px; left: 30px; width: 70px; height: 70px;
            background: var(--primary-color); color: white; border: none; border-radius: 50%;
            font-size: 36px; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            transition: transform 0.3s;
        }
        .fab-add:hover { transform: scale(1.1) rotate(90deg); }

        /* === ××•×“××œ×™× === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; gap: 15px; max-height: 85vh; overflow-y: auto;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .input-field { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; width: 100%; box-sizing: border-box; background: #f9f9f9; }
        .input-field:focus { border-color: var(--primary-color); outline: none; background: white; }
        
        /* === ×¡×’× ×•×Ÿ ×˜×‘×œ×ª ×”×™×¡×˜×•×¨×™×” === */
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th { text-align: right; color: #888; font-size: 0.85rem; border-bottom: 1px solid #eee; padding: 5px; }
        .history-table td { padding: 10px 5px; border-bottom: 1px solid #f5f5f5; font-size: 0.9rem; }

        /* ×”×ª×××” ×œ××•×‘×™×™×œ ×× ×¦×¨×™×š */
        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
            .metrics-bar { grid-template-columns: repeat(2, 1fr); }
            .panel { height: 40vh; }
        }
    </style>
</head>
<body>

    <audio id="sound-new" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

    <header class="metrics-bar">
        <div class="metric-card active-snake">
            <span class="big-num" id="m-0517">0</span>
            <span class="label">×”×–×× ×•×ª ×™×•× (05-17)</span>
        </div>
        <div class="metric-card">
            <span class="big-num" id="m-active">0</span>
            <span class="label">×¤×¢×™×œ ×›×¢×ª</span>
        </div>
        <div class="metric-card" style="background: rgba(0,0,0,0.2);">
            <div id="clock" class="big-num">00:00</div>
            <span class="label">×©×¢×•×Ÿ ××§×•××™</span>
        </div>
        <div class="metric-card" style="background: var(--neon-blue); color: #004d40;">
            <span class="big-num" id="next-timer">--:--</span>
            <span class="label">××¡×¤×§×” ×§×¨×•×‘×”</span>
        </div>
        <div class="metric-card" onclick="toggleHistoryModal()" style="border-color: #ffd700;">
            <span class="big-num"><i class="material-icons">history</i></span>
            <span class="label">××¨×›×™×•×Ÿ ×•×”×™×¡×˜×•×¨×™×”</span>
        </div>
    </header>

    <div class="main-layout">
        <div class="panel">
            <div class="panel-header">
                <h3>ğŸ•’ ×”×–×× ×•×ª ×¢×ª×™×“×™×•×ª (××—×¨+)</h3>
                <span class="tag" id="future-count">0</span>
            </div>
            <div id="future-feed" class="scroll-feed">
                </div>
        </div>

        <div class="panel">
            <div id="priority-banner" class="next-delivery-banner" style="display:none;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <i class="material-icons" style="font-size:40px; background:rgba(255,255,255,0.2); border-radius:50%; padding:10px;">local_shipping</i>
                    <div>
                        <div style="font-size:0.9rem; opacity:0.9;">×™×¢×“ ×”××¡×¤×§×” ×”×§×¨×•×‘ ×‘×™×•×ª×¨:</div>
                        <h2 id="next-cust-name" style="margin:0; font-size:1.8rem;">×˜×•×¢×Ÿ...</h2>
                    </div>
                </div>
                <div style="text-align:left;">
                    <div id="next-cust-time" style="font-size:2rem; font-weight:900;">--:--</div>
                    <div id="next-cust-details">×¤×¨×˜×™×...</div>
                </div>
            </div>

            <div class="panel-header">
                <h3>ğŸš€ ×¡×™×“×•×¨ ×¢×‘×•×“×” ×—×™ (×”×™×•×)</h3>
                <span class="tag" style="background:#e8f5e9; color:#2e7d32;" id="active-count">0</span>
            </div>
            <div id="active-feed" class="scroll-feed">
                </div>
        </div>
    </div>

    <button class="fab-add" onclick="openAddModal()">
        <i class="material-icons">add</i>
    </button>

    <div id="modal-add" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0; color:var(--primary-color);">×”×–×× ×” ×—×“×©×” ğŸ—ï¸</h2>
                <i class="material-icons" onclick="closeModal('modal-add')" style="cursor:pointer;">close</i>
            </div>
            
            <input type="text" id="in-num" class="input-field" placeholder="××¡×¤×¨ ×”×–×× ×” (ERP)">
            
            <input type="text" id="in-cust" list="clients-list" class="input-field" placeholder="×©× ×œ×§×•×— (×”×ª×—×œ ×œ×”×§×œ×™×“...)" autocomplete="off">
            <datalist id="clients-list">
                </datalist>

            <input type="text" id="in-addr" class="input-field" placeholder="×›×ª×•×‘×ª / ××ª×¨ ×‘× ×™×”">
            
            <select id="in-type" class="input-field">
                <option value="×× ×•×£ 10 ××˜×¨">×× ×•×£ 10 ××˜×¨</option>
                <option value="×× ×•×£ 15 ××˜×¨">×× ×•×£ 15 ××˜×¨</option>
                <option value="××©××™×ª ×¨×’×™×œ×”">××©××™×ª ×¨×’×™×œ×”</option>
                <option value="××›×•×œ×” 8 ×§×•×‘">××›×•×œ×” 8 ×§×•×‘</option>
                <option value="××›×•×œ×” 24 ×§×•×‘">××›×•×œ×” 24 ×§×•×‘</option>
                <option value="××™×¡×•×£ ×¢×¦××™">××™×¡×•×£ ×¢×¦××™</option>
            </select>
            
            <div style="display:flex; gap:10px;">
                <input type="time" id="in-time-start" class="input-field">
                <input type="time" id="in-time-end" class="input-field">
            </div>

            <button onclick="saveNewOrder()" class="btn-action" style="background:var(--primary-color); padding:15px; font-size:1.1rem; justify-content:center;">
                <i class="material-icons">save</i> ×©××•×¨ ×‘××¢×¨×›×ª
            </button>
        </div>
    </div>

    <div id="modal-history" class="modal-overlay">
        <div class="modal-content" style="max-width:700px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0; color:#555;">××¨×›×™×•×Ÿ ×‘×™×¦×•×¢×™× ğŸ“œ</h2>
                <i class="material-icons" onclick="closeModal('modal-history')" style="cursor:pointer;">close</i>
            </div>
            <div style="overflow-y:auto; max-height:60vh;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>×œ×§×•×—</th>
                            <th>×›×ª×•×‘×ª</th>
                            <th>× ×”×’ ××‘×¦×¢</th>
                            <th>×©×¢×ª ×¡×™×•×</th>
                        </tr>
                    </thead>
                    <tbody id="history-rows">
                        </tbody>
                </table>
            </div>
            <div style="text-align:center; padding-top:10px; border-top:1px solid #eee;">
                <small>××¦×™×’ 50 ×”×–×× ×•×ª ××—×¨×•× ×•×ª</small>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script>
        // --- 1. ×”×’×“×¨×•×ª Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60",
            projectId: "app-saban94-57361",
            appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---
        let lastCount = 0;
        let allClientsSet = new Set(); // ×œ××•×˜×•-×§×•××¤×œ×™×˜
        let isInitialLoad = true;

        // --- 3. ×”××–× ×” ×¨××©×™×ª ×œ× ×ª×•× ×™× (Real-time) ---
        db.collection('users').orderBy('lastUpdate', 'desc').onSnapshot(snap => {
            const activeFeed = document.getElementById('active-feed');
            const futureFeed = document.getElementById('future-feed');
            const historyRows = document.getElementById('history-rows');
            
            // × ×™×§×•×™ ×ª×¦×•×’×”
            activeFeed.innerHTML = ''; 
            futureFeed.innerHTML = '';
            historyRows.innerHTML = '';

            let countDay = 0; // ××•× ×” 05-17
            let activeCount = 0;
            let futureCount = 0;
            let activeOrders = [];

            // ×¡××•× ×“ ×‘×”×–×× ×” ×—×“×©×”
            if (snap.size > lastCount && !isInitialLoad && lastCount !== 0) {
                document.getElementById('sound-new').play().catch(e => console.log("Audio play failed"));
            }
            lastCount = snap.size;
            isInitialLoad = false;

            // ××¢×‘×¨ ×¢×œ ×›×œ ×”××¡××›×™×
            snap.forEach(doc => {
                const d = doc.data(); 
                d.id = doc.id;
                
                // ××™×¡×•×£ ×©××•×ª ×œ-Autocomplete
                if (d.name) allClientsSet.add(d.name);

                // ××™×•×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡
                if (d.status === 4) {
                    // ×”×™×¡×˜×•×¨×™×” (×¡×•×¤×§)
                    renderHistoryRow(d, historyRows);
                } else {
                    // ×¤×¢×™×œ ××• ×¢×ª×™×“×™
                    const orderDate = d.lastUpdate ? d.lastUpdate.toDate() : new Date();
                    const isToday = isDateToday(orderDate);
                    
                    // ×—×™×©×•×‘ ××•× ×” ×™×•××™ (05:00-17:00)
                    const h = orderDate.getHours();
                    if (isToday && h >= 5 && h <= 17) countDay++;

                    if (isToday || d.status < 4) { // ×”×’×™×•×Ÿ ×¤×©×•×˜: ×× ×œ× ×¡×•×¤×§, ×–×” ×¤×¢×™×œ
                        activeCount++;
                        activeOrders.push(d);
                        renderCard(d, activeFeed);
                    } else {
                        futureCount++;
                        renderCard(d, futureFeed, true);
                    }
                }
            });

            // ×¢×“×›×•×Ÿ ××•× ×™×
            document.getElementById('m-0517').innerText = countDay;
            document.getElementById('m-active').innerText = activeCount;
            document.getElementById('active-count').innerText = activeCount;
            document.getElementById('future-count').innerText = futureCount;

            // ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×œ×§×•×—×•×ª ×œ×”×©×œ××” ××•×˜×•××˜×™×ª
            updateDataList();

            // ×¢×“×›×•×Ÿ ×‘×× ×¨ "×”×‘× ×‘×ª×•×¨"
            updateNextDeliveryBanner(activeOrders);
        });

        // --- 4. ×¤×•× ×§×¦×™×•×ª ×ª×¦×•×’×” (Rendering) ---

        function renderCard(d, container, isFuture = false) {
            const div = document.createElement('div');
            // ×–×™×”×•×™ ×¡×˜×˜×•×¡ ×œ×¦×‘×¢×™× (1=×—×“×©, 2=×‘×˜×™×¤×•×œ, 3=×‘×“×¨×š)
            const statusClass = d.status ? `status-${d.status}` : ''; 
            div.className = `order-card ${statusClass}`;
            
            // ×”××¨×” ×œ×ª××¨×™×š ×§×¨×™×
            const timeStr = d.lastUpdate ? new Date(d.lastUpdate.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
            const orgId = d.orgId || '---';

            div.innerHTML = `
                <div class="card-info">
                    <h4>${d.name}</h4>
                    <div class="card-details">
                        <span>ğŸ“ ${d.address || '×›×ª×•×‘×ª ×œ× ×¦×•×™× ×”'}</span>
                        <span>ğŸ“¦ #${orgId} | ${timeStr}</span>
                    </div>
                    <span class="tag crane">${d.deliveryType || '×›×œ×œ×™'}</span>
                </div>
                
                <div class="card-actions">
                    <input type="text" class="driver-input" 
                           placeholder="×©× × ×”×’ / ××¡×¤×¨ ××©××™×ª" 
                           value="${d.driverName || ''}" 
                           onchange="updateDriver('${d.id}', this.value)">
                    
                    ${d.status === 3 
                        ? `<button onclick="updateStatus('${d.id}', 4)" class="btn-action btn-done"><i class="material-icons">done_all</i> ×¡×•×¤×§</button>`
                        : `<select onchange="updateStatus('${d.id}', parseInt(this.value))" class="driver-input" style="border-color:#ccc;">
                             <option value="1" ${d.status==1?'selected':''}>ğŸ“¥ ×”×ª×§×‘×œ</option>
                             <option value="2" ${d.status==2?'selected':''}>âš™ï¸ ×‘×˜×™×¤×•×œ</option>
                             <option value="3" ${d.status==3?'selected':''}>ğŸšš ×™×¦× ×œ×“×¨×š</option>
                           </select>`
                    }
                </div>
            `;
            container.appendChild(div);
        }

        function renderHistoryRow(d, container) {
            const tr = document.createElement('tr');
            const timeStr = d.lastUpdate ? new Date(d.lastUpdate.toDate()).toLocaleString('he-IL') : '-';
            tr.innerHTML = `
                <td><strong>${d.name}</strong></td>
                <td>${d.address || ''}</td>
                <td>${d.driverName || '-'}</td>
                <td style="direction:ltr;">${timeStr}</td>
            `;
            container.appendChild(tr);
        }

        function updateNextDeliveryBanner(orders) {
            // ×œ×•×’×™×§×”: ××¦× ××ª ×”×”×–×× ×” ×”×¤×¢×™×œ×” ×”×›×™ ×•×•×ª×™×§×” ××• ×œ×¤×™ ×©×“×” ×©×¢×”
            // ×›××Ÿ × ×©×ª××© ×‘×”×–×× ×” ×”××—×¨×•× ×” ×‘×¨×©×™××” ×©×”×™× ×œ× ×‘×¡×˜×˜×•×¡ "×—×“×©" ×œ×’××¨×™, ××• ×”×¨××©×•× ×” ×‘×¨×©×™××”
            const banner = document.getElementById('priority-banner');
            
            // ×¡×™× ×•×Ÿ ×œ×”×–×× ×•×ª ×©×™×© ×œ×”×Ÿ ×™×¢×“ ××• ×©×¢×ª ×™×¢×“
            const priority = orders.filter(o => o.status !== 4); // ×›×œ ×”×¤×¢×™×œ×™×
            
            if (priority.length > 0) {
                // ×œ×•×§×—×™× ××ª ×”××—×¨×•×Ÿ ×©× ×›× ×¡ (××• ×”×¨××©×•×Ÿ ×‘×ª×•×¨, ×ª×œ×•×™ ×‘×œ×•×’×™×§×” ×”×¢×¡×§×™×ª ×©×œ×š)
                // ×›××Ÿ × × ×™×— ×©×”×›×™ ×“×—×•×£ ×”×•× ×–×” ×©× ××¦× ×‘×¡×˜×˜×•×¡ "×‘×“×¨×š" (3) ××• "×‘×˜×™×¤×•×œ" (2)
                let next = priority.find(o => o.status === 3) || priority[0];
                
                banner.style.display = 'flex';
                document.getElementById('next-cust-name').innerText = next.name;
                const time = next.lastUpdate ? new Date(next.lastUpdate.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
                document.getElementById('next-cust-time').innerText = time;
                document.getElementById('next-cust-details').innerText = `ğŸ“ ${next.address || ''} | ${next.deliveryType || ''}`;
            } else {
                banner.style.display = 'none';
            }
        }

        function updateDataList() {
            const list = document.getElementById('clients-list');
            list.innerHTML = '';
            allClientsSet.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                list.appendChild(opt);
            });
        }

        // --- 5. ×¤×¢×•×œ×•×ª (Actions) ---

        function saveNewOrder() {
            const name = document.getElementById('in-cust').value;
            if (!name) { alert('×—×•×‘×” ×œ×”×–×™×Ÿ ×©× ×œ×§×•×—'); return; }

            db.collection('users').add({
                name: name,
                orgId: document.getElementById('in-num').value,
                address: document.getElementById('in-addr').value,
                deliveryType: document.getElementById('in-type').value,
                status: 1, // 1 = ×—×“×©
                type: 'client',
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                // ×©××™×¨×ª ×”×™×¡×˜×•×¨×™×™×ª ×–×× ×™× ×× ×”×•×–× ×•
                deliveryStart: document.getElementById('in-time-start').value,
                deliveryEnd: document.getElementById('in-time-end').value
            }).then(() => {
                closeModal('modal-add');
                // ××™×¤×•×¡ ×©×“×•×ª
                document.getElementById('in-cust').value = '';
                document.getElementById('in-addr').value = '';
                document.getElementById('in-num').value = '';
            });
        }

        function updateDriver(id, driverName) {
            db.collection('users').doc(id).update({ driverName: driverName });
        }

        function updateStatus(id, status) {
            db.collection('users').doc(id).update({ 
                status: status,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // --- 6. ×¢×–×¨×™× (Utils) ---

        function isDateToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function openAddModal() { 
            document.getElementById('modal-add').style.display = 'flex'; 
            document.getElementById('in-cust').focus();
        }
        function toggleHistoryModal() { document.getElementById('modal-history').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // ×©×¢×•×Ÿ ×¨×¥
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // ×—×™×©×•×‘ ×–××Ÿ ××©×•×¢×¨ ×œ××¡×¤×§×” (×¡×ª× ×œ×¦×•×¨×š ×ª×¦×•×’×” - +×©×¢×” ××¢×›×©×™×•)
            const next = new Date(now.getTime() + 60*60*1000);
            document.getElementById('next-timer').innerText = next.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

    </script>
</body>
</html>
