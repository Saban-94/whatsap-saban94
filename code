const SS_ID = "146dXlaWJrYLcUiAhRCv3lCYrJuNDYGBOHkL86jgyvLI";
const DRIVE_FOLDER_ID = "1AWl10eAyTLOzNSp3LibtScDeH_SQKNZj";

function doPost(e) {
  try {
    const body = JSON.parse(e.postData.contents);
    let result;

    switch (body.action) {
      case 'getDashboardData': result = getDashboardData(body.clientId); break;
      case 'createOrderFromText': result = createOrderFromText(body.text, body.clientId, body.confirmed); break;
      case 'createFreeFormOrder': result = createFreeFormOrder(body.orderData, body.clientId); break;
      case 'uploadFile': result = uploadFile(body.payload); break;
      case 'updateClientAddress': result = updateClientAddress(body.clientId, body.lat, body.lon); break;
      case 'analyzeMessage': result = analyzeMessage(body.text, body.clientId); break;
      case 'diagnoseSystem': result = diagnoseSystem(body.clientId); break;
      case 'createMissingSheets': result = createMissingSheets(); break;
      case 'checkClientsSheet': result = checkClientsSheet(); break;
      case 'diagnoseClient': result = diagnoseClient(body.clientId); break;
      case 'generateOrderTemplate': result = generateOrderTemplate(body.orderData); break;
      default: throw new Error(`×¤×¢×•×œ×” ×œ× ××•×›×¨×ª: ${body.action}`);
    }
    
    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log(`Error in doPost: ${error.toString()}\nStacktrace: ${error.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ 
      success: false, 
      error: `×©×’×™××ª ×©×¨×ª: ${error.message}` 
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput("This script is running and responds to POST requests.");
}

// ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×’×™×œ×™×•× ×•×ª ×—×¡×¨×™×
function createMissingSheets() {
  try {
    const spreadsheet = SpreadsheetApp.openById(SS_ID);
    const results = [];
    
    // ×¨×©×™××ª ×”×’×™×œ×™×•× ×•×ª ×”× ×“×¨×©×™× ×•××‘× ×™×”×
    const requiredSheets = {
      "×œ×§×•×—×•×ª": [
        "××–×”×”_×œ×§×•×—", "×©×_××œ×", "×›×ª×•×‘×ª", "×˜×œ×¤×•×Ÿ", "×ª××•× ×ª_×¤×¨×•×¤×™×œ", "××™××™×™×œ", "×ª××¨×™×š ×”×¨×©××”"
      ],
      "×”×–×× ×•×ª ××›×•×œ×•×ª": [
        "××¡×¤×¨_×”×–×× ×”", "××¡×¤×¨ ×œ×§×•×—", "×©× ×œ×§×•×—", "×©× ×¤×¨×•×™×§×˜", "×’×•×“×œ", 
        "×ª××¨×™×š ×”×ª×—×œ×”", "×ª××¨×™×š ×¡×™×•×", "×¡×˜×˜×•×¡", "×›×ª×•×‘×ª", "lat", "lon"
      ],
      "×”×–×× ×•×ª ×—×•××¨×™ ×‘× ×™×Ÿ": [
        "×ª××¨×™×š ×§×œ×™×˜×”", "××¡×¤×¨ ×œ×§×•×—", "×©× ×œ×§×•×—", "×©× ×¤×¨×•×™×§×˜", "×¤×¨×˜×™ ××¡×¤×§×”",
        "×¤×¨×™×˜×™×", "×”×¢×¨×•×ª", "×¡×˜×˜×•×¡", "×›×ª×•×‘×ª", "× ×ª×•× ×™×_××œ××™×", "×§×™×©×•×¨_×”×–×× ×”"
      ],
      "×”×–×× ×•×ª ×× ×•×¤×™×": [
        "××¡×¤×¨_×”×–×× ×”", "××¡×¤×¨ ×œ×§×•×—", "×©× ×œ×§×•×—", "×©× ×¤×¨×•×™×§×˜", "×¡×•×’ ×× ×•×£",
        "××©×š ×”×©×›×¨×”", "×ª××¨×™×š ×”×ª×—×œ×”", "×ª××¨×™×š ×¡×™×•×", "×¡×˜×˜×•×¡", "×›×ª×•×‘×ª", "×”×¢×¨×•×ª"
      ],
      "×¤×¨×•×™×§×˜×™×": [
        "×©×_×¤×¨×•×™×§×˜", "×›×ª×•×‘×ª", "lat", "lon", "×œ×§×•×—"
      ],
      "×œ×•×’ ×”×–×× ×•×ª": [
        "×ª××¨×™×š", "××–×”×” ×”×–×× ×”", "××–×”×” ×œ×§×•×—", "××•×¦×¨", "×›××•×ª", "×¡×˜×˜×•×¡"
      ],
      "××•×¦×¨×™×": [
        "×©×_××•×¦×¨", "×§×˜×’×•×¨×™×”", "×›×™× ×•×™×™×", "××—×™×¨", "×™×—×™×“×ª_××™×“×”", "×–××™× ×•×ª", "×ª×™××•×¨"
      ]
    };
    
    for (const [sheetName, headers] of Object.entries(requiredSheets)) {
      let sheet = spreadsheet.getSheetByName(sheetName);
      if (!sheet) {
        sheet = spreadsheet.insertSheet(sheetName);
        sheet.appendRow(headers);
        results.push(`âœ… × ×•×¦×¨ ×’×™×œ×™×•×Ÿ: ${sheetName}`);
        Logger.log(`Created sheet: ${sheetName}`);
        
        // ×× ×–×” ×’×™×œ×™×•×Ÿ ××•×¦×¨×™×, × ×•×¡×™×£ × ×ª×•× ×™×
        if (sheetName === "××•×¦×¨×™×") {
          createProductsSheetIfMissing();
        }
      } else {
        results.push(`âœ… ×’×™×œ×™×•×Ÿ ×§×™×™×: ${sheetName}`);
      }
    }
    
    return {
      success: true,
      message: "×‘×“×™×§×ª ×’×™×œ×™×•× ×•×ª ×”×•×©×œ××”",
      results: results
    };
    
  } catch (error) {
    Logger.log(`Error creating sheets: ${error.toString()}`);
    return {
      success: false,
      error: `×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×œ×™×•× ×•×ª: ${error.message}`
    };
  }
}

function getSheetDataAsObjects(sheetName) {
    try {
        const sheet = SpreadsheetApp.openById(SS_ID).getSheetByName(sheetName);
        if (!sheet) {
            Logger.log(`Sheet "${sheetName}" not found.`);
            return [];
        }
        const data = sheet.getDataRange().getValues();
        if (data.length === 0) {
            Logger.log(`Sheet "${sheetName}" is empty.`);
            return [];
        }
        const headers = data[0];
        if (!headers || headers.length === 0) {
            Logger.log(`Sheet "${sheetName}" has no headers.`);
            return [];
        }
        
        // × ×™×§×•×™ ×©××•×ª ×”×¢××•×“×•×ª - ××¡×™×¨ ×¨×•×•×—×™× ××™×•×ª×¨×™×
        const cleanHeaders = headers.map(header => header.toString().trim());
        
        // ×”××¨×ª ×”×©×•×¨×•×ª ×œ××•×‘×™×™×§×˜×™× (××“×œ×’ ×¢×œ ×©×•×¨×ª ×”×›×•×ª×¨×•×ª)
        const result = [];
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            const obj = {};
            for (let j = 0; j < cleanHeaders.length; j++) {
                if (j < row.length) {
                    obj[cleanHeaders[j]] = row[j];
                } else {
                    obj[cleanHeaders[j]] = '';
                }
            }
            result.push(obj);
        }
        
        return result;
    } catch (error) {
        Logger.log(`Error in getSheetDataAsObjects for ${sheetName}: ${error}`);
        return [];
    }
}

function createProductsSheetIfMissing() {
  try {
    const spreadsheet = SpreadsheetApp.openById(SS_ID);
    let sheet = spreadsheet.getSheetByName("××•×¦×¨×™×");
    
    if (sheet && sheet.getLastRow() <= 1) {
      // ×’×™×œ×™×•×Ÿ ×§×™×™× ××‘×œ ×¨×™×§ - × ×•×¡×™×£ × ×ª×•× ×™×
      const sampleProducts = [
        ["××œ×˜ ××¤×•×¨", "×—×•××¨×™ ×’×œ×", "××œ×˜,×¦×× ×˜,×‘×˜×•×Ÿ,××œ×˜ ××¤×•×¨", 25, "×©×§", "×›×Ÿ", "××œ×˜ ××¤×•×¨ 25 ×§\"×’"],
        ["××œ×˜ ×œ×‘×Ÿ", "×—×•××¨×™ ×’×œ×", "××œ×˜ ×œ×‘×Ÿ,×¦×× ×˜ ×œ×‘×Ÿ", 35, "×©×§", "×›×Ÿ", "××œ×˜ ×œ×‘×Ÿ 25 ×§\"×’"],
        ["×—×•×œ", "×—×•××¨×™ ×’×œ×", "×—×•×œ,×—×•×œ ×œ×‘× ×™×™×Ÿ,×—×•×œ × ×”×¨", 15, "×˜×•×Ÿ", "×›×Ÿ", "×—×•×œ ×œ×‘× ×™×™×Ÿ"],
        ["×—×¦×¥", "×—×•××¨×™ ×’×œ×", "×—×¦×¥,××‘× ×™×,××’×¨×’×˜,×—×¦×¥ ×œ×‘× ×™×™×Ÿ", 20, "×˜×•×Ÿ", "×›×Ÿ", "×—×¦×¥ 0-4 ×\"×"],
        ["×‘×œ×•×§×™×", "×—×•××¨×™ ×‘× ×™×™×Ÿ", "×‘×œ×•×§,×‘×œ×•×§×™×,×œ×‘× ×™×,×œ×‘× ×”,×‘×œ×•×§ ×‘×˜×•×Ÿ", 8, "×™×—×™×“×”", "×›×Ÿ", "×‘×œ×•×§ 20x20x40"],
        ["×œ×‘× ×™×", "×—×•××¨×™ ×‘× ×™×™×Ÿ", "×œ×‘× ×”,×œ×‘× ×™×,××‘×Ÿ,×œ×‘× ×™ ×‘× ×™×™×Ÿ", 12, "×™×—×™×“×”", "×›×Ÿ", "×œ×‘× ×™× ××“×•××•×ª"],
        ["×¨×¢×¤×™×", "×—×•××¨×™ ×‘× ×™×™×Ÿ", "×¨×¢×£,×¨×¢×¤×™×,×’×’,×¨×¢×¤×™ ×’×’", 15, "×™×—×™×“×”", "×›×Ÿ", "×¨×¢×¤×™× ×¡×¤×¨×“×™×™×"],
        ["×—×•×œ ×œ××™×œ×•×™", "×—×•××¨×™ ×’×œ×", "×—×•×œ ××™×œ×•×™,×—×•×œ ×œ×™×¦×™×§×”,×—×•×œ ×¢×¤×¨", 12, "×˜×•×Ÿ", "×›×Ÿ", "×—×•×œ ×œ××™×œ×•×™ ×•×™×¦×™×§×”"],
        ["×—×¦×¥ ×œ× ×™×§×•×–", "×—×•××¨×™ ×’×œ×", "×—×¦×¥ × ×™×§×•×–,××‘× ×™ × ×™×§×•×–,×—×¦×¥ ×’×¡", 18, "×˜×•×Ÿ", "×›×Ÿ", "×—×¦×¥ 4-8 ×\"× ×œ× ×™×§×•×–"],
        ["×¨×©×ª ×‘× ×™×Ÿ", "×—×•××¨×™ ×‘× ×™×™×Ÿ", "×¨×©×ª,×¨×©×ª×•×ª,×¨×©×ª ×œ×‘× ×™×™×Ÿ,×¨×©×ª ×˜×™×—", 45, "×’×œ×™×œ", "×›×Ÿ", "×¨×©×ª ×‘× ×™×™×Ÿ 2x10 ××˜×¨"],
        ["×˜×™×—", "×—×•××¨×™ ×’××¨", "×˜×™×—,×˜×™×— ×¤× ×™×,×˜×™×— ×—×•×¥,×—×•××¨ ×˜×™×—", 30, "×©×§", "×›×Ÿ", "×˜×™×— ×¤× ×™×-×—×•×¥"],
        ["×¦×‘×¢", "×—×•××¨×™ ×’××¨", "×¦×‘×¢,×¦×‘×¢×™ ×‘× ×™×™×Ÿ,×¦×‘×¢ ×§×™×¨,×¦×‘×¢ ×—×•×¥", 40, "×§\"×’", "×›×Ÿ", "×¦×‘×¢ ××§×¨×™×œ×™ ×œ×‘×Ÿ"],
        ["××›×•×œ×” 6 ××˜×¨", "×©×›×™×¨×•×ª", "××›×•×œ×”,×§×•× ×˜×™×™× ×¨,××™×›×œ,××›×•×œ×” ×§×˜× ×”", 500, "×™×—×™×“×”", "×›×Ÿ", "××›×•×œ×” 6 ××˜×¨ ×œ×©×›×™×¨×•×ª"],
        ["××›×•×œ×” 12 ××˜×¨", "×©×›×™×¨×•×ª", "××›×•×œ×” ×’×“×•×œ×”,×§×•× ×˜×™×™× ×¨ ×’×“×•×œ,××›×•×œ×” 12", 800, "×™×—×™×“×”", "×›×Ÿ", "××›×•×œ×” 12 ××˜×¨ ×œ×©×›×™×¨×•×ª"],
        ["×× ×•×£ 25 ×˜×•×Ÿ", "×©×›×™×¨×•×ª", "×× ×•×£,×¢×’×•×¨×Ÿ,×× ×•×£ ×‘× ×™×™×Ÿ,×× ×•×£ 25", 1200, "×™×•×", "×›×Ÿ", "×× ×•×£ 25 ×˜×•×Ÿ ×œ×™×•× ×¢×‘×•×“×”"],
        ["×× ×•×£ 50 ×˜×•×Ÿ", "×©×›×™×¨×•×ª", "×× ×•×£ ×’×“×•×œ,×¢×’×•×¨×Ÿ ×’×“×•×œ,×× ×•×£ 50", 1800, "×™×•×", "×›×Ÿ", "×× ×•×£ 50 ×˜×•×Ÿ ×œ×™×•× ×¢×‘×•×“×”"]
      ];
      
      sampleProducts.forEach(product => sheet.appendRow(product));
      Logger.log('×’×™×œ×™×•×Ÿ ××•×¦×¨×™× ××•Ö¼×©×¨ ×¢× ' + sampleProducts.length + ' ××•×¦×¨×™×');
    }
    
    return sheet;
  } catch (error) {
    Logger.log('×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×œ×™×•×Ÿ ××•×¦×¨×™×: ' + error);
    return null;
  }
}

function getDashboardData(clientId) {
    try {
        // ×™×¦×™×¨×ª ×’×™×œ×™×•× ×•×ª ×—×¡×¨×™× ×× ×¦×¨×™×š
        createMissingSheets();
        
        const clients = getSheetDataAsObjects("×œ×§×•×—×•×ª");
        Logger.log(`× ××¦××• ${clients.length} ×œ×§×•×—×•×ª ×‘××¢×¨×›×ª`);
        
        // ×—×™×¤×•×© ×’××™×© ×™×•×ª×¨ ×©×œ ×”×œ×§×•×—
        const clientData = clients.find(c => {
          const clientIdStr = clientId.toString().trim();
          const possibleIds = [
            c['××–×”×”_×œ×§×•×—'] ? c['××–×”×”_×œ×§×•×—'].toString().trim() : '',
            c['××¡×¤×¨ ×œ×§×•×—'] ? c['××¡×¤×¨ ×œ×§×•×—'].toString().trim() : '',
            c['××–×”×” ×œ×§×•×—'] ? c['××–×”×” ×œ×§×•×—'].toString().trim() : '',
            c['id'] ? c['id'].toString().trim() : '',
            c['clientId'] ? c['clientId'].toString().trim() : ''
          ];
          
          return possibleIds.some(id => id === clientIdStr);
        });
        
        if (!clientData) {
          const availableIds = clients.map(c => 
            c['××–×”×”_×œ×§×•×—'] || c['××¡×¤×¨ ×œ×§×•×—'] || c['××–×”×” ×œ×§×•×—'] || c['id'] || '×œ×œ× ××–×”×”'
          ).join(', ');
          
          Logger.log(`×œ×§×•×— ${clientId} ×œ× × ××¦×. ××–×”×”×™× ×–××™× ×™×: ${availableIds}`);
          return { 
            success: false, 
            error: "×œ×§×•×— ×œ× × ××¦×. ×× × ×‘×“×•×§ ××ª ××¡×¤×¨ ×”×œ×§×•×—." 
          };
        }

        Logger.log("×œ×§×•×— × ××¦×: " + JSON.stringify(clientData));

        // ××¦×™××ª ×©× ×”×œ×§×•×— - ××•×ª×× ×œ××‘× ×” ×”×’×™×œ×™×•×Ÿ ×”×¡×¤×¦×™×¤×™
        const clientName = clientData['×©×_××œ×'] || clientData['×©×_×œ×§×•×—'] || clientData['×©× ×œ×§×•×—'] || 
                          clientData['name'] || clientData['×©×'] || '×œ×§×•×—';
        
        const clientAvatar = clientData['×ª××•× ×ª_×¤×¨×•×¤×™×œ'] || clientData['×ª××•× ×ª ×¤×¨×•×¤×™×œ'] || 
                           clientData['avatar'] || 'https://i.postimg.cc/rsxW32Jj/logo.png';

        Logger.log(`ğŸ“ ×©× ×œ×§×•×— ×©× ××¦× ×¢×‘×•×¨ Dashboard: "${clientName}"`);

        const allProjects = getSheetDataAsObjects("×¤×¨×•×™×§×˜×™×");

        // ×—×™×¤×•×© ×”×–×× ×•×ª ××›×•×œ×•×ª
        const containersData = getSheetDataAsObjects("×”×–×× ×•×ª ××›×•×œ×•×ª");
        const containers = containersData
            .filter(o => {
              const orderClientId = o['××¡×¤×¨ ×œ×§×•×—'] || o['××–×”×”_×œ×§×•×—'] || o['××–×”×” ×œ×§×•×—'];
              return orderClientId && orderClientId.toString().trim() === clientId.toString().trim() && 
                     o.×¡×˜×˜×•×¡ !== '×¡×’×•×¨' && o.×¡×˜×˜×•×¡ !== '×”×•×©×œ×';
            })
            .map(o => {
                const projectName = o['×©× ×¤×¨×•×™×§×˜'] || o['×›×ª×•×‘×ª'] || '×¤×¨×•×™×§×˜ ×›×œ×œ×™';
                const project = allProjects.find(p => p['×©×_×¤×¨×•×™×§×˜'] === projectName);
                return { 
                    type: 'container',
                    id: o['××¡×¤×¨_×”×–×× ×”'] || o['××¡×¤×¨ ×”×–×× ×”'] || `C${Date.now()}`,
                    project: projectName, 
                    status: o.×¡×˜×˜×•×¡ || '×¤×¢×™×œ', 
                    items: `××›×•×œ×” ${o['×’×•×“×œ'] || o['×¡×•×’'] || ''}`.trim(),
                    startDate: o['×ª××¨×™×š ×”×ª×—×œ×”'] || o['×ª××¨×™×š_×”×ª×—×œ×”'] || new Date(),
                    address: project ? project.×›×ª×•×‘×ª : (o.×›×ª×•×‘×ª || '×œ× ×¦×•×™× ×”'),
                    lat: project ? project.lat : (o.lat || null),
                    lon: project ? project.lon : (o.lon || null)
                };
            });

        // ×—×™×¤×•×© ×”×–×× ×•×ª ×—×•××¨×™ ×‘× ×™×™×Ÿ
        const materialsData = getSheetDataAsObjects("×”×–×× ×•×ª ×—×•××¨×™ ×‘× ×™×Ÿ");
        const materials = materialsData
            .filter(o => {
              const orderClientId = o['××¡×¤×¨ ×œ×§×•×—'] || o['××–×”×”_×œ×§×•×—'] || o['××–×”×” ×œ×§×•×—'];
              return orderClientId && orderClientId.toString().trim() === clientId.toString().trim() && 
                     o.×¡×˜×˜×•×¡ !== '×¡×’×•×¨' && o.×¡×˜×˜×•×¡ !== '×”×•×©×œ×';
            })
            .map(o => ({ 
                type: 'material',
                id: o['××¡×¤×¨_×”×–×× ×”'] || o['××¡×¤×¨ ×”×–×× ×”'] || `M${Date.now()}`,
                project: o['×©× ×¤×¨×•×™×§×˜'] || '×¤×¨×•×™×§×˜ ×›×œ×œ×™', 
                status: o.×¡×˜×˜×•×¡ || '×—×“×©×”', 
                items: o['×¤×¨×™×˜×™×'] || o['××•×¦×¨×™×'] || '×œ× ×¦×•×™×Ÿ',
                address: o['×›×ª×•×‘×ª'] || '×œ× ×¦×•×™× ×”'
            }));

        // ×—×™×¤×•×© ×”×–×× ×•×ª ×× ×•×¤×™×
        let cranes = [];
        try {
            const cranesData = getSheetDataAsObjects("×”×–×× ×•×ª ×× ×•×¤×™×");
            cranes = cranesData
                .filter(o => {
                  const orderClientId = o['××¡×¤×¨ ×œ×§×•×—'] || o['××–×”×”_×œ×§×•×—'] || o['××–×”×” ×œ×§×•×—'];
                  return orderClientId && orderClientId.toString().trim() === clientId.toString().trim() && 
                         o.×¡×˜×˜×•×¡ !== '×¡×’×•×¨' && o.×¡×˜×˜×•×¡ !== '×”×•×©×œ×';
                })
                .map(o => ({
                    type: 'crane',
                    id: o['××¡×¤×¨_×”×–×× ×”'] || o['××¡×¤×¨ ×”×–×× ×”'] || `CR${Date.now()}`,
                    project: o['×©× ×¤×¨×•×™×§×˜'] || '×¤×¨×•×™×§×˜ ×›×œ×œ×™',
                    status: o.×¡×˜×˜×•×¡ || '×—×“×©×”',
                    items: `×× ×•×£ ${o['×¡×•×’ ×× ×•×£'] || ''} - ${o['××©×š ×”×©×›×¨×”'] || ''}`.trim(),
                    address: o['×›×ª×•×‘×ª'] || '×œ× ×¦×•×™× ×”'
                }));
        } catch (e) {
            Logger.log('×’×™×œ×™×•×Ÿ ×× ×•×¤×™× ×œ× × ××¦×: ' + e.toString());
        }
        
        const allOrders = [...containers, ...materials, ...cranes];
        const stats = calculateOrderStats(allOrders);

        return { 
            success: true, 
            data: { 
                client: { 
                    id: clientData['××–×”×”_×œ×§×•×—'] || clientData['××¡×¤×¨ ×œ×§×•×—'] || 
                         clientData['××–×”×” ×œ×§×•×—'] || clientData['id'] || clientId,
                    name: clientName,
                    avatar: clientAvatar
                },
                dashboard: { 
                    orders: allOrders,
                    stats: stats,
                    lastUpdated: new Date().toISOString()
                }
            } 
        };
        
    } catch (error) {
        Logger.log('×©×’×™××” ×‘-getDashboardData: ' + error.toString());
        return { 
            success: false, 
            error: '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + error.message 
        };
    }
}

/**
 * ×× ×ª×— ×”×•×“×¢×ª ×˜×§×¡×˜ ×•××–×”×” ×›×•×•× ×•×ª ×œ×”×–×× ×”
 */
function analyzeMessage(text, clientId) {
  try {
    var analysisResult = parseHebrewText(text);
    
    if (analysisResult.success) {
      return {
        success: true,
        data: {
          orderPreview: {
            product: analysisResult.product,
            quantity: analysisResult.quantity,
            unit: analysisResult.unit,
            estimatedPrice: analysisResult.estimatedPrice,
            confidence: analysisResult.confidence
          }
        }
      };
    } else {
      return {
        success: true,
        data: {
          message: getDefaultResponse(text)
        }
      };
    }
    
  } catch (error) {
    Logger.log('Error in analyzeMessage: ' + error.toString());
    return {
      success: false,
      error: '×©×’×™××” ×‘× ×™×ª×•×— ×”×”×•×“×¢×”: ' + error.toString()
    };
  }
}

/**
 * ×× ×ª×— ×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª ×›×“×™ ×œ×—×œ×¥ ×¤×¨×˜×™ ×”×–×× ×” - ×’×¨×¡×” ××©×•×¤×¨×ª ×¢× ×’×™×œ×™×•×Ÿ ××•×¦×¨×™×
 */
function parseHebrewText(text) {
  try {
    var lowerText = text.toLowerCase().trim();
    Logger.log(`ğŸ” ×× ×ª×— ×˜×§×¡×˜: "${text}"`);
    
    // ×™×¦×™×¨×ª ×’×™×œ×™×•×Ÿ ××•×¦×¨×™× ×× ×—×¡×¨
    createProductsSheetIfMissing();
    
    // ×˜×¢×™× ×ª ××•×¦×¨×™× ××”×’×™×œ×™×•×Ÿ
    const products = getSheetDataAsObjects("××•×¦×¨×™×");
    Logger.log(`ğŸ“¦ × ××¦××• ${products.length} ××•×¦×¨×™× ×‘××¢×¨×›×ª`);
    
    // ×—×™×œ×•×¥ ×›××•×ª
    var quantity = 1;
    var quantityMatch = lowerText.match(/(\d+)\s*(×©×§|×§"×’|×§×™×œ×•|×˜×•×Ÿ|×™×—×™×“×”|×™×—×™×“×•×ª|××˜×¨|×"×¨|×™×•×|×™××™×|×’×œ×™×œ|×§×•×¤×¡×”|×—×‘×™×œ×”)/);
    if (quantityMatch) {
      quantity = parseInt(quantityMatch[1]);
      Logger.log(`ğŸ”¢ × ××¦××” ×›××•×ª: ${quantity} ${quantityMatch[2]}`);
    } else {
      // × ×¡×™×•×Ÿ × ×•×¡×£ ×œ×—×™×œ×•×¥ ××¡×¤×¨×™×
      var simpleQuantityMatch = lowerText.match(/\d+/);
      if (simpleQuantityMatch) {
        quantity = parseInt(simpleQuantityMatch[0]);
        Logger.log(`ğŸ”¢ × ××¦××” ×›××•×ª ××”×˜×§×¡×˜: ${quantity}`);
      }
    }
    
    // ×—×™×œ×•×¥ ×™×—×™×“×”
    var unit = '×™×—×™×“×”';
    var unitMatches = [
      { pattern: ['×©×§', '×©×§×™×'], unit: '×©×§×™×' },
      { pattern: ['×§"×’', '×§×™×œ×•', '×§×™×œ×•×’×¨×'], unit: '×§"×’' },
      { pattern: ['×˜×•×Ÿ', '×˜×•× ×•×ª'], unit: '×˜×•×Ÿ' },
      { pattern: ['××˜×¨', '×"×¨', '××˜×¨ ×¨×‘×•×¢'], unit: '×"×¨' },
      { pattern: ['×™×•×', '×™××™×'], unit: '×™××™×' },
      { pattern: ['×’×œ×™×œ', '×’×œ×™×œ×™×'], unit: '×’×œ×™×œ' },
      { pattern: ['×™×—×™×“×”', '×™×—×™×“×•×ª'], unit: '×™×—×™×“×”' }
    ];
    
    for (let match of unitMatches) {
      if (match.pattern.some(pattern => lowerText.includes(pattern))) {
        unit = match.unit;
        Logger.log(`ğŸ“ × ××¦××” ×™×—×™×“×”: ${unit}`);
        break;
      }
    }
    
    // ×—×™×¤×•×© ××•×¦×¨ ×‘×˜×§×¡×˜ - ×‘×××¦×¢×•×ª ×’×™×œ×™×•×Ÿ ×”××•×¦×¨×™×
    var foundProduct = null;
    var confidence = 0;
    var matchedKeyword = '';
    
    for (var i = 0; i < products.length; i++) {
      var product = products[i];
      var productName = product['×©×_××•×¦×¨'];
      var aliases = product['×›×™× ×•×™×™×'] ? product['×›×™× ×•×™×™×'].split(',') : [];
      
      // ×—×™×¤×•×© ×œ×¤×™ ×©× ××•×¦×¨ ××œ×
      if (productName && lowerText.includes(productName.toLowerCase())) {
        foundProduct = {
          name: productName,
          price: Number(product['××—×™×¨']) || 0,
          unit: product['×™×—×™×“×ª_××™×“×”'] || unit,
          category: product['×§×˜×’×•×¨×™×”'] || ''
        };
        confidence = 0.9;
        matchedKeyword = productName;
        Logger.log(`âœ… × ××¦× ××•×¦×¨ ×‘×©× ××œ×: ${productName}`);
        break;
      }
      
      // ×—×™×¤×•×© ×œ×¤×™ ×›×™× ×•×™×™×
      for (var j = 0; j < aliases.length; j++) {
        var alias = aliases[j].trim().toLowerCase();
        if (alias && lowerText.includes(alias)) {
          foundProduct = {
            name: productName,
            price: Number(product['××—×™×¨']) || 0,
            unit: product['×™×—×™×“×ª_××™×“×”'] || unit,
            category: product['×§×˜×’×•×¨×™×”'] || ''
          };
          confidence = 0.8;
          matchedKeyword = alias;
          Logger.log(`âœ… × ××¦× ××•×¦×¨ ×‘×›×™× ×•×™: ${alias} -> ${productName}`);
          break;
        }
      }
      if (foundProduct) break;
    }
    
    // ×× ×œ× × ××¦×, × × ×¡×” ×—×™×¤×•×© ×—×œ×§×™ ×¢× ××™×œ×™× ×‘×•×“×“×•×ª
    if (!foundProduct) {
      var words = lowerText.split(/\s+/).filter(word => word.length > 2);
      Logger.log(`ğŸ” ××—×¤×© ×œ×¤×™ ××™×œ×™×: ${words.join(', ')}`);
      
      for (var i = 0; i < words.length; i++) {
        var word = words[i];
        for (var j = 0; j < products.length; j++) {
          var product = products[j];
          var productName = product['×©×_××•×¦×¨'];
          var aliases = product['×›×™× ×•×™×™×'] ? product['×›×™× ×•×™×™×'].split(',') : [];
          
          // ×—×™×¤×•×© ×—×œ×§×™ ×‘×©× ×”××•×¦×¨
          if (productName && productName.toLowerCase().includes(word)) {
            foundProduct = {
              name: productName,
              price: Number(product['××—×™×¨']) || 0,
              unit: product['×™×—×™×“×ª_××™×“×”'] || unit,
              category: product['×§×˜×’×•×¨×™×”'] || ''
            };
            confidence = 0.6;
            matchedKeyword = word;
            Logger.log(`âœ… × ××¦× ××•×¦×¨ ×‘×—×™×¤×•×© ×—×œ×§×™: ${word} -> ${productName}`);
            break;
          }
          
          // ×—×™×¤×•×© ×—×œ×§×™ ×‘×›×™× ×•×™×™×
          for (var k = 0; k < aliases.length; k++) {
            var alias = aliases[k].trim().toLowerCase();
            if (alias && alias.includes(word)) {
              foundProduct = {
                name: productName,
                price: Number(product['××—×™×¨']) || 0,
                unit: product['×™×—×™×“×ª_××™×“×”'] || unit,
                category: product['×§×˜×’×•×¨×™×”'] || ''
              };
              confidence = 0.5;
              matchedKeyword = word;
              Logger.log(`âœ… × ××¦× ××•×¦×¨ ×‘×›×™× ×•×™ ×—×œ×§×™: ${word} -> ${productName}`);
              break;
            }
          }
          if (foundProduct) break;
        }
        if (foundProduct) break;
      }
    }
    
    if (foundProduct) {
      var estimatedPrice = quantity * foundProduct.price;
      Logger.log(`ğŸ’° ××—×™×¨ ××©×•×¢×¨: ${quantity} Ã— ${foundProduct.price} = ${estimatedPrice} ×©"×—`);
      
      return {
        success: true,
        product: foundProduct.name,
        quantity: quantity,
        unit: unit,
        estimatedPrice: estimatedPrice,
        confidence: confidence,
        category: foundProduct.category,
        matchedKeyword: matchedKeyword
      };
    }
    
    Logger.log('âŒ ×œ× × ××¦× ××•×¦×¨ ××ª××™× ×‘×˜×§×¡×˜');
    return { 
      success: false,
      details: '×œ× ×”×¦×œ×—×ª×™ ×œ×–×”×•×ª ××•×¦×¨ ×‘×”×–×× ×”. × ×¡×” ×œ×¤×¨×˜ ×™×•×ª×¨ ×›××• "××œ×˜ ××¤×•×¨ 3 ×©×§×™×" ××• "×‘×œ×•×§×™× 20 ×™×—×™×“×•×ª"'
    };
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘-parseHebrewText: ' + error.toString());
    return { 
      success: false,
      details: '×©×’×™××” ×‘× ×™×ª×•×— ×”×˜×§×¡×˜: ' + error.message
    };
  }
}

/**
 * ××—×–×™×¨ ×ª×©×•×‘×” ××ª××™××” ×œ×¤×™ ×”×˜×§×¡×˜
 */
function getDefaultResponse(text) {
  var lowerText = text.toLowerCase();
  
  if (lowerText.includes('×©×œ×•×') || lowerText.includes('×”×™×™') || lowerText.includes('×‘×•×§×¨') || lowerText.includes('×¢×¨×‘')) {
    return '×©×œ×•×! ××™×š ××•×›×œ ×œ×¢×–×•×¨ ×œ×š ×”×™×•×?';
  } else if (lowerText.includes('×ª×•×“×”') || lowerText.includes('×ª×•×“×”×¨×‘×”')) {
    return '×‘×›×™×£! ×™×© ×¢×•×“ ××©×”×• ×©××ª×” ×¦×¨×™×š?';
  } else if (lowerText.includes('××ª×™') || lowerText.includes('××ª×™ ×ª×’×™×¢')) {
    return '××¤×©×¨ ×œ×¢×§×•×‘ ××—×¨×™ ×”×”×–×× ×” ×©×œ×š ×‘×“×©×‘×•×¨×“. ×¨×•×¦×” ×©×× ×™ ××¢×‘×™×¨ ××•×ª×š ×œ×©×?';
  } else if (lowerText.includes('××›×•×œ×”') || lowerText.includes('×§×•× ×˜×™×™× ×¨')) {
    return '××©××— ×œ×¢×–×•×¨ ×¢× ×”×–×× ×ª ××›×•×œ×”. ×ª×•×›×œ ×œ×¤×¨×˜ ××ª ×”×’×•×“×œ ×•×”××™×§×•×?';
  } else if (lowerText.includes('×× ×•×£') || lowerText.includes('×¢×’×•×¨×Ÿ')) {
    return '××©××— ×œ×¢×–×•×¨ ×¢× ×”×–×× ×ª ×× ×•×£. ×ª×•×›×œ ×œ×¤×¨×˜ ××ª ×¡×•×’ ×”×× ×•×£ ×•××©×š ×”×”×©×›×¨×”?';
  } else {
    return '××©××— ×œ×¢×–×•×¨! ××ª×” ×™×›×•×œ ×œ×‘×§×© ×”×–×× ×ª ×—×•××¨×™× (×›××• "××œ×˜ ××¤×•×¨ 3 ×©×§×™×"), ××›×•×œ×” ××• ×× ×•×£.';
  }
}

/**
 * ×™×•×¦×¨ ×”×–×× ×” ×—×“×©×” ××˜×§×¡×˜ - ×¢× ×ª×™×§×•×Ÿ ×©× ×œ×§×•×—
 */
function createOrderFromText(text, clientId, confirmed = false) {
  try {
    Logger.log(`ğŸ¯ ×× ×¡×” ×œ×™×¦×•×¨ ×”×–×× ×” ×¢×‘×•×¨ ×œ×§×•×—: ${clientId}, ×˜×§×¡×˜: "${text}"`);
    
    // ×—×™×¤×•×© ×œ×§×•×— ×¢× ×œ×•×’×™× ××¤×•×¨×˜×™×
    const clients = getSheetDataAsObjects("×œ×§×•×—×•×ª");
    Logger.log(`× ××¦××• ${clients.length} ×œ×§×•×—×•×ª ×‘××¢×¨×›×ª`);
    
    const clientData = clients.find(c => {
      const clientIdStr = clientId.toString().trim();
      const possibleIds = [
        c['××–×”×”_×œ×§×•×—'] ? c['××–×”×”_×œ×§×•×—'].toString().trim() : '',
        c['××¡×¤×¨ ×œ×§×•×—'] ? c['××¡×¤×¨ ×œ×§×•×—'].toString().trim() : '',
        c['××–×”×” ×œ×§×•×—'] ? c['××–×”×” ×œ×§×•×—'].toString().trim() : ''
      ];
      
      const found = possibleIds.some(id => id === clientIdStr);
      if (found) {
        Logger.log(`âœ… × ××¦× ×œ×§×•×—: ${JSON.stringify(c)}`);
      }
      return found;
    });
    
    if (!clientData) {
      const availableIds = clients.map(c => 
        c['××–×”×”_×œ×§×•×—'] || c['××¡×¤×¨ ×œ×§×•×—'] || c['××–×”×” ×œ×§×•×—'] || '×œ×œ× ××–×”×”'
      ).join(', ');
      
      Logger.log(`âŒ ×œ×§×•×— ${clientId} ×œ× × ××¦×. ××–×”×”×™× ×–××™× ×™×: ${availableIds}`);
      return { 
        success: false, 
        error: "×œ×§×•×— ×œ× × ××¦×. ×× × ×‘×“×•×§ ××ª ××¡×¤×¨ ×”×œ×§×•×—." 
      };
    }

    // ××¦×™××ª ×©× ×”×œ×§×•×— - ×©×™××•×© ×‘×©×_××œ× ×›×¤×™ ×©××•×¤×™×¢ ×‘×’×™×œ×™×•×Ÿ
    const clientName = clientData['×©×_××œ×'] || clientData['×©×_×œ×§×•×—'] || clientData['×©× ×œ×§×•×—'] || '×œ×§×•×—';
    
    Logger.log(`ğŸ“ ×©× ×œ×§×•×— ×©× ××¦×: "${clientName}"`);

    // ×× ×–×• ×¨×§ ×‘×§×©×” ×œ× ×™×ª×•×— (×œ×œ× ××™×©×•×¨), × ×—×–×™×¨ ×ª×¦×•×’×” ××§×“×™××”
    if (!confirmed) {
      var analysis = parseHebrewText(text);
      if (analysis.success) {
        Logger.log(`âœ… × ×™×ª×•×— ×”×¦×œ×—×”: ${analysis.product} ${analysis.quantity} ${analysis.unit}`);
        return {
          success: true,
          data: {
            orderPreview: {
              product: analysis.product,
              quantity: analysis.quantity,
              unit: analysis.unit,
              estimatedPrice: analysis.estimatedPrice,
              category: analysis.category
            }
          }
        };
      } else {
        Logger.log(`âŒ × ×™×ª×•×— × ×›×©×œ: ${analysis.details}`);
        return {
          success: false,
          error: analysis.details || "×œ× ×”×¦×œ×—×ª×™ ×œ×–×”×•×ª ×”×–×× ×” ×‘×˜×§×¡×˜ ×©×©×œ×—×ª. × ×¡×” ×©×•×‘ ×¢× ×¤×™×¨×•×˜ ××œ× ×™×•×ª×¨."
        };
      }
    }

    // ×× ×××•×©×¨ - × ×™×¦×•×¨ ××ª ×”×”×–×× ×” ×‘×¤×•×¢×œ
    var analysis = parseHebrewText(text);
    if (!analysis.success) {
      return {
        success: false,
        error: analysis.details || "×œ× ×”×¦×œ×—×ª×™ ×œ×¢×‘×“ ××ª ×”×”×–×× ×”. × ×¡×” ×©×•×‘."
      };
    }

    // ×§×‘×™×¢×ª ×¡×•×’ ×”×’×™×œ×™×•×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×™×ª ×”××•×¦×¨
    var sheetName, orderData;
    var productCategory = analysis.category || '';
    
    if (productCategory.includes('×©×›×™×¨×•×ª') || analysis.product.includes('××›×•×œ×”') || analysis.product.includes('×× ×•×£')) {
      if (analysis.product.includes('××›×•×œ×”')) {
        sheetName = "×”×–×× ×•×ª ××›×•×œ×•×ª";
        orderData = [
          `TXT-C-${Date.now()}`,
          clientId,
          clientName, // ×©×™××•×© ×‘×©× ×”×œ×§×•×— ×©× ××¦×
          '×”×–×× ×” ××”×¦××˜',
          `${analysis.quantity} ${analysis.unit}`,
          new Date(),
          '',
          '×—×“×©×”',
          clientData['×›×ª×•×‘×ª'] || '',
          '',
          '',
          text
        ];
      } else if (analysis.product.includes('×× ×•×£')) {
        sheetName = "×”×–×× ×•×ª ×× ×•×¤×™×";
        orderData = [
          `TXT-CR-${Date.now()}`,
          clientId,
          clientName, // ×©×™××•×© ×‘×©× ×”×œ×§×•×— ×©× ××¦×
          '×”×–×× ×” ××”×¦××˜',
          analysis.product,
          `${analysis.quantity} ${analysis.unit}`,
          new Date(),
          '',
          '×—×“×©×”',
          clientData['×›×ª×•×‘×ª'] || '',
          text
        ];
      }
    } else {
      // ×”×–×× ×ª ×—×•××¨×™ ×‘× ×™×™×Ÿ ×¨×’×™×œ×”
      sheetName = "×”×–×× ×•×ª ×—×•××¨×™ ×‘× ×™×Ÿ";
      orderData = [
        new Date(),
        clientId,
        clientName, // ×©×™××•×© ×‘×©× ×”×œ×§×•×— ×©× ××¦×
        '×”×–×× ×” ××”×¦××˜',
        '××¡×¤×§×” ×œ×¤×™ ×”×–×× ×”',
        `${analysis.quantity} ${analysis.unit} ${analysis.product}`,
        `××—×™×¨ ××©×•×¢×¨: ${analysis.estimatedPrice} ×©"×— | ×§×˜×’×•×¨×™×”: ${analysis.category}`,
        '×—×“×©×”',
        clientData['×›×ª×•×‘×ª'] || '',
        text
      ];
    }

    // ×™×¦×™×¨×ª ×”×”×–×× ×”
    const sheet = SpreadsheetApp.openById(SS_ID).getSheetByName(sheetName);
    if (!sheet) {
      return {
        success: false,
        error: `×’×™×œ×™×•×Ÿ ${sheetName} ×œ× × ××¦×`
      };
    }
    
    sheet.appendRow(orderData);
    
    const orderId = sheet.getLastRow();
    const fullOrderId = `${sheetName === "×”×–×× ×•×ª ××›×•×œ×•×ª" ? "CONT" : sheetName === "×”×–×× ×•×ª ×× ×•×¤×™×" ? "CRANE" : "MAT"}-${orderId}`;
    
    // ×¨×™×©×•× ×‘×œ×•×’
    logOrderCreation(fullOrderId, clientId, analysis.product, analysis.quantity);
    
    Logger.log(`âœ… ×”×–×× ×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”: ${fullOrderId} - ${analysis.product} ${analysis.quantity} ${analysis.unit}`);
    
    return { 
      success: true, 
      data: { 
        orderId: fullOrderId,
        product: analysis.product,
        quantity: analysis.quantity,
        unit: analysis.unit,
        estimatedPrice: analysis.estimatedPrice,
        clientName: clientName,
        category: analysis.category
      } 
    };
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘-createOrderFromText: ' + error.toString());
    return {
      success: false,
      error: '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×”×–×× ×”: ' + error.toString()
    };
  }
}

/**
 * ×™×•×¦×¨ ×”×–×× ×” ×—×•×¤×©×™×ª ×¢× ×ª×‘× ×™×ª ××¢×•×¦×‘×ª
 */
function createFreeFormOrder(orderData, clientId) {
  try {
    Logger.log(`ğŸ¯ ×™×¦×™×¨×ª ×”×–×× ×” ×—×•×¤×©×™×ª ×¢×‘×•×¨ ×œ×§×•×—: ${clientId}`);
    
    // ×©×œ×™×¤×ª × ×ª×•× ×™ ×”×œ×§×•×—
    const clients = getSheetDataAsObjects("×œ×§×•×—×•×ª");
    const clientData = clients.find(c => {
      const clientIdStr = clientId.toString().trim();
      const possibleIds = [
        c['××–×”×”_×œ×§×•×—'] ? c['××–×”×”_×œ×§×•×—'].toString().trim() : '',
        c['××¡×¤×¨ ×œ×§×•×—'] ? c['××¡×¤×¨ ×œ×§×•×—'].toString().trim() : '',
        c['××–×”×” ×œ×§×•×—'] ? c['××–×”×” ×œ×§×•×—'].toString().trim() : ''
      ];
      return possibleIds.some(id => id === clientIdStr);
    });
    
    if (!clientData) {
      return { success: false, error: "×œ×§×•×— ×œ× × ××¦×" };
    }

    // ×™×¦×™×¨×ª ××–×”×” ×”×–×× ×”
    const orderId = `FREE-${Date.now()}`;
    
    // ×©××™×¨×ª ×”×”×–×× ×” ×‘×’×™×œ×™×•×Ÿ ×”×”×–×× ×•×ª
    const ordersSheet = SpreadsheetApp.openById(SS_ID).getSheetByName("×”×–×× ×•×ª ×—×•××¨×™ ×‘× ×™×Ÿ");
    const orderRow = [
      new Date(), // ×ª××¨×™×š ×§×œ×™×˜×”
      clientId, // ××¡×¤×¨ ×œ×§×•×—
      clientData['×©×_××œ×'] || clientData['×©×_×œ×§×•×—'] || '×œ×§×•×—', // ×©× ×œ×§×•×—
      orderData.projectName || '×”×–×× ×” ×›×œ×œ×™×ª', // ×©× ×¤×¨×•×™×§×˜
      orderData.deliveryDetails || '××¡×¤×§×” ×œ×¤×™ ×”×–×× ×”', // ×¤×¨×˜×™ ××¡×¤×§×”
      orderData.products, // ×¤×¨×™×˜×™×
      orderData.notes || '××™×Ÿ ×”×¢×¨×•×ª', // ×”×¢×¨×•×ª
      '×××•×©×¨', // ×¡×˜×˜×•×¡
      orderData.deliveryAddress || clientData['×›×ª×•×‘×ª'] || '', // ×›×ª×•×‘×ª
      JSON.stringify(orderData), // × ×ª×•× ×™× ××œ××™×
      '' // ×§×™×©×•×¨_×”×–×× ×” (×™×™××•×œ× ×œ××—×¨ ××›×Ÿ)
    ];
    
    ordersSheet.appendRow(orderRow);
    
    // ×™×¦×™×¨×ª ×ª×‘× ×™×ª ××¢×•×¦×‘×ª
    const orderTemplate = generateOrderTemplate({
      ...orderData,
      orderId: orderId,
      clientName: clientData['×©×_××œ×'] || clientData['×©×_×œ×§×•×—'] || '×œ×§×•×—',
      clientPhone: clientData['×˜×œ×¤×•×Ÿ'] || '',
      clientEmail: clientData['××™××™×™×œ'] || '',
      projectAddress: orderData.projectAddress || orderData.deliveryAddress || ''
    });
    
    // ×©××™×¨×ª ×”×ª×‘× ×™×ª ×‘-Google Drive
    const htmlBlob = Utilities.newBlob(orderTemplate, 'text/html', `×”×–×× ×”_${orderId}.html`);
    const driveFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const htmlFile = driveFolder.createFile(htmlBlob);
    htmlFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // ×™×¦×™×¨×ª ×§×•×‘×¥ PDF (××•×¤×¦×™×•× ×œ×™)
    const pdfBlob = htmlFile.getAs('application/pdf');
    const pdfFile = driveFolder.createFile(pdfBlob).setName(`×”×–×× ×”_${orderId}.pdf`);
    pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // ×¢×“×›×•×Ÿ ×”×©×•×¨×” ×¢× ×§×™×©×•×¨ ×”×”×–×× ×”
    const lastRow = ordersSheet.getLastRow();
    ordersSheet.getRange(lastRow, 11).setValue(htmlFile.getUrl());
    
    // ×¨×™×©×•× ×‘×œ×•×’
    logOrderCreation(orderId, clientId, '×”×–×× ×” ×—×•×¤×©×™×ª', 1);
    
    Logger.log(`âœ… ×”×–×× ×” ×—×•×¤×©×™×ª × ×•×¦×¨×”: ${orderId}`);
    
    return {
      success: true,
      data: {
        orderId: orderId,
        htmlUrl: htmlFile.getUrl(),
        pdfUrl: pdfFile.getUrl(),
        viewUrl: htmlFile.getUrl(),
        message: "×”×”×–×× ×” × ×•×¦×¨×” ×‘×”×¦×œ×—×” ×•×”×•×¢××“×” ×œ×©×™×ª×•×£!"
      }
    };
    
  } catch (error) {
    Logger.log(`âŒ ×©×’×™××” ×‘-createFreeFormOrder: ${error}`);
    return {
      success: false,
      error: '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×”×–×× ×”: ' + error.message
    };
  }
}

/**
 * ××™×™×¦×¨ ×ª×‘× ×™×ª HTML ××¢×•×¦×‘×ª ×œ×”×–×× ×”
 */
function generateOrderTemplate(orderData) {
  const template = `
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×–×× ×” - ${orderData.projectName || '×¤×¨×•×™×§×˜'}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Assistant', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .order-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #008069, #128C7E);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .order-id {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-right: 5px solid #008069;
        }
        
        .section-title {
            color: #008069;
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .info-value {
            font-size: 1.1em;
            color: #333;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .products-table th {
            background: #008069;
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: 600;
        }
        
        .products-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            text-align: right;
        }
        
        .products-table tr:hover {
            background: #f8f9fa;
        }
        
        .total-row {
            background: #e8f5e8 !important;
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .notes {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            color: #666;
        }
        
        .whatsapp-btn {
            display: inline-block;
            background: #25D366;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .whatsapp-btn:hover {
            background: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="order-container">
        <div class="header">
            <h1>×”×–×× ×ª ×—×•××¨×™ ×‘× ×™×™×Ÿ</h1>
            <div class="order-id">××¡×¤×¨ ×”×–×× ×”: ${orderData.orderId}</div>
        </div>
        
        <div class="content">
            <!-- ×¤×¨×˜×™ ×œ×§×•×— -->
            <div class="section">
                <h2 class="section-title">ğŸ‘¤ ×¤×¨×˜×™ ×œ×§×•×—</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">×©× ×”×œ×§×•×—:</span>
                        <span class="info-value">${orderData.clientName}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">×˜×œ×¤×•×Ÿ:</span>
                        <span class="info-value">${orderData.clientPhone || '×œ× ×¦×•×™×Ÿ'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">××™××™×™×œ:</span>
                        <span class="info-value">${orderData.clientEmail || '×œ× ×¦×•×™×Ÿ'}</span>
                    </div>
                </div>
            </div>
            
            <!-- ×¤×¨×˜×™ ×¤×¨×•×™×§×˜ -->
            <div class="section">
                <h2 class="section-title">ğŸ—ï¸ ×¤×¨×˜×™ ×¤×¨×•×™×§×˜</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">×©× ×”×¤×¨×•×™×§×˜:</span>
                        <span class="info-value">${orderData.projectName || '×œ× ×¦×•×™×Ÿ'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">×›×ª×•×‘×ª ×”×¤×¨×•×™×§×˜:</span>
                        <span class="info-value">${orderData.projectAddress || '×œ× ×¦×•×™×Ÿ'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">×× ×”×œ ×”×¤×¨×•×™×§×˜:</span>
                        <span class="info-value">${orderData.projectManager || '×œ× ×¦×•×™×Ÿ'}</span>
                    </div>
                </div>
            </div>
            
            <!-- ×¤×¨×˜×™ ××¡×¤×§×” -->
            <div class="section">
                <h2 class="section-title">ğŸšš ×¤×¨×˜×™ ××¡×¤×§×”</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">×›×ª×•×‘×ª ××¡×¤×§×”:</span>
                        <span class="info-value">${orderData.deliveryAddress || '×œ× ×¦×•×™×Ÿ'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">×ª××¨×™×š ××¡×¤×§×” ××‘×•×§×©:</span>
                        <span class="info-value">${orderData.deliveryDate || '×œ×¤×™ ×ª×™××•×'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">×©×¢×ª ××¡×¤×§×”:</span>
                        <span class="info-value">${orderData.deliveryTime || '08:00-17:00'}</span>
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-label">×”×¢×¨×•×ª ××¡×¤×§×”:</span>
                    <span class="info-value">${orderData.deliveryNotes || '××™×Ÿ ×”×¢×¨×•×ª'}</span>
                </div>
            </div>
            
            <!-- ×¤×¨×˜×™ ××•×¦×¨×™× -->
            <div class="section">
                <h2 class="section-title">ğŸ“¦ ×¤×¨×˜×™ ××•×¦×¨×™×</h2>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>××•×¦×¨</th>
                            <th>×›××•×ª</th>
                            <th>×”×¢×¨×•×ª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orderData.products ? orderData.products.split('\n').map(product => {
                            return `<tr><td>${product}</td><td>-</td><td>-</td></tr>`;
                        }).join('') : '<tr><td colspan="3">×œ× ×¦×•×™× ×• ××•×¦×¨×™×</td></tr>'}
                    </tbody>
                </table>
            </div>
            
            <!-- ×”×¢×¨×•×ª × ×•×¡×¤×•×ª -->
            ${orderData.notes ? `
            <div class="section">
                <h2 class="section-title">ğŸ“ ×”×¢×¨×•×ª × ×•×¡×¤×•×ª</h2>
                <div class="notes">
                    ${orderData.notes}
                </div>
            </div>
            ` : ''}
            
            <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” -->
            <div class="action-buttons">
                <a href="https://wa.me/?text=×©×œ×•×, ×‘×¨×¦×•× ×™ ×œ×ª×× ××¡×¤×§×” ×œ×”×–×× ×” ${orderData.orderId}" 
                   class="whatsapp-btn" target="_blank">
                   ğŸ“ ×©×œ×— ×œ×•×•×¦××¤
                </a>
                <a href="tel:${orderData.clientPhone}" class="whatsapp-btn" style="background: #008069;">
                   ğŸ“ ×”×ª×§×©×¨ ×œ×œ×§×•×—
                </a>
            </div>
        </div>
        
        <div class="footer">
            <p>×”×–×× ×” ×–×• × ×•×¦×¨×” ×‘××•×¤×Ÿ ××•×˜×•××˜×™ ×‘×××¦×¢×•×ª ××¢×¨×›×ª ×—.×¡×‘×Ÿ</p>
            <p>×ª××¨×™×š ×™×¦×™×¨×”: ${new Date().toLocaleDateString('he-IL')}</p>
        </div>
    </div>
</body>
</html>`;
  
  return template;
}

/**
 * ××—×©×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×œ ×”×”×–×× ×•×ª
 */
function calculateOrderStats(orders) {
  var stats = {
    total: orders.length,
    active: 0,
    completed: 0,
    pending: 0,
    byType: {
      container: 0,
      material: 0,
      crane: 0
    }
  };
  
  orders.forEach(function(order) {
    // ×¡×¤×™×¨×” ×œ×¤×™ ×¡×•×’
    if (stats.byType.hasOwnProperty(order.type)) {
      stats.byType[order.type]++;
    }
    
    // ×¡×¤×™×¨×” ×œ×¤×™ ×¡×˜×˜×•×¡
    var status = order.status ? order.status.toLowerCase() : '';
    if (status.includes('×”×•×©×œ×') || status.includes('×¡×™×•×') || status.includes('×¡×’×•×¨')) {
      stats.completed++;
    } else if (status.includes('×××ª×™×Ÿ') || status.includes('×‘×˜×™×¤×•×œ') || status.includes('×—×“×©×”')) {
      stats.pending++;
    } else {
      stats.active++;
    }
  });
  
  return stats;
}

/**
 * ×¨×™×©×•× ×”×œ×•×’ ×©×œ ×™×¦×™×¨×ª ×”×–×× ×”
 */
function logOrderCreation(orderId, clientId, product, quantity) {
  try {
    var spreadsheet = SpreadsheetApp.openById(SS_ID);
    var logSheet = spreadsheet.getSheetByName('×œ×•×’ ×”×–×× ×•×ª') || 
                   spreadsheet.insertSheet('×œ×•×’ ×”×–×× ×•×ª');
    
    // ×× ×–×” ×’×™×œ×™×•×Ÿ ×—×“×©, × ×™×¦×•×¨ ×›×•×ª×¨×•×ª
    if (logSheet.getLastRow() === 0) {
      logSheet.appendRow([
        '×ª××¨×™×š', '××–×”×” ×”×–×× ×”', '××–×”×” ×œ×§×•×—', '××•×¦×¨', '×›××•×ª', '×¡×˜×˜×•×¡'
      ]);
    }
    
    logSheet.appendRow([
      new Date(),
      orderId,
      clientId,
      product,
      quantity,
      '× ×•×¦×¨×”'
    ]);
    
  } catch (error) {
    Logger.log('Error logging order: ' + error);
  }
}

function uploadFile(payload) {
  try {
    const { fileName, base64Data, mimeType, clientId } = payload;
    
    Logger.log(`ğŸ“¤ ××ª×—×™×œ ×”×¢×œ××ª ×§×•×‘×¥: ${fileName}, ×¡×•×’: ${mimeType}`);
    
    // ×‘×“×™×§×” ×©×”×ª×™×§×™×™×” ×§×™×™××ª
    let driveFolder;
    try {
      driveFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
      Logger.log(`âœ… ×ª×™×§×™×™×” × ××¦××”: ${driveFolder.getName()}`);
    } catch (e) {
      // ×× ×”×ª×™×§×™×™×” ×œ× ×§×™×™××ª, × ×™×¦×•×¨ ×ª×™×§×™×™×” ×—×“×©×”
      driveFolder = DriveApp.createFolder('×—_×¡×‘×Ÿ_×§×‘×¦×™×');
      Logger.log('ğŸ“ × ×•×¦×¨×” ×ª×™×§×™×™×” ×—×“×©×”: ' + driveFolder.getName());
    }
    
    // ×”××¨×ª base64 ×œ-blob
    const decoded = Utilities.base64Decode(base64Data);
    const blob = Utilities.newBlob(decoded, mimeType, fileName);
    
    // ×™×¦×™×¨×ª ×”×§×•×‘×¥
    const file = driveFolder.createFile(blob);
    
    // ×”×•×¡×¤×ª ×”×¨×©××•×ª ×œ×¦×¤×™×™×” ×¦×™×‘×•×¨×™×ª
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    Logger.log('âœ… ×§×•×‘×¥ ×”×•×¢×œ×” ×‘×”×¦×œ×—×”: ' + fileName + ' ID: ' + file.getId());
    
    return { 
      success: true, 
      data: { 
        fileId: file.getId(), 
        fileUrl: file.getUrl(),
        downloadUrl: `https://drive.google.com/uc?id=${file.getId()}&export=download`,
        viewUrl: `https://drive.google.com/file/d/${file.getId()}/view`,
        fileName: fileName
      } 
    };
  } catch (error) {
    Logger.log(`âŒ ×©×’×™××” ×‘-uploadFile: ${error.toString()}`);
    return { 
      success: false, 
      error: `×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥: ${error.message}` 
    };
  }
}

function updateClientAddress(clientId, lat, lon) {
  try {
    // ×›××Ÿ × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ×œ×¢×“×›×•×Ÿ ×›×ª×•×‘×ª ×”×œ×§×•×— ×‘×’×™×œ×™×•×Ÿ ×”×œ×§×•×—×•×ª
    // ××• ×‘×’×™×œ×™×•×Ÿ ×”×¤×¨×•×™×§×˜×™× ×œ×¤×™ ×”×¦×•×¨×š
    
    return { success: true, data: { message: '××™×§×•× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”' } };
  } catch (error) {
    Logger.log(`Error in updateClientAddress: ${error.toString()}`);
    return { success: false, error: `×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”××™×§×•×: ${error.message}` };
  }
}

function checkClientsSheet() {
  try {
    const sheet = SpreadsheetApp.openById(SS_ID).getSheetByName("×œ×§×•×—×•×ª");
    if (!sheet) {
      return { success: false, error: "×’×™×œ×™×•×Ÿ '×œ×§×•×—×•×ª' ×œ× × ××¦×" };
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    Logger.log("×›×•×ª×¨×•×ª ×’×™×œ×™×•×Ÿ '×œ×§×•×—×•×ª': " + JSON.stringify(headers));
    Logger.log("××¡×¤×¨ ×©×•×¨×•×ª: " + data.length);
    
    // ×”×¦×’×ª ×”× ×ª×•× ×™× ×”×¨××©×•× ×™×
    if (data.length > 1) {
      Logger.log("×©×•×¨×” ×¨××©×•× ×” ×¢× × ×ª×•× ×™×: " + JSON.stringify(data[1]));
    }
    
    return {
      success: true,
      headers: headers,
      rowCount: data.length,
      sampleData: data.length > 1 ? data[1] : null
    };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function diagnoseClient(clientId = '60100') {
  try {
    const clients = getSheetDataAsObjects("×œ×§×•×—×•×ª");
    Logger.log(`=== ××‘×—×•×Ÿ ×œ×§×•×— ${clientId} ===`);
    
    const clientData = clients.find(c => {
      const clientIdStr = clientId.toString().trim();
      const possibleIds = [
        c['××–×”×”_×œ×§×•×—'] ? c['××–×”×”_×œ×§×•×—'].toString().trim() : '',
        c['××¡×¤×¨ ×œ×§×•×—'] ? c['××¡×¤×¨ ×œ×§×•×—'].toString().trim() : '',
        c['××–×”×” ×œ×§×•×—'] ? c['××–×”×” ×œ×§×•×—'].toString().trim() : ''
      ];
      return possibleIds.some(id => id === clientIdStr);
    });
    
    if (!clientData) {
      Logger.log('âŒ ×œ×§×•×— ×œ× × ××¦×');
      return { success: false, error: '×œ×§×•×— ×œ× × ××¦×' };
    }
    
    Logger.log('âœ… ×œ×§×•×— × ××¦×: ' + JSON.stringify(clientData));
    
    // ×‘×“×™×§×ª ×©×“×•×ª ×©× ××¤×©×¨×™×™×
    const nameFields = {
      '×©×_××œ×': clientData['×©×_××œ×'],
      '×©×_×œ×§×•×—': clientData['×©×_×œ×§×•×—'],
      '×©× ×œ×§×•×—': clientData['×©× ×œ×§×•×—'],
      'name': clientData['name'],
      '×©×': clientData['×©×']
    };
    
    Logger.log('ğŸ” ×©×“×•×ª ×©× ××¤×©×¨×™×™×: ' + JSON.stringify(nameFields));
    
    const clientName = clientData['×©×_××œ×'] || clientData['×©×_×œ×§×•×—'] || clientData['×©× ×œ×§×•×—'] || 
                      clientData['name'] || clientData['×©×'] || '×œ×§×•×—';
    
    Logger.log(`ğŸ“ ×©× ×œ×§×•×— ×¡×•×¤×™: "${clientName}"`);
    
    return {
      success: true,
      clientData: clientData,
      clientName: clientName,
      nameFields: nameFields
    };
    
  } catch (error) {
    Logger.log('âŒ ×©×’×™××” ×‘××‘×—×•×Ÿ: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function diagnoseSystem(clientId = '60100') {
  try {
    const results = {
      sheetStructure: checkClientsSheet(),
      clientSearch: null,
      dashboardData: null,
      fileUploadTest: null
    };
    
    // ×‘×“×™×§×ª ×—×™×¤×•×© ×œ×§×•×—
    const clients = getSheetDataAsObjects("×œ×§×•×—×•×ª");
    results.clientSearch = {
      totalClients: clients.length,
      clientIds: clients.map(c => c['××–×”×”_×œ×§×•×—'] || c['××¡×¤×¨ ×œ×§×•×—'] || c['××–×”×” ×œ×§×•×—']),
      foundClient: clients.find(c => {
        const id = c['××–×”×”_×œ×§×•×—'] || c['××¡×¤×¨ ×œ×§×•×—'] || c['××–×”×” ×œ×§×•×—'];
        return id && id.toString() === clientId.toString();
      })
    };
    
    // ×‘×“×™×§×ª ×˜×¢×™× ×ª ×“×©×‘×•×¨×“
    results.dashboardData = getDashboardData(clientId);
    
    // ×‘×“×™×§×ª ×”×¢×œ××ª ×§×•×‘×¥
    try {
      const testBlob = Utilities.newBlob("test content", "text/plain", "test.txt");
      const driveFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
      const testFile = driveFolder.createFile(testBlob);
      results.fileUploadTest = {
        success: true,
        fileId: testFile.getId(),
        message: "×”×¢×œ××ª ×§×•×‘×¥ ×‘×“×™×§×” ×”×¦×œ×™×—×”"
      };
    } catch (e) {
      results.fileUploadTest = {
        success: false,
        error: e.toString()
      };
    }
    
    return {
      success: true,
      diagnosis: results
    };
    
  } catch (error) {
    return {
      success: false,
      error: 'Diagnosis failed: ' + error.toString()
    };
  }
}

function createTestOrders() {
  const clientId = '60100';
  const clientName = '×ª×—×¡×™×Ÿ';
  const projectName = '×¤×¨×•×™×§×˜ ×‘×“×™×§×”';

  // ×™×¦×™×¨×ª ×”×–×× ×ª ××›×•×œ×ª ×œ×“×•×’××”
  const containersSheet = SpreadsheetApp.openById(SS_ID).getSheetByName("×”×–×× ×•×ª ××›×•×œ×•×ª");
  containersSheet.appendRow([
    `TEST-C-${Date.now()}`,
    clientId,
    clientName,
    projectName,
    '8 ×§×•×‘',
    new Date(),
    '',
    '×¤×¢×™×œ'
  ]);
  Logger.log('Test container order created for ×ª×—×¡×™×Ÿ.');

  // ×™×¦×™×¨×ª ×”×–×× ×ª ×—×•××¨×™× ×œ×“×•×’××”
  const materialsSheet = SpreadsheetApp.openById(SS_ID).getSheetByName("×”×–×× ×•×ª ×—×•××¨×™ ×‘× ×™×Ÿ");
  materialsSheet.appendRow([
    new Date(),
    clientId,
    clientName,
    projectName,
    '××¡×¤×§×” ××™×™×“×™×ª',
    '10 ×‘×œ×•×§×™×, 5 ×©×§×™ ××œ×˜',
    '×”×–×× ×ª ×‘×“×™×§×”',
    '×—×“×©×”'
  ]);
  Logger.log('Test materials order created for ×ª×—×¡×™×Ÿ.');
}
