const SS_ID = "146dXlaWJrYLcUiAhRCv3lCYrJuNDYGBOHkL86jgyvLI";
const DRIVE_FOLDER_ID = "1AWl10eAyTLOzNSp3LibtScDeH_SQKNZj";

function doPost(e) {
  try {
    const body = JSON.parse(e.postData.contents);
    let result;

    switch (body.action) {
      case 'getDashboardData': result = getDashboardData(body.clientId); break;
      case 'createOrderFromText': result = createOrderFromText(body.text, body.clientId, body.confirmed); break;
      case 'createFreeFormOrder': result = createFreeFormOrder(body.orderData, body.clientId); break;
      case 'uploadFile': result = uploadFile(body.payload); break;
      case 'updateClientAddress': result = updateClientAddress(body.clientId, body.lat, body.lon); break;
      case 'analyzeMessage': result = analyzeMessage(body.text, body.clientId); break;
      case 'diagnoseSystem': result = diagnoseSystem(body.clientId); break;
      case 'createMissingSheets': result = createMissingSheets(); break;
      case 'checkClientsSheet': result = checkClientsSheet(); break;
      case 'diagnoseClient': result = diagnoseClient(body.clientId); break;
      case 'generateOrderTemplate': result = generateOrderTemplate(body.orderData); break;
      default: throw new Error(`פעולה לא מוכרת: ${body.action}`);
    }
    
    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log(`Error in doPost: ${error.toString()}\nStacktrace: ${error.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ 
      success: false, 
      error: `שגיאת שרת: ${error.message}` 
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput("This script is running and responds to POST requests.");
}

// פונקציה ליצירת גיליונות חסרים
function createMissingSheets() {
  try {
    const spreadsheet = SpreadsheetApp.openById(SS_ID);
    const results = [];
    
    // רשימת הגיליונות הנדרשים ומבניהם
    const requiredSheets = {
      "לקוחות": [
        "מזהה_לקוח", "שם_מלא", "כתובת", "טלפון", "תמונת_פרופיל", "אימייל", "תאריך הרשמה"
      ],
      "הזמנות מכולות": [
        "מספר_הזמנה", "מספר לקוח", "שם לקוח", "שם פרויקט", "גודל", 
        "תאריך התחלה", "תאריך סיום", "סטטוס", "כתובת", "lat", "lon"
      ],
      "הזמנות חומרי בנין": [
        "תאריך קליטה", "מספר לקוח", "שם לקוח", "שם פרויקט", "פרטי אספקה",
        "פריטים", "הערות", "סטטוס", "כתובת", "נתונים_מלאים", "קישור_הזמנה"
      ],
      "הזמנות מנופים": [
        "מספר_הזמנה", "מספר לקוח", "שם לקוח", "שם פרויקט", "סוג מנוף",
        "משך השכרה", "תאריך התחלה", "תאריך סיום", "סטטוס", "כתובת", "הערות"
      ],
      "פרויקטים": [
        "שם_פרויקט", "כתובת", "lat", "lon", "לקוח"
      ],
      "לוג הזמנות": [
        "תאריך", "מזהה הזמנה", "מזהה לקוח", "מוצר", "כמות", "סטטוס"
      ],
      "מוצרים": [
        "שם_מוצר", "קטגוריה", "כינויים", "מחיר", "יחידת_מידה", "זמינות", "תיאור"
      ]
    };
    
    for (const [sheetName, headers] of Object.entries(requiredSheets)) {
      let sheet = spreadsheet.getSheetByName(sheetName);
      if (!sheet) {
        sheet = spreadsheet.insertSheet(sheetName);
        sheet.appendRow(headers);
        results.push(`✅ נוצר גיליון: ${sheetName}`);
        Logger.log(`Created sheet: ${sheetName}`);
        
        // אם זה גיליון מוצרים, נוסיף נתונים
        if (sheetName === "מוצרים") {
          createProductsSheetIfMissing();
        }
      } else {
        results.push(`✅ גיליון קיים: ${sheetName}`);
      }
    }
    
    return {
      success: true,
      message: "בדיקת גיליונות הושלמה",
      results: results
    };
    
  } catch (error) {
    Logger.log(`Error creating sheets: ${error.toString()}`);
    return {
      success: false,
      error: `שגיאה ביצירת גיליונות: ${error.message}`
    };
  }
}

function getSheetDataAsObjects(sheetName) {
    try {
        const sheet = SpreadsheetApp.openById(SS_ID).getSheetByName(sheetName);
        if (!sheet) {
            Logger.log(`Sheet "${sheetName}" not found.`);
            return [];
        }
        const data = sheet.getDataRange().getValues();
        if (data.length === 0) {
            Logger.log(`Sheet "${sheetName}" is empty.`);
            return [];
        }
        const headers = data[0];
        if (!headers || headers.length === 0) {
            Logger.log(`Sheet "${sheetName}" has no headers.`);
            return [];
        }
        
        // ניקוי שמות העמודות - מסיר רווחים מיותרים
        const cleanHeaders = headers.map(header => header.toString().trim());
        
        // המרת השורות לאובייקטים (מדלג על שורת הכותרות)
        const result = [];
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            const obj = {};
            for (let j = 0; j < cleanHeaders.length; j++) {
                if (j < row.length) {
                    obj[cleanHeaders[j]] = row[j];
                } else {
                    obj[cleanHeaders[j]] = '';
                }
            }
            result.push(obj);
        }
        
        return result;
    } catch (error) {
        Logger.log(`Error in getSheetDataAsObjects for ${sheetName}: ${error}`);
        return [];
    }
}

function createProductsSheetIfMissing() {
  try {
    const spreadsheet = SpreadsheetApp.openById(SS_ID);
    let sheet = spreadsheet.getSheetByName("מוצרים");
    
    if (sheet && sheet.getLastRow() <= 1) {
      // גיליון קיים אבל ריק - נוסיף נתונים
      const sampleProducts = [
        ["מלט אפור", "חומרי גלם", "מלט,צמנט,בטון,מלט אפור", 25, "שק", "כן", "מלט אפור 25 ק\"ג"],
        ["מלט לבן", "חומרי גלם", "מלט לבן,צמנט לבן", 35, "שק", "כן", "מלט לבן 25 ק\"ג"],
        ["חול", "חומרי גלם", "חול,חול לבניין,חול נהר", 15, "טון", "כן", "חול לבניין"],
        ["חצץ", "חומרי גלם", "חצץ,אבנים,אגרגט,חצץ לבניין", 20, "טון", "כן", "חצץ 0-4 מ\"מ"],
        ["בלוקים", "חומרי בניין", "בלוק,בלוקים,לבנים,לבנה,בלוק בטון", 8, "יחידה", "כן", "בלוק 20x20x40"],
        ["לבנים", "חומרי בניין", "לבנה,לבנים,אבן,לבני בניין", 12, "יחידה", "כן", "לבנים אדומות"],
        ["רעפים", "חומרי בניין", "רעף,רעפים,גג,רעפי גג", 15, "יחידה", "כן", "רעפים ספרדיים"],
        ["חול למילוי", "חומרי גלם", "חול מילוי,חול ליציקה,חול עפר", 12, "טון", "כן", "חול למילוי ויציקה"],
        ["חצץ לניקוז", "חומרי גלם", "חצץ ניקוז,אבני ניקוז,חצץ גס", 18, "טון", "כן", "חצץ 4-8 מ\"מ לניקוז"],
        ["רשת בנין", "חומרי בניין", "רשת,רשתות,רשת לבניין,רשת טיח", 45, "גליל", "כן", "רשת בניין 2x10 מטר"],
        ["טיח", "חומרי גמר", "טיח,טיח פנים,טיח חוץ,חומר טיח", 30, "שק", "כן", "טיח פנים-חוץ"],
        ["צבע", "חומרי גמר", "צבע,צבעי בניין,צבע קיר,צבע חוץ", 40, "ק\"ג", "כן", "צבע אקרילי לבן"],
        ["מכולה 6 מטר", "שכירות", "מכולה,קונטיינר,מיכל,מכולה קטנה", 500, "יחידה", "כן", "מכולה 6 מטר לשכירות"],
        ["מכולה 12 מטר", "שכירות", "מכולה גדולה,קונטיינר גדול,מכולה 12", 800, "יחידה", "כן", "מכולה 12 מטר לשכירות"],
        ["מנוף 25 טון", "שכירות", "מנוף,עגורן,מנוף בניין,מנוף 25", 1200, "יום", "כן", "מנוף 25 טון ליום עבודה"],
        ["מנוף 50 טון", "שכירות", "מנוף גדול,עגורן גדול,מנוף 50", 1800, "יום", "כן", "מנוף 50 טון ליום עבודה"]
      ];
      
      sampleProducts.forEach(product => sheet.appendRow(product));
      Logger.log('גיליון מוצרים אוּשר עם ' + sampleProducts.length + ' מוצרים');
    }
    
    return sheet;
  } catch (error) {
    Logger.log('שגיאה ביצירת גיליון מוצרים: ' + error);
    return null;
  }
}

function getDashboardData(clientId) {
    try {
        // יצירת גיליונות חסרים אם צריך
        createMissingSheets();
        
        const clients = getSheetDataAsObjects("לקוחות");
        Logger.log(`נמצאו ${clients.length} לקוחות במערכת`);
        
        // חיפוש גמיש יותר של הלקוח
        const clientData = clients.find(c => {
          const clientIdStr = clientId.toString().trim();
          const possibleIds = [
            c['מזהה_לקוח'] ? c['מזהה_לקוח'].toString().trim() : '',
            c['מספר לקוח'] ? c['מספר לקוח'].toString().trim() : '',
            c['מזהה לקוח'] ? c['מזהה לקוח'].toString().trim() : '',
            c['id'] ? c['id'].toString().trim() : '',
            c['clientId'] ? c['clientId'].toString().trim() : ''
          ];
          
          return possibleIds.some(id => id === clientIdStr);
        });
        
        if (!clientData) {
          const availableIds = clients.map(c => 
            c['מזהה_לקוח'] || c['מספר לקוח'] || c['מזהה לקוח'] || c['id'] || 'ללא מזהה'
          ).join(', ');
          
          Logger.log(`לקוח ${clientId} לא נמצא. מזההים זמינים: ${availableIds}`);
          return { 
            success: false, 
            error: "לקוח לא נמצא. אנא בדוק את מספר הלקוח." 
          };
        }

        Logger.log("לקוח נמצא: " + JSON.stringify(clientData));

        // מציאת שם הלקוח - מותאם למבנה הגיליון הספציפי
        const clientName = clientData['שם_מלא'] || clientData['שם_לקוח'] || clientData['שם לקוח'] || 
                          clientData['name'] || clientData['שם'] || 'לקוח';
        
        const clientAvatar = clientData['תמונת_פרופיל'] || clientData['תמונת פרופיל'] || 
                           clientData['avatar'] || 'https://i.postimg.cc/rsxW32Jj/logo.png';

        Logger.log(`📝 שם לקוח שנמצא עבור Dashboard: "${clientName}"`);

        const allProjects = getSheetDataAsObjects("פרויקטים");

        // חיפוש הזמנות מכולות
        const containersData = getSheetDataAsObjects("הזמנות מכולות");
        const containers = containersData
            .filter(o => {
              const orderClientId = o['מספר לקוח'] || o['מזהה_לקוח'] || o['מזהה לקוח'];
              return orderClientId && orderClientId.toString().trim() === clientId.toString().trim() && 
                     o.סטטוס !== 'סגור' && o.סטטוס !== 'הושלם';
            })
            .map(o => {
                const projectName = o['שם פרויקט'] || o['כתובת'] || 'פרויקט כללי';
                const project = allProjects.find(p => p['שם_פרויקט'] === projectName);
                return { 
                    type: 'container',
                    id: o['מספר_הזמנה'] || o['מספר הזמנה'] || `C${Date.now()}`,
                    project: projectName, 
                    status: o.סטטוס || 'פעיל', 
                    items: `מכולה ${o['גודל'] || o['סוג'] || ''}`.trim(),
                    startDate: o['תאריך התחלה'] || o['תאריך_התחלה'] || new Date(),
                    address: project ? project.כתובת : (o.כתובת || 'לא צוינה'),
                    lat: project ? project.lat : (o.lat || null),
                    lon: project ? project.lon : (o.lon || null)
                };
            });

        // חיפוש הזמנות חומרי בניין
        const materialsData = getSheetDataAsObjects("הזמנות חומרי בנין");
        const materials = materialsData
            .filter(o => {
              const orderClientId = o['מספר לקוח'] || o['מזהה_לקוח'] || o['מזהה לקוח'];
              return orderClientId && orderClientId.toString().trim() === clientId.toString().trim() && 
                     o.סטטוס !== 'סגור' && o.סטטוס !== 'הושלם';
            })
            .map(o => ({ 
                type: 'material',
                id: o['מספר_הזמנה'] || o['מספר הזמנה'] || `M${Date.now()}`,
                project: o['שם פרויקט'] || 'פרויקט כללי', 
                status: o.סטטוס || 'חדשה', 
                items: o['פריטים'] || o['מוצרים'] || 'לא צוין',
                address: o['כתובת'] || 'לא צוינה'
            }));

        // חיפוש הזמנות מנופים
        let cranes = [];
        try {
            const cranesData = getSheetDataAsObjects("הזמנות מנופים");
            cranes = cranesData
                .filter(o => {
                  const orderClientId = o['מספר לקוח'] || o['מזהה_לקוח'] || o['מזהה לקוח'];
                  return orderClientId && orderClientId.toString().trim() === clientId.toString().trim() && 
                         o.סטטוס !== 'סגור' && o.סטטוס !== 'הושלם';
                })
                .map(o => ({
                    type: 'crane',
                    id: o['מספר_הזמנה'] || o['מספר הזמנה'] || `CR${Date.now()}`,
                    project: o['שם פרויקט'] || 'פרויקט כללי',
                    status: o.סטטוס || 'חדשה',
                    items: `מנוף ${o['סוג מנוף'] || ''} - ${o['משך השכרה'] || ''}`.trim(),
                    address: o['כתובת'] || 'לא צוינה'
                }));
        } catch (e) {
            Logger.log('גיליון מנופים לא נמצא: ' + e.toString());
        }
        
        const allOrders = [...containers, ...materials, ...cranes];
        const stats = calculateOrderStats(allOrders);

        return { 
            success: true, 
            data: { 
                client: { 
                    id: clientData['מזהה_לקוח'] || clientData['מספר לקוח'] || 
                         clientData['מזהה לקוח'] || clientData['id'] || clientId,
                    name: clientName,
                    avatar: clientAvatar
                },
                dashboard: { 
                    orders: allOrders,
                    stats: stats,
                    lastUpdated: new Date().toISOString()
                }
            } 
        };
        
    } catch (error) {
        Logger.log('שגיאה ב-getDashboardData: ' + error.toString());
        return { 
            success: false, 
            error: 'שגיאה בטעינת נתונים: ' + error.message 
        };
    }
}

/**
 * מנתח הודעת טקסט ומזהה כוונות להזמנה
 */
function analyzeMessage(text, clientId) {
  try {
    var analysisResult = parseHebrewText(text);
    
    if (analysisResult.success) {
      return {
        success: true,
        data: {
          orderPreview: {
            product: analysisResult.product,
            quantity: analysisResult.quantity,
            unit: analysisResult.unit,
            estimatedPrice: analysisResult.estimatedPrice,
            confidence: analysisResult.confidence
          }
        }
      };
    } else {
      return {
        success: true,
        data: {
          message: getDefaultResponse(text)
        }
      };
    }
    
  } catch (error) {
    Logger.log('Error in analyzeMessage: ' + error.toString());
    return {
      success: false,
      error: 'שגיאה בניתוח ההודעה: ' + error.toString()
    };
  }
}

/**
 * מנתח טקסט בעברית כדי לחלץ פרטי הזמנה - גרסה משופרת עם גיליון מוצרים
 */
function parseHebrewText(text) {
  try {
    var lowerText = text.toLowerCase().trim();
    Logger.log(`🔍 מנתח טקסט: "${text}"`);
    
    // יצירת גיליון מוצרים אם חסר
    createProductsSheetIfMissing();
    
    // טעינת מוצרים מהגיליון
    const products = getSheetDataAsObjects("מוצרים");
    Logger.log(`📦 נמצאו ${products.length} מוצרים במערכת`);
    
    // חילוץ כמות
    var quantity = 1;
    var quantityMatch = lowerText.match(/(\d+)\s*(שק|ק"ג|קילו|טון|יחידה|יחידות|מטר|מ"ר|יום|ימים|גליל|קופסה|חבילה)/);
    if (quantityMatch) {
      quantity = parseInt(quantityMatch[1]);
      Logger.log(`🔢 נמצאה כמות: ${quantity} ${quantityMatch[2]}`);
    } else {
      // נסיון נוסף לחילוץ מספרים
      var simpleQuantityMatch = lowerText.match(/\d+/);
      if (simpleQuantityMatch) {
        quantity = parseInt(simpleQuantityMatch[0]);
        Logger.log(`🔢 נמצאה כמות מהטקסט: ${quantity}`);
      }
    }
    
    // חילוץ יחידה
    var unit = 'יחידה';
    var unitMatches = [
      { pattern: ['שק', 'שקים'], unit: 'שקים' },
      { pattern: ['ק"ג', 'קילו', 'קילוגרם'], unit: 'ק"ג' },
      { pattern: ['טון', 'טונות'], unit: 'טון' },
      { pattern: ['מטר', 'מ"ר', 'מטר רבוע'], unit: 'מ"ר' },
      { pattern: ['יום', 'ימים'], unit: 'ימים' },
      { pattern: ['גליל', 'גלילים'], unit: 'גליל' },
      { pattern: ['יחידה', 'יחידות'], unit: 'יחידה' }
    ];
    
    for (let match of unitMatches) {
      if (match.pattern.some(pattern => lowerText.includes(pattern))) {
        unit = match.unit;
        Logger.log(`📏 נמצאה יחידה: ${unit}`);
        break;
      }
    }
    
    // חיפוש מוצר בטקסט - באמצעות גיליון המוצרים
    var foundProduct = null;
    var confidence = 0;
    var matchedKeyword = '';
    
    for (var i = 0; i < products.length; i++) {
      var product = products[i];
      var productName = product['שם_מוצר'];
      var aliases = product['כינויים'] ? product['כינויים'].split(',') : [];
      
      // חיפוש לפי שם מוצר מלא
      if (productName && lowerText.includes(productName.toLowerCase())) {
        foundProduct = {
          name: productName,
          price: Number(product['מחיר']) || 0,
          unit: product['יחידת_מידה'] || unit,
          category: product['קטגוריה'] || ''
        };
        confidence = 0.9;
        matchedKeyword = productName;
        Logger.log(`✅ נמצא מוצר בשם מלא: ${productName}`);
        break;
      }
      
      // חיפוש לפי כינויים
      for (var j = 0; j < aliases.length; j++) {
        var alias = aliases[j].trim().toLowerCase();
        if (alias && lowerText.includes(alias)) {
          foundProduct = {
            name: productName,
            price: Number(product['מחיר']) || 0,
            unit: product['יחידת_מידה'] || unit,
            category: product['קטגוריה'] || ''
          };
          confidence = 0.8;
          matchedKeyword = alias;
          Logger.log(`✅ נמצא מוצר בכינוי: ${alias} -> ${productName}`);
          break;
        }
      }
      if (foundProduct) break;
    }
    
    // אם לא נמצא, ננסה חיפוש חלקי עם מילים בודדות
    if (!foundProduct) {
      var words = lowerText.split(/\s+/).filter(word => word.length > 2);
      Logger.log(`🔎 מחפש לפי מילים: ${words.join(', ')}`);
      
      for (var i = 0; i < words.length; i++) {
        var word = words[i];
        for (var j = 0; j < products.length; j++) {
          var product = products[j];
          var productName = product['שם_מוצר'];
          var aliases = product['כינויים'] ? product['כינויים'].split(',') : [];
          
          // חיפוש חלקי בשם המוצר
          if (productName && productName.toLowerCase().includes(word)) {
            foundProduct = {
              name: productName,
              price: Number(product['מחיר']) || 0,
              unit: product['יחידת_מידה'] || unit,
              category: product['קטגוריה'] || ''
            };
            confidence = 0.6;
            matchedKeyword = word;
            Logger.log(`✅ נמצא מוצר בחיפוש חלקי: ${word} -> ${productName}`);
            break;
          }
          
          // חיפוש חלקי בכינויים
          for (var k = 0; k < aliases.length; k++) {
            var alias = aliases[k].trim().toLowerCase();
            if (alias && alias.includes(word)) {
              foundProduct = {
                name: productName,
                price: Number(product['מחיר']) || 0,
                unit: product['יחידת_מידה'] || unit,
                category: product['קטגוריה'] || ''
              };
              confidence = 0.5;
              matchedKeyword = word;
              Logger.log(`✅ נמצא מוצר בכינוי חלקי: ${word} -> ${productName}`);
              break;
            }
          }
          if (foundProduct) break;
        }
        if (foundProduct) break;
      }
    }
    
    if (foundProduct) {
      var estimatedPrice = quantity * foundProduct.price;
      Logger.log(`💰 מחיר משוער: ${quantity} × ${foundProduct.price} = ${estimatedPrice} ש"ח`);
      
      return {
        success: true,
        product: foundProduct.name,
        quantity: quantity,
        unit: unit,
        estimatedPrice: estimatedPrice,
        confidence: confidence,
        category: foundProduct.category,
        matchedKeyword: matchedKeyword
      };
    }
    
    Logger.log('❌ לא נמצא מוצר מתאים בטקסט');
    return { 
      success: false,
      details: 'לא הצלחתי לזהות מוצר בהזמנה. נסה לפרט יותר כמו "מלט אפור 3 שקים" או "בלוקים 20 יחידות"'
    };
    
  } catch (error) {
    Logger.log('❌ שגיאה ב-parseHebrewText: ' + error.toString());
    return { 
      success: false,
      details: 'שגיאה בניתוח הטקסט: ' + error.message
    };
  }
}

/**
 * מחזיר תשובה מתאימה לפי הטקסט
 */
function getDefaultResponse(text) {
  var lowerText = text.toLowerCase();
  
  if (lowerText.includes('שלום') || lowerText.includes('היי') || lowerText.includes('בוקר') || lowerText.includes('ערב')) {
    return 'שלום! איך אוכל לעזור לך היום?';
  } else if (lowerText.includes('תודה') || lowerText.includes('תודהרבה')) {
    return 'בכיף! יש עוד משהו שאתה צריך?';
  } else if (lowerText.includes('מתי') || lowerText.includes('מתי תגיע')) {
    return 'אפשר לעקוב אחרי ההזמנה שלך בדשבורד. רוצה שאני אעביר אותך לשם?';
  } else if (lowerText.includes('מכולה') || lowerText.includes('קונטיינר')) {
    return 'אשמח לעזור עם הזמנת מכולה. תוכל לפרט את הגודל והמיקום?';
  } else if (lowerText.includes('מנוף') || lowerText.includes('עגורן')) {
    return 'אשמח לעזור עם הזמנת מנוף. תוכל לפרט את סוג המנוף ומשך ההשכרה?';
  } else {
    return 'אשמח לעזור! אתה יכול לבקש הזמנת חומרים (כמו "מלט אפור 3 שקים"), מכולה או מנוף.';
  }
}

/**
 * יוצר הזמנה חדשה מטקסט - עם תיקון שם לקוח
 */
function createOrderFromText(text, clientId, confirmed = false) {
  try {
    Logger.log(`🎯 מנסה ליצור הזמנה עבור לקוח: ${clientId}, טקסט: "${text}"`);
    
    // חיפוש לקוח עם לוגים מפורטים
    const clients = getSheetDataAsObjects("לקוחות");
    Logger.log(`נמצאו ${clients.length} לקוחות במערכת`);
    
    const clientData = clients.find(c => {
      const clientIdStr = clientId.toString().trim();
      const possibleIds = [
        c['מזהה_לקוח'] ? c['מזהה_לקוח'].toString().trim() : '',
        c['מספר לקוח'] ? c['מספר לקוח'].toString().trim() : '',
        c['מזהה לקוח'] ? c['מזהה לקוח'].toString().trim() : ''
      ];
      
      const found = possibleIds.some(id => id === clientIdStr);
      if (found) {
        Logger.log(`✅ נמצא לקוח: ${JSON.stringify(c)}`);
      }
      return found;
    });
    
    if (!clientData) {
      const availableIds = clients.map(c => 
        c['מזהה_לקוח'] || c['מספר לקוח'] || c['מזהה לקוח'] || 'ללא מזהה'
      ).join(', ');
      
      Logger.log(`❌ לקוח ${clientId} לא נמצא. מזההים זמינים: ${availableIds}`);
      return { 
        success: false, 
        error: "לקוח לא נמצא. אנא בדוק את מספר הלקוח." 
      };
    }

    // מציאת שם הלקוח - שימוש בשם_מלא כפי שמופיע בגיליון
    const clientName = clientData['שם_מלא'] || clientData['שם_לקוח'] || clientData['שם לקוח'] || 'לקוח';
    
    Logger.log(`📝 שם לקוח שנמצא: "${clientName}"`);

    // אם זו רק בקשה לניתוח (ללא אישור), נחזיר תצוגה מקדימה
    if (!confirmed) {
      var analysis = parseHebrewText(text);
      if (analysis.success) {
        Logger.log(`✅ ניתוח הצלחה: ${analysis.product} ${analysis.quantity} ${analysis.unit}`);
        return {
          success: true,
          data: {
            orderPreview: {
              product: analysis.product,
              quantity: analysis.quantity,
              unit: analysis.unit,
              estimatedPrice: analysis.estimatedPrice,
              category: analysis.category
            }
          }
        };
      } else {
        Logger.log(`❌ ניתוח נכשל: ${analysis.details}`);
        return {
          success: false,
          error: analysis.details || "לא הצלחתי לזהות הזמנה בטקסט ששלחת. נסה שוב עם פירוט מלא יותר."
        };
      }
    }

    // אם מאושר - ניצור את ההזמנה בפועל
    var analysis = parseHebrewText(text);
    if (!analysis.success) {
      return {
        success: false,
        error: analysis.details || "לא הצלחתי לעבד את ההזמנה. נסה שוב."
      };
    }

    // קביעת סוג הגיליון לפי קטגוריית המוצר
    var sheetName, orderData;
    var productCategory = analysis.category || '';
    
    if (productCategory.includes('שכירות') || analysis.product.includes('מכולה') || analysis.product.includes('מנוף')) {
      if (analysis.product.includes('מכולה')) {
        sheetName = "הזמנות מכולות";
        orderData = [
          `TXT-C-${Date.now()}`,
          clientId,
          clientName, // שימוש בשם הלקוח שנמצא
          'הזמנה מהצאט',
          `${analysis.quantity} ${analysis.unit}`,
          new Date(),
          '',
          'חדשה',
          clientData['כתובת'] || '',
          '',
          '',
          text
        ];
      } else if (analysis.product.includes('מנוף')) {
        sheetName = "הזמנות מנופים";
        orderData = [
          `TXT-CR-${Date.now()}`,
          clientId,
          clientName, // שימוש בשם הלקוח שנמצא
          'הזמנה מהצאט',
          analysis.product,
          `${analysis.quantity} ${analysis.unit}`,
          new Date(),
          '',
          'חדשה',
          clientData['כתובת'] || '',
          text
        ];
      }
    } else {
      // הזמנת חומרי בניין רגילה
      sheetName = "הזמנות חומרי בנין";
      orderData = [
        new Date(),
        clientId,
        clientName, // שימוש בשם הלקוח שנמצא
        'הזמנה מהצאט',
        'אספקה לפי הזמנה',
        `${analysis.quantity} ${analysis.unit} ${analysis.product}`,
        `מחיר משוער: ${analysis.estimatedPrice} ש"ח | קטגוריה: ${analysis.category}`,
        'חדשה',
        clientData['כתובת'] || '',
        text
      ];
    }

    // יצירת ההזמנה
    const sheet = SpreadsheetApp.openById(SS_ID).getSheetByName(sheetName);
    if (!sheet) {
      return {
        success: false,
        error: `גיליון ${sheetName} לא נמצא`
      };
    }
    
    sheet.appendRow(orderData);
    
    const orderId = sheet.getLastRow();
    const fullOrderId = `${sheetName === "הזמנות מכולות" ? "CONT" : sheetName === "הזמנות מנופים" ? "CRANE" : "MAT"}-${orderId}`;
    
    // רישום בלוג
    logOrderCreation(fullOrderId, clientId, analysis.product, analysis.quantity);
    
    Logger.log(`✅ הזמנה נוצרה בהצלחה: ${fullOrderId} - ${analysis.product} ${analysis.quantity} ${analysis.unit}`);
    
    return { 
      success: true, 
      data: { 
        orderId: fullOrderId,
        product: analysis.product,
        quantity: analysis.quantity,
        unit: analysis.unit,
        estimatedPrice: analysis.estimatedPrice,
        clientName: clientName,
        category: analysis.category
      } 
    };
    
  } catch (error) {
    Logger.log('❌ שגיאה ב-createOrderFromText: ' + error.toString());
    return {
      success: false,
      error: 'שגיאה ביצירת ההזמנה: ' + error.toString()
    };
  }
}

/**
 * יוצר הזמנה חופשית עם תבנית מעוצבת
 */
function createFreeFormOrder(orderData, clientId) {
  try {
    Logger.log(`🎯 יצירת הזמנה חופשית עבור לקוח: ${clientId}`);
    
    // שליפת נתוני הלקוח
    const clients = getSheetDataAsObjects("לקוחות");
    const clientData = clients.find(c => {
      const clientIdStr = clientId.toString().trim();
      const possibleIds = [
        c['מזהה_לקוח'] ? c['מזהה_לקוח'].toString().trim() : '',
        c['מספר לקוח'] ? c['מספר לקוח'].toString().trim() : '',
        c['מזהה לקוח'] ? c['מזהה לקוח'].toString().trim() : ''
      ];
      return possibleIds.some(id => id === clientIdStr);
    });
    
    if (!clientData) {
      return { success: false, error: "לקוח לא נמצא" };
    }

    // יצירת מזהה הזמנה
    const orderId = `FREE-${Date.now()}`;
    
    // שמירת ההזמנה בגיליון ההזמנות
    const ordersSheet = SpreadsheetApp.openById(SS_ID).getSheetByName("הזמנות חומרי בנין");
    const orderRow = [
      new Date(), // תאריך קליטה
      clientId, // מספר לקוח
      clientData['שם_מלא'] || clientData['שם_לקוח'] || 'לקוח', // שם לקוח
      orderData.projectName || 'הזמנה כללית', // שם פרויקט
      orderData.deliveryDetails || 'אספקה לפי הזמנה', // פרטי אספקה
      orderData.products, // פריטים
      orderData.notes || 'אין הערות', // הערות
      'מאושר', // סטטוס
      orderData.deliveryAddress || clientData['כתובת'] || '', // כתובת
      JSON.stringify(orderData), // נתונים מלאים
      '' // קישור_הזמנה (יימולא לאחר מכן)
    ];
    
    ordersSheet.appendRow(orderRow);
    
    // יצירת תבנית מעוצבת
    const orderTemplate = generateOrderTemplate({
      ...orderData,
      orderId: orderId,
      clientName: clientData['שם_מלא'] || clientData['שם_לקוח'] || 'לקוח',
      clientPhone: clientData['טלפון'] || '',
      clientEmail: clientData['אימייל'] || '',
      projectAddress: orderData.projectAddress || orderData.deliveryAddress || ''
    });
    
    // שמירת התבנית ב-Google Drive
    const htmlBlob = Utilities.newBlob(orderTemplate, 'text/html', `הזמנה_${orderId}.html`);
    const driveFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const htmlFile = driveFolder.createFile(htmlBlob);
    htmlFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // יצירת קובץ PDF (אופציונלי)
    const pdfBlob = htmlFile.getAs('application/pdf');
    const pdfFile = driveFolder.createFile(pdfBlob).setName(`הזמנה_${orderId}.pdf`);
    pdfFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // עדכון השורה עם קישור ההזמנה
    const lastRow = ordersSheet.getLastRow();
    ordersSheet.getRange(lastRow, 11).setValue(htmlFile.getUrl());
    
    // רישום בלוג
    logOrderCreation(orderId, clientId, 'הזמנה חופשית', 1);
    
    Logger.log(`✅ הזמנה חופשית נוצרה: ${orderId}`);
    
    return {
      success: true,
      data: {
        orderId: orderId,
        htmlUrl: htmlFile.getUrl(),
        pdfUrl: pdfFile.getUrl(),
        viewUrl: htmlFile.getUrl(),
        message: "ההזמנה נוצרה בהצלחה והועמדה לשיתוף!"
      }
    };
    
  } catch (error) {
    Logger.log(`❌ שגיאה ב-createFreeFormOrder: ${error}`);
    return {
      success: false,
      error: 'שגיאה ביצירת ההזמנה: ' + error.message
    };
  }
}

/**
 * מייצר תבנית HTML מעוצבת להזמנה
 */
function generateOrderTemplate(orderData) {
  const template = `
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הזמנה - ${orderData.projectName || 'פרויקט'}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Assistant', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .order-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #008069, #128C7E);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .order-id {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-right: 5px solid #008069;
        }
        
        .section-title {
            color: #008069;
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .info-value {
            font-size: 1.1em;
            color: #333;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .products-table th {
            background: #008069;
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: 600;
        }
        
        .products-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            text-align: right;
        }
        
        .products-table tr:hover {
            background: #f8f9fa;
        }
        
        .total-row {
            background: #e8f5e8 !important;
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .notes {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            color: #666;
        }
        
        .whatsapp-btn {
            display: inline-block;
            background: #25D366;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .whatsapp-btn:hover {
            background: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="order-container">
        <div class="header">
            <h1>הזמנת חומרי בניין</h1>
            <div class="order-id">מספר הזמנה: ${orderData.orderId}</div>
        </div>
        
        <div class="content">
            <!-- פרטי לקוח -->
            <div class="section">
                <h2 class="section-title">👤 פרטי לקוח</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">שם הלקוח:</span>
                        <span class="info-value">${orderData.clientName}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">טלפון:</span>
                        <span class="info-value">${orderData.clientPhone || 'לא צוין'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">אימייל:</span>
                        <span class="info-value">${orderData.clientEmail || 'לא צוין'}</span>
                    </div>
                </div>
            </div>
            
            <!-- פרטי פרויקט -->
            <div class="section">
                <h2 class="section-title">🏗️ פרטי פרויקט</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">שם הפרויקט:</span>
                        <span class="info-value">${orderData.projectName || 'לא צוין'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">כתובת הפרויקט:</span>
                        <span class="info-value">${orderData.projectAddress || 'לא צוין'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">מנהל הפרויקט:</span>
                        <span class="info-value">${orderData.projectManager || 'לא צוין'}</span>
                    </div>
                </div>
            </div>
            
            <!-- פרטי אספקה -->
            <div class="section">
                <h2 class="section-title">🚚 פרטי אספקה</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">כתובת אספקה:</span>
                        <span class="info-value">${orderData.deliveryAddress || 'לא צוין'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">תאריך אספקה מבוקש:</span>
                        <span class="info-value">${orderData.deliveryDate || 'לפי תיאום'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">שעת אספקה:</span>
                        <span class="info-value">${orderData.deliveryTime || '08:00-17:00'}</span>
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-label">הערות אספקה:</span>
                    <span class="info-value">${orderData.deliveryNotes || 'אין הערות'}</span>
                </div>
            </div>
            
            <!-- פרטי מוצרים -->
            <div class="section">
                <h2 class="section-title">📦 פרטי מוצרים</h2>
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>מוצר</th>
                            <th>כמות</th>
                            <th>הערות</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orderData.products ? orderData.products.split('\n').map(product => {
                            return `<tr><td>${product}</td><td>-</td><td>-</td></tr>`;
                        }).join('') : '<tr><td colspan="3">לא צוינו מוצרים</td></tr>'}
                    </tbody>
                </table>
            </div>
            
            <!-- הערות נוספות -->
            ${orderData.notes ? `
            <div class="section">
                <h2 class="section-title">📝 הערות נוספות</h2>
                <div class="notes">
                    ${orderData.notes}
                </div>
            </div>
            ` : ''}
            
            <!-- כפתורי פעולה -->
            <div class="action-buttons">
                <a href="https://wa.me/?text=שלום, ברצוני לתאם אספקה להזמנה ${orderData.orderId}" 
                   class="whatsapp-btn" target="_blank">
                   📞 שלח לווצאפ
                </a>
                <a href="tel:${orderData.clientPhone}" class="whatsapp-btn" style="background: #008069;">
                   📞 התקשר ללקוח
                </a>
            </div>
        </div>
        
        <div class="footer">
            <p>הזמנה זו נוצרה באופן אוטומטי באמצעות מערכת ח.סבן</p>
            <p>תאריך יצירה: ${new Date().toLocaleDateString('he-IL')}</p>
        </div>
    </div>
</body>
</html>`;
  
  return template;
}

/**
 * מחשב סטטיסטיקות על ההזמנות
 */
function calculateOrderStats(orders) {
  var stats = {
    total: orders.length,
    active: 0,
    completed: 0,
    pending: 0,
    byType: {
      container: 0,
      material: 0,
      crane: 0
    }
  };
  
  orders.forEach(function(order) {
    // ספירה לפי סוג
    if (stats.byType.hasOwnProperty(order.type)) {
      stats.byType[order.type]++;
    }
    
    // ספירה לפי סטטוס
    var status = order.status ? order.status.toLowerCase() : '';
    if (status.includes('הושלם') || status.includes('סיום') || status.includes('סגור')) {
      stats.completed++;
    } else if (status.includes('ממתין') || status.includes('בטיפול') || status.includes('חדשה')) {
      stats.pending++;
    } else {
      stats.active++;
    }
  });
  
  return stats;
}

/**
 * רישום הלוג של יצירת הזמנה
 */
function logOrderCreation(orderId, clientId, product, quantity) {
  try {
    var spreadsheet = SpreadsheetApp.openById(SS_ID);
    var logSheet = spreadsheet.getSheetByName('לוג הזמנות') || 
                   spreadsheet.insertSheet('לוג הזמנות');
    
    // אם זה גיליון חדש, ניצור כותרות
    if (logSheet.getLastRow() === 0) {
      logSheet.appendRow([
        'תאריך', 'מזהה הזמנה', 'מזהה לקוח', 'מוצר', 'כמות', 'סטטוס'
      ]);
    }
    
    logSheet.appendRow([
      new Date(),
      orderId,
      clientId,
      product,
      quantity,
      'נוצרה'
    ]);
    
  } catch (error) {
    Logger.log('Error logging order: ' + error);
  }
}

function uploadFile(payload) {
  try {
    const { fileName, base64Data, mimeType, clientId } = payload;
    
    Logger.log(`📤 מתחיל העלאת קובץ: ${fileName}, סוג: ${mimeType}`);
    
    // בדיקה שהתיקייה קיימת
    let driveFolder;
    try {
      driveFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
      Logger.log(`✅ תיקייה נמצאה: ${driveFolder.getName()}`);
    } catch (e) {
      // אם התיקייה לא קיימת, ניצור תיקייה חדשה
      driveFolder = DriveApp.createFolder('ח_סבן_קבצים');
      Logger.log('📁 נוצרה תיקייה חדשה: ' + driveFolder.getName());
    }
    
    // המרת base64 ל-blob
    const decoded = Utilities.base64Decode(base64Data);
    const blob = Utilities.newBlob(decoded, mimeType, fileName);
    
    // יצירת הקובץ
    const file = driveFolder.createFile(blob);
    
    // הוספת הרשאות לצפייה ציבורית
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    Logger.log('✅ קובץ הועלה בהצלחה: ' + fileName + ' ID: ' + file.getId());
    
    return { 
      success: true, 
      data: { 
        fileId: file.getId(), 
        fileUrl: file.getUrl(),
        downloadUrl: `https://drive.google.com/uc?id=${file.getId()}&export=download`,
        viewUrl: `https://drive.google.com/file/d/${file.getId()}/view`,
        fileName: fileName
      } 
    };
  } catch (error) {
    Logger.log(`❌ שגיאה ב-uploadFile: ${error.toString()}`);
    return { 
      success: false, 
      error: `שגיאה בהעלאת הקובץ: ${error.message}` 
    };
  }
}

function updateClientAddress(clientId, lat, lon) {
  try {
    // כאן ניתן להוסיף לוגיקה לעדכון כתובת הלקוח בגיליון הלקוחות
    // או בגיליון הפרויקטים לפי הצורך
    
    return { success: true, data: { message: 'מיקום עודכן בהצלחה' } };
  } catch (error) {
    Logger.log(`Error in updateClientAddress: ${error.toString()}`);
    return { success: false, error: `שגיאה בעדכון המיקום: ${error.message}` };
  }
}

function checkClientsSheet() {
  try {
    const sheet = SpreadsheetApp.openById(SS_ID).getSheetByName("לקוחות");
    if (!sheet) {
      return { success: false, error: "גיליון 'לקוחות' לא נמצא" };
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    Logger.log("כותרות גיליון 'לקוחות': " + JSON.stringify(headers));
    Logger.log("מספר שורות: " + data.length);
    
    // הצגת הנתונים הראשונים
    if (data.length > 1) {
      Logger.log("שורה ראשונה עם נתונים: " + JSON.stringify(data[1]));
    }
    
    return {
      success: true,
      headers: headers,
      rowCount: data.length,
      sampleData: data.length > 1 ? data[1] : null
    };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function diagnoseClient(clientId = '60100') {
  try {
    const clients = getSheetDataAsObjects("לקוחות");
    Logger.log(`=== אבחון לקוח ${clientId} ===`);
    
    const clientData = clients.find(c => {
      const clientIdStr = clientId.toString().trim();
      const possibleIds = [
        c['מזהה_לקוח'] ? c['מזהה_לקוח'].toString().trim() : '',
        c['מספר לקוח'] ? c['מספר לקוח'].toString().trim() : '',
        c['מזהה לקוח'] ? c['מזהה לקוח'].toString().trim() : ''
      ];
      return possibleIds.some(id => id === clientIdStr);
    });
    
    if (!clientData) {
      Logger.log('❌ לקוח לא נמצא');
      return { success: false, error: 'לקוח לא נמצא' };
    }
    
    Logger.log('✅ לקוח נמצא: ' + JSON.stringify(clientData));
    
    // בדיקת שדות שם אפשריים
    const nameFields = {
      'שם_מלא': clientData['שם_מלא'],
      'שם_לקוח': clientData['שם_לקוח'],
      'שם לקוח': clientData['שם לקוח'],
      'name': clientData['name'],
      'שם': clientData['שם']
    };
    
    Logger.log('🔍 שדות שם אפשריים: ' + JSON.stringify(nameFields));
    
    const clientName = clientData['שם_מלא'] || clientData['שם_לקוח'] || clientData['שם לקוח'] || 
                      clientData['name'] || clientData['שם'] || 'לקוח';
    
    Logger.log(`📝 שם לקוח סופי: "${clientName}"`);
    
    return {
      success: true,
      clientData: clientData,
      clientName: clientName,
      nameFields: nameFields
    };
    
  } catch (error) {
    Logger.log('❌ שגיאה באבחון: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function diagnoseSystem(clientId = '60100') {
  try {
    const results = {
      sheetStructure: checkClientsSheet(),
      clientSearch: null,
      dashboardData: null,
      fileUploadTest: null
    };
    
    // בדיקת חיפוש לקוח
    const clients = getSheetDataAsObjects("לקוחות");
    results.clientSearch = {
      totalClients: clients.length,
      clientIds: clients.map(c => c['מזהה_לקוח'] || c['מספר לקוח'] || c['מזהה לקוח']),
      foundClient: clients.find(c => {
        const id = c['מזהה_לקוח'] || c['מספר לקוח'] || c['מזהה לקוח'];
        return id && id.toString() === clientId.toString();
      })
    };
    
    // בדיקת טעינת דשבורד
    results.dashboardData = getDashboardData(clientId);
    
    // בדיקת העלאת קובץ
    try {
      const testBlob = Utilities.newBlob("test content", "text/plain", "test.txt");
      const driveFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
      const testFile = driveFolder.createFile(testBlob);
      results.fileUploadTest = {
        success: true,
        fileId: testFile.getId(),
        message: "העלאת קובץ בדיקה הצליחה"
      };
    } catch (e) {
      results.fileUploadTest = {
        success: false,
        error: e.toString()
      };
    }
    
    return {
      success: true,
      diagnosis: results
    };
    
  } catch (error) {
    return {
      success: false,
      error: 'Diagnosis failed: ' + error.toString()
    };
  }
}

function createTestOrders() {
  const clientId = '60100';
  const clientName = 'תחסין';
  const projectName = 'פרויקט בדיקה';

  // יצירת הזמנת מכולת לדוגמה
  const containersSheet = SpreadsheetApp.openById(SS_ID).getSheetByName("הזמנות מכולות");
  containersSheet.appendRow([
    `TEST-C-${Date.now()}`,
    clientId,
    clientName,
    projectName,
    '8 קוב',
    new Date(),
    '',
    'פעיל'
  ]);
  Logger.log('Test container order created for תחסין.');

  // יצירת הזמנת חומרים לדוגמה
  const materialsSheet = SpreadsheetApp.openById(SS_ID).getSheetByName("הזמנות חומרי בנין");
  materialsSheet.appendRow([
    new Date(),
    clientId,
    clientName,
    projectName,
    'אספקה מיידית',
    '10 בלוקים, 5 שקי מלט',
    'הזמנת בדיקה',
    'חדשה'
  ]);
  Logger.log('Test materials order created for תחסין.');
}
