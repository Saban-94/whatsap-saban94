<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>העוזר האישי להזמנות - ח.סבן</title>
    <link id="manifest-link" rel="manifest">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/2SbDgD1B/1.png">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --brand-color: #0b72b9; --accent-color: #ff9f1c; --bg-color: #e5ddd5; --app-bg-color: #f7f7f7;
            --text-dark: #333; --text-light: #666; --border-color: #e0e0e0;
            --outgoing-bg: #dcf8c6; --incoming-bg: #ffffff; --system-bg: #e1f2fb;
            --large-radius: 20px; --small-radius: 8px; --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Assistant', sans-serif; background-color: var(--bg-color); }
        
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--app-bg-color);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }
        
        /* Login Screen */
        .login-screen {
            display: flex; align-items: center; justify-content: center;
            height: 100%; padding: 20px; background: linear-gradient(135deg, var(--brand-color) 0%, #00a8e8 100%);
        }
        .login-box {
            background: #fff; padding: 40px 30px; border-radius: var(--large-radius);
            box-shadow: var(--shadow); text-align: center; width: 100%; max-width: 350px;
        }
        .login-box h1 { font-size: 2.5rem; font-weight: 700; color: var(--brand-color); margin-bottom: 10px; }
        .login-box p { color: var(--text-light); margin-bottom: 30px; }
        .login-box input {
            width: 100%; padding: 15px; border-radius: var(--small-radius); border: 1px solid var(--border-color);
            font-size: 1.2rem; text-align: center; margin-bottom: 20px;
        }
        .login-box button {
            width: 100%; padding: 15px; border-radius: var(--small-radius); border: none;
            background-color: var(--brand-color); color: #fff; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;
        }
        .login-box button:hover { transform: scale(1.05); }

        /* Chat Screen */
        .chat-header {
            display: flex; align-items: center; padding: 10px 15px; background: #f1f1f1;
            border-bottom: 1px solid var(--border-color);
        }
        .chat-header img { width: 45px; height: 45px; border-radius: 50%; margin-left: 15px; }
        .chat-header .info { flex-grow: 1; }
        .chat-header .info h2 { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-dark); }
        .chat-header .info p { margin: 0; font-size: 0.8rem; color: var(--text-light); }

        .chat-canvas {
            flex-grow: 1; overflow-y: auto; padding: 15px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-repeat: repeat;
        }
        .message-bubble {
            max-width: 80%; padding: 8px 12px; border-radius: var(--small-radius);
            margin-bottom: 10px; line-height: 1.4; position: relative;
        }
        .message-bubble.outgoing { background: var(--outgoing-bg); align-self: flex-start; border-top-right-radius: 0; }
        .message-bubble.incoming { background: var(--incoming-bg); align-self: flex-end; border-top-left-radius: 0; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .message-bubble.system { background: var(--system-bg); align-self: center; font-size: 0.8rem; color: #555; text-align: center; }
        .message-bubble .timestamp { font-size: 0.7rem; color: var(--text-light); margin-top: 5px; text-align: left; }

        /* Draft Bubble */
        .draft-bubble {
            background: #fff; border: 1px solid var(--border-color); padding: 15px; border-radius: var(--small-radius); margin: 10px 0;
        }
        .draft-bubble h3 { margin: 0 0 10px; font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .draft-bubble ul { margin: 0; padding: 0 15px 0 0; }
        .draft-bubble li { margin-bottom: 5px; }
        .draft-bubble .actions { margin-top: 15px; display: flex; gap: 10px; }
        .draft-bubble button { padding: 8px 15px; border-radius: var(--small-radius); border: none; cursor: pointer; font-weight: 600; }
        .draft-bubble .confirm-btn { background-color: #25d366; color: white; }
        .draft-bubble .cancel-btn { background-color: #e74c3c; color: white; }

        .chat-footer {
            display: flex; align-items: center; padding: 10px; background: #f1f1f1;
        }
        .chat-footer textarea {
            flex-grow: 1; border: none; padding: 12px 15px; border-radius: 20px;
            font-size: 1rem; resize: none; max-height: 100px;
        }
        .chat-footer button {
            border: none; background: var(--brand-color); color: white;
            width: 45px; height: 45px; border-radius: 50%; margin-right: 10px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* Spinner */
        #spinner-overlay {
            position: absolute; inset: 0; background: rgba(255,255,255,0.8);
            display: none; align-items: center; justify-content: center; z-index: 100;
        }
        #spinner-text {
             background-color: #fff; padding: 20px 30px; border-radius: var(--small-radius);
             box-shadow: var(--shadow); font-weight: 600; color: var(--text-dark);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="spinner-overlay"><div id="spinner-text"></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const root = document.getElementById('root');
            // IMPORTANT: Replace with your deployed Google Apps Script URL
            const API_URL = "https://script.google.com/macros/s/AKfycbzF7YbSOWDLiUwcEvWPK7w9lQQA5iv7OwooFh8sjj_VVfj-F_dpQR9xHBaNYS8IsV50/exec"; 
            let clientData = null;

            function renderLoginScreen() {
                root.innerHTML = `
                    <div class="login-screen">
                        <div class="login-box">
                            <h1>ח. סבן</h1>
                            <p>העוזר האישי שלך להזמנות</p>
                            <input id="client-id-input" type="tel" placeholder="הקלד מספר לקוח" />
                            <button id="login-btn">כניסה</button>
                        </div>
                    </div>
                `;
                document.getElementById('login-btn').addEventListener('click', handleLogin);
            }

            async function handleLogin() {
                const clientId = document.getElementById('client-id-input').value;
                if (!clientId) return;
                showSpinner('מאמת נתונים...');
                try {
                    const response = await apiPost({ action: 'login', clientId });
                    if (response.success) {
                        clientData = response.data;
                        renderChatScreen();
                    } else {
                        alert(response.error);
                    }
                } catch (e) {
                    alert('שגיאת תקשורת. ודא שהכתובת של ה-API נכונה ושהשרת פועל.');
                    console.error(e);
                } finally {
                    hideSpinner();
                }
            }

            function renderChatScreen() {
                root.innerHTML = `
                    <div id="app-container">
                        <header class="chat-header">
                            <img src="${clientData.avatar || 'https://i.postimg.cc/rsxW32Jj/logo.png'}" alt="Avatar">
                            <div class="info">
                                <h2>${clientData.name}</h2>
                                <p>מחובר</p>
                            </div>
                        </header>
                        <main class="chat-canvas" id="chat-canvas"></main>
                        <footer class="chat-footer">
                             <button id="send-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                            </button>
                            <textarea id="message-input" placeholder="הדבק כאן את רשימת המוצרים..." rows="1"></textarea>
                        </footer>
                    </div>
                `;
                document.getElementById('send-btn').addEventListener('click', handleSendMessage);
                document.getElementById('message-input').addEventListener('input', autoResizeTextarea);
                
                addMessageToCanvas({ sender: 'system', text: `ברוך הבא, ${clientData.name}! אני כאן כדי לעזור לך להפוך כל רשימה להזמנה מסודרת.` });
            }

            function autoResizeTextarea(e) {
                e.target.style.height = 'auto';
                e.target.style.height = e.target.scrollHeight + 'px';
            }

            async function handleSendMessage() {
                const input = document.getElementById('message-input');
                const text = input.value.trim();
                if (!text) return;

                addMessageToCanvas({ sender: 'user', text });
                input.value = '';
                input.style.height = 'auto';
                showSpinner('מנתח את ההזמנה...');

                try {
                    const response = await apiPost({ action: 'predictOrder', text, clientId: clientData.id });
                    if (response.success && response.data.predictedItems.length > 0) {
                        createDraftBubble(response.data);
                    } else {
                        addMessageToCanvas({ sender: 'system', text: 'לא הצלחתי לזהות מוצרים בהודעה ששלחת. אפשר לנסות שוב עם פירוט רב יותר?' });
                    }
                } catch(e) {
                    console.error(e);
                    addMessageToCanvas({ sender: 'system', text: 'אופס, קרתה שגיאה בניתוח ההודעה.' });
                } finally {
                    hideSpinner();
                }
            }
            
            function createDraftBubble(data) {
                const draftId = `draft-${Date.now()}`;
                const itemsHtml = data.predictedItems.map(item => `<li>${item.quantity} x ${item.name} (${item.sku})</li>`).join('');
                const projectHtml = data.predictedProject ? `<p><strong>פרויקט:</strong> ${data.predictedProject}</p>` : '<p><strong>לא זוהה פרויקט משויך.</strong></p>';

                const bubbleHtml = `
                    <div class="message-bubble system draft-bubble" id="${draftId}">
                        <h3>טיוטת הזמנה מוכנה לאישור</h3>
                        ${projectHtml}
                        <ul>${itemsHtml}</ul>
                        <div class="actions">
                            <button class="confirm-btn">אשר ושתף ב-WhatsApp</button>
                            <button class="cancel-btn">בטל</button>
                        </div>
                    </div>
                `;
                const canvas = document.getElementById('chat-canvas');
                canvas.insertAdjacentHTML('beforeend', bubbleHtml);

                const draftElement = document.getElementById(draftId);
                draftElement.querySelector('.confirm-btn').addEventListener('click', () => handleConfirmOrder(draftId, data));
                draftElement.querySelector('.cancel-btn').addEventListener('click', () => draftElement.remove());
                scrollToBottom();
            }

            async function handleConfirmOrder(draftId, orderData) {
                showSpinner('יוצר הזמנה וקישור...');
                const draftElement = document.getElementById(draftId);
                draftElement.innerHTML = 'מאשר הזמנה...';

                try {
                    const response = await apiPost({ action: 'createOrder', orderData, clientId: clientData.id });
                    if (response.success) {
                        confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                        draftElement.innerHTML = 'ההזמנה תועדה במערכת בהצלחה!';
                        const whatsappUrl = generateWhatsappLink(response.data.formattedOrder);
                        window.open(whatsappUrl, '_blank');
                    } else {
                        draftElement.innerHTML = `שגיאה בתיעוד ההזמנה: ${response.error}`;
                    }
                } catch(e) {
                    console.error(e);
                    draftElement.innerHTML = 'שגיאה בתיעוד ההזמנה.';
                } finally {
                    hideSpinner();
                }
            }
            
            function generateWhatsappLink(orderText) {
                const phoneNumber = "972508860896";
                const encodedText = encodeURIComponent(orderText);
                return `https://wa.me/${phoneNumber}?text=${encodedText}`;
            }

            function addMessageToCanvas({ sender, text }) {
                const canvas = document.getElementById('chat-canvas');
                const bubble = document.createElement('div');
                let bubbleClass = 'message-bubble';
                if(sender === 'user') bubbleClass += ' incoming';
                else if (sender === 'system') bubbleClass += ' system';
                else bubbleClass += ' outgoing'; 
                
                bubble.className = bubbleClass;
                bubble.textContent = text;
                canvas.appendChild(bubble);
                scrollToBottom();
            }

            function showSpinner(text) {
                const overlay = document.getElementById('spinner-overlay');
                overlay.querySelector('#spinner-text').textContent = text;
                overlay.style.display = 'flex';
            }
            function hideSpinner() {
                document.getElementById('spinner-overlay').style.display = 'none';
            }
            function scrollToBottom() {
                const canvas = document.getElementById('chat-canvas');
                if (canvas) canvas.scrollTop = canvas.scrollHeight;
            }

            async function apiPost(body) {
                if (API_URL === "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE") {
                    // This error is a safeguard to remind the developer to deploy the script.
                    throw new Error("Please set your Google Apps Script URL in the API_URL constant.");
                }
                // Using redirect: 'follow' is important for Apps Script web apps.
                const response = await fetch(API_URL, { 
                    method: 'POST', 
                    redirect: 'follow',
                    body: JSON.stringify(body), 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.json();
            }
            
            // Initial render
            renderLoginScreen();
        });
    </script>
</body>
</html>

