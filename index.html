/**
 * @OnlyCurrentDoc
 * Logistics Engine V3.3 (Fixed): הוספת תמיכה ב-CORS + עדכון אבטחה.
 */
const SHEETS = {
  ORDERS: 'כתיבת הזמנה לסידור - Orders',
  CUSTOMERS: 'כתיבת הזמנה לסידור - Customers',
  SETTINGS: 'כתיבת הזמנה לסידור - Settings',
  MAPS: 'כתיבת הזמנה לסידור - maps',
  CITIES: 'כתיבת הזמנה לסידור - cities',
  HISTORY: 'כתיבת הזמנה לסידור - History'
};

// ✅ טיפול מלא ב-CORS למניעת חסימות בין דומיינים
function doGet(e) {
  if (e.parameter.action) {
    try {
      let data;
      switch (e.parameter.action) {
        case 'getInitialData':
          data = getInitialData();
          break;
        case 'getDashboardAnalytics':
          data = getDashboardAnalytics();
          break;
        case 'getOrdersByDate':
          data = getOrdersByDate(e.parameter.date);
          break;
        case 'getHistoricalData':
          data = getHistoricalData(e.parameter.address);
          break;
        default:
          throw new Error(`Invalid GET action: ${e.parameter.action}`);
      }
      return createCorsResponse({ status: 'success', data: data });
    } catch (err) {
      Logger.log(`doGet Error: ${err.stack}`);
      return createCorsResponse({ status: 'error', message: err.message });
    }
  }
  return HtmlService.createHtmlOutputFromFile('dashboard').setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function doPost(e) {
  try {
    // בדיקת preflight (OPTIONS)
    if (e && e.parameter && e.parameter._cors) {
      return createCorsResponse({ status: 'ok', message: 'Preflight success' });
    }

    const requestData = JSON.parse(e.postData.contents);
    if (!requestData || !requestData.action) {
      throw new Error('Invalid POST request: "action" is missing.');
    }

    switch (requestData.action) {
      case 'addOrder':
        handleNewCustomer(requestData.payload.customer);
        return createCorsResponse({ status: 'success', data: addOrderToSheet(requestData.payload) });
      case 'updateOrder':
        return createCorsResponse({ status: 'success', data: updateOrderInSheet(requestData.payload) });
      case 'archiveOrder':
        archiveOrder(requestData.payload);
        return createCorsResponse({ status: 'success', message: 'Order archived' });
      case 'ping':
        return createCorsResponse({ status: 'ok', message: 'Ping success' });
      default:
        throw new Error(`Invalid POST action: ${requestData.action}`);
    }
  } catch (error) {
    Logger.log(`doPost Error: ${error.stack}`);
    return createCorsResponse({ status: 'error', message: error.toString() });
  }
}

// 🧩 פונקציה מרכזית שיוצרת תגובה תקינה עם כותרות CORS
function createCorsResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin', '*')
    .setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
    .setHeader('Access-Control-Allow-Headers', 'Content-Type');
}

// 🧱 שאר הפונקציות (ללא שינוי לוגי)
function archiveOrder(payload) {
  const { orderId, departureTime, returnTime } = payload;
  const ordersSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.ORDERS);
  const historySheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.HISTORY);
  if (!ordersSheet || !historySheet) throw new Error('Sheet not found.');
  const data = ordersSheet.getDataRange().getValues();
  const headers = data[0];
  const idColIndex = headers.findIndex(h => h.toLowerCase() === 'id');
  if (idColIndex === -1) throw new Error("'id' column not found.");
  for (let i = 1; i < data.length; i++) {
    if (data[i][idColIndex] == orderId) {
      const rowToArchive = data[i];
      historySheet.appendRow([...rowToArchive, departureTime, returnTime, new Date()]);
      ordersSheet.deleteRow(i + 1);
      return;
    }
  }
  throw new Error('Order ID not found for archiving.');
}

function updateOrderInSheet(order) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.ORDERS);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift().map(h => String(h || ''));
  const idColIndex = headers.findIndex(h => h.toLowerCase() === 'id');
  for (let i = 0; i < data.length; i++) {
    if (data[i][idColIndex] == order.id) {
      const updatedRow = headers.map(header => order[header] || '');
      sheet.getRange(i + 2, 1, 1, updatedRow.length).setValues([updatedRow]);
      return order;
    }
  }
  throw new Error('Order ID not found for update.');
}

function getHistoricalData(address) {
  if (!address) return [];
  const data = getSheetDataAsJson(SHEETS.HISTORY, true);
  return data.filter(entry => {
    const entryAddress = `${entry.street || ''} ${entry.street_number || ''}, ${entry.city || ''}`.trim();
    return entryAddress === address;
  });
}

function getInitialData() {
  return {
    activeOrders: getSheetDataAsJson(SHEETS.ORDERS, true),
    warehouses: getSheetDataAsJson(SHEETS.SETTINGS).filter(w => w.key?.startsWith('warehouse_')).map(w => w.value),
    deliveryTypes: getSheetDataAsJson(SHEETS.MAPS).map(item => item.delivery_type).filter(Boolean),
    customers: getSheetDataAsJson(SHEETS.CUSTOMERS, true),
    cities: getSheetDataAsJson(SHEETS.CITIES).map(item => item.city).filter(Boolean).sort()
  };
}

function addOrderToSheet(order) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.ORDERS);
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  order.id = `ORD-${Date.now()}`;
  order.timestamp = new Date().toLocaleString('en-US', { timeZone: 'Asia/Jerusalem' });
  order.status = 'חדשה';
  const newRow = headers.map(header => order[header] || '');
  sheet.appendRow(newRow);
  return order;
}

function getSheetDataAsJson(sheetName, useRawHeaders = false) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) throw new Error(`Sheet named "${sheetName}" was not found.`);
  const dataRange = sheet.getDataRange();
  if (dataRange.getNumRows() <= 1) return [];
  const values = dataRange.getValues();
  const headersRaw = values.shift();
  const headers = headersRaw.map(h => useRawHeaders ? (h || '').toString().trim() : (h || '').toString().trim().toLowerCase().replace(/[^a-z0-9_]/g, '_'));
  return values.map(row => {
    let obj = {};
    headers.forEach((header, index) => {
      if (header) {
        const value = row[index];
        obj[header] = (value instanceof Date) ? Utilities.formatDate(value, ss.getSpreadsheetTimeZone(), 'yyyy-MM-dd') : value;
      }
    });
    return obj;
  });
}

function getDashboardAnalytics() {
  const orders = getSheetDataAsJson(SHEETS.ORDERS, true);
  const ordersByCity = {}, ordersByType = {}, ordersByCustomer = {};
  orders.forEach(order => {
    if (order.city) ordersByCity[order.city] = (ordersByCity[order.city] || 0) + 1;
    if (order.delivery_type) ordersByType[order.delivery_type] = (ordersByType[order.delivery_type] || 0) + 1;
    if (order.customer) ordersByCustomer[order.customer] = (ordersByCustomer[order.customer] || 0) + 1;
  });
  const topCities = Object.entries(ordersByCity).sort(([, a], [, b]) => b - a).slice(0, 5);
  const topCustomers = Object.entries(ordersByCustomer).sort(([, a], [, b]) => b - a).slice(0, 5);
  return {
    totalOrders: orders.length,
    topCities: { labels: topCities.map(i => i[0]), data: topCities.map(i => i[1]) },
    deliveryTypes: { labels: Object.keys(ordersByType), data: Object.values(ordersByType) },
    topCustomers: { labels: topCustomers.map(i => i[0]), data: topCustomers.map(i => i[1]) }
  };
}

function getOrdersByDate(dateString) {
  return getSheetDataAsJson(SHEETS.ORDERS, true).filter(order => order.date === dateString);
}

function handleNewCustomer(name) {
  if (!name) return;
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.CUSTOMERS);
  if (!sheet) return;
  const existing = sheet.getDataRange().getValues().map(row => (row[0] || '').toString().trim().toLowerCase());
  if (!existing.includes(name.trim().toLowerCase())) sheet.appendRow([name.trim()]);
}

// 🪄 הדרכה להמשך:
// 1️⃣ הדבק את הקוד הזה בקובץ Code.gs שלך והחלף את הישן.
// 2️⃣ לחץ Deploy → New Deployment → Web App.
// 3️⃣ בחר Anyone → Allow access.
// 4️⃣ עדכן את ה-SCRIPT_URL באתר שלך בכתובת החדשה.
// 5️⃣ טען מחדש את האתר וודא שאין הודעות CORS בקונסול.
