<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - לוח שיבוצים</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .kpi-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .scheduling-board {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .driver-column {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .driver-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .driver-header img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .timeline {
            padding: 10px;
            min-height: 400px;
        }
        
        .time-slot {
            display: flex;
            margin-bottom: 5px;
            border: 1px dashed #ddd;
            border-radius: 4px;
        }
        
        .time-label {
            background: #f8f9fa;
            padding: 5px;
            min-width: 50px;
            text-align: center;
            font-size: 12px;
        }
        
        .drop-zone {
            flex: 1;
            min-height: 60px;
            padding: 5px;
        }
        
        .order-card {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .address-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }
        
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #1976d2;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .log-entry {
            position: fixed;
            bottom: 10px;
            left: 10px;
            padding: 10px;
            border-radius: 4px;
            color: white;
            max-width: 300px;
        }
        
        .log-entry.error { background: #f44336; }
        .log-entry.success { background: #4caf50; }
        .log-entry.info { background: #2196f3; }
    </style>
</head>
<body>
    <div id="logger"></div>

    <div class="header">
        <h1>לוח שיבוצים</h1>
        <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
            <input type="date" id="datePicker">
            <button id="addNewOrderBtn">+ הזמנה חדשה</button>
        </div>
    </div>

    <div class="kpi-container">
        <div class="kpi-card">
            <div style="font-size: 24px; font-weight: bold;" id="totalOrders">0</div>
            <div>הזמנות פעילות</div>
        </div>
        <div class="kpi-card">
            <div style="font-size: 24px; font-weight: bold;" id="activeDrivers">2</div>
            <div>נהגים פעילים</div>
        </div>
        <div class="kpi-card">
            <div style="font-size: 24px; font-weight: bold;" id="totalKm">0</div>
            <div>ק"מ משוערים</div>
        </div>
    </div>

    <div class="scheduling-board">
        <div class="driver-column">
            <div class="driver-header">
                <img src="https://i.postimg.cc/d3S0NJJZ/Screenshot-20250623-200646-Facebook.jpg" alt="חכמת">
                <div>
                    <h3>חכמת</h3>
                    <div style="font-size: 12px; color: #666;">
                        <span id="hakmat-orders-count">0 הזמנות</span> | 
                        <span id="hakmat-km-total">0 ק"מ</span>
                    </div>
                </div>
            </div>
            <div class="timeline" id="timeline-hakmat"></div>
        </div>

        <div class="driver-column">
            <div class="driver-header">
                <img src="https://i.postimg.cc/tCNbgXK3/Screenshot-20250623-200744-Tik-Tok.jpg" alt="עלי">
                <div>
                    <h3>עלי</h3>
                    <div style="font-size: 12px; color: #666;">
                        <span id="ali-orders-count">0 הזמנות</span> | 
                        <span id="ali-km-total">0 ק"מ</span>
                    </div>
                </div>
            </div>
            <div class="timeline" id="timeline-ali"></div>
        </div>
    </div>

    <!-- Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                <h2 id="form-title">הזמנה חדשה</h2>
                <button onclick="closeModal()" style="background: #f44336;">X</button>
            </div>
            
            <form id="createOrderForm">
                <input type="hidden" id="orderId">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>לקוח *</label>
                        <input list="customers-list" id="orderCustomer" required>
                        <datalist id="customers-list"></datalist>
                    </div>
                    
                    <div class="form-group">
                        <label>טלפון *</label>
                        <input type="tel" id="orderPhone" required>
                    </div>
                    
                    <div class="form-group">
                        <label>שם איש קשר</label>
                        <input type="text" id="orderContactName">
                    </div>
                    
                    <div class="form-group">
                        <label>עיר *</label>
                        <select id="orderCity" required>
                            <option value="">בחר עיר...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>סוג הובלה *</label>
                        <select id="orderDeliveryType" required>
                            <option value="">בחר סוג הובלה...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>נהג *</label>
                        <select id="orderDriver" required>
                            <option value="חכמת">חכמת</option>
                            <option value="עלי">עלי</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>תאריך *</label>
                        <input type="date" id="orderDate" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>שעה *</label>
                        <input type="time" id="orderTime" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>כתובת *</label>
                    <div class="address-row">
                        <input type="text" id="orderStreet" placeholder="רחוב" required>
                        <input type="text" id="orderStreetNumber" placeholder="מספר בית">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>מחסן *</label>
                    <select id="orderWarehouse" required>
                        <option value="התלמיד">התלמיד 6, הוד השרון</option>
                        <option value="החרש">החרש 10, הוד השרון</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>הערות</label>
                    <textarea id="orderNotes" rows="3"></textarea>
                </div>
                
                <button type="submit" id="submitOrderBtn">שמור הזמנה</button>
            </form>
        </div>
    </div>

<script>
// כתובת ה-URL שלך
// Add CORS proxy to your frontend JavaScript
const BACKEND_BASE = 'https://script.google.com/macros/s/AKfycbwdnuF-_JNoGgvfMcHe3SMcMABNSoYQngZ35-aq9G5YHFFhgWEM5BP2zKkeR7wXRgwV/exec';
const BACKEND_URL = `https://api.allorigins.win/get?url=${encodeURIComponent(BACKEND_BASE)}`;

// Then modify your fetch calls to handle the proxy response:
async function loadOrders(date) {
  try {
    showMessage('טוען הזמנות...', 'info');
    
    const url = `${BACKEND_URL}&action=getActiveOrders&date=${date}`;
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`שגיאה: ${response.status}`);
    }
    
    const result = await response.json();
    const data = JSON.parse(result.contents); // Parse the actual response
    
    if (data.status === 'success') {
      allOrders = data.data || [];
      renderOrders();
      updateKPIs();
      showMessage(`נטענו ${allOrders.length} הזמנות`, 'success');
    } else {
      throw new Error(data.data || 'שגיאה בטעינת הנתונים');
    }
    
  } catch (error) {
    console.error('Error loading orders:', error);
    showMessage('שגיאה בטעינת ההזמנות: ' + error.message, 'error');
    allOrders = [];
    renderOrders();
  }
}
let allOrders = [];
let customersData = [];
let citiesData = [];

// מערכת הודעות
function showMessage(message, type = 'info') {
    const logger = document.getElementById('logger');
    const messageDiv = document.createElement('div');
    messageDiv.className = `log-entry ${type}`;
    messageDiv.textContent = message;
    logger.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 5000);
}

// אתחול תאריך
function initializeDate() {
    const now = new Date();
    document.getElementById('datePicker').value = now.toISOString().split('T')[0];
}

// יצירת חלונות זמן
function generateTimeSlots() {
    const timelines = ['hakmat', 'ali'];
    
    timelines.forEach(driver => {
        const timeline = document.getElementById(`timeline-${driver}`);
        timeline.innerHTML = '';
        
        for (let hour = 6; hour < 18; hour++) {
            for (let minute of ['00', '30']) {
                const time = `${hour.toString().padStart(2, '0')}:${minute}`;
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.innerHTML = `
                    <div class="time-label">${time}</div>
                    <div class="drop-zone" data-time="${time}" data-driver="${driver}"></div>
                `;
                timeline.appendChild(timeSlot);
            }
        }
    });
}

// טעינת הזמנות

// הצגת הזמנות
function renderOrders() {
    // נקה הזמנות קיימות
    document.querySelectorAll('.order-card').forEach(card => card.remove());
    
    const stats = {
        hakmat: { orders: 0, km: 0 },
        ali: { orders: 0, km: 0 }
    };
    
    allOrders.forEach(order => {
        const driver = order['נהג'] || order.driver;
        const driverKey = driver === 'חכמת' ? 'hakmat' : 'ali';
        const time = order['שעה'] || order.time;
        
        const timeSlot = document.querySelector(`#timeline-${driverKey} .drop-zone[data-time="${time}"]`);
        
        if (timeSlot) {
            const orderCard = createOrderCard(order);
            timeSlot.appendChild(orderCard);
            
            stats[driverKey].orders++;
            
            // חישוב ק"מ
            const city = citiesData.find(c => c['עיר'] === (order['עיר'] || order.city));
            if (city && city['מרחק מהוד השרון (ק"מ)']) {
                stats[driverKey].km += parseFloat(city['מרחק מהוד השרון (ק"מ)']);
            }
        }
    });
    
    // עדכון סטטיסטיקות
    document.getElementById('hakmat-orders-count').textContent = `${stats.hakmat.orders} הזמנות`;
    document.getElementById('hakmat-km-total').textContent = `${stats.hakmat.km.toFixed(1)} ק"מ`;
    document.getElementById('ali-orders-count').textContent = `${stats.ali.orders} הזמנות`;
    document.getElementById('ali-km-total').textContent = `${stats.ali.km.toFixed(1)} ק"מ`;
}

// יצירת כרטיס הזמנה
function createOrderCard(order) {
    const div = document.createElement('div');
    div.className = 'order-card';
    div.innerHTML = `
        <div style="font-weight: bold;">${order['לקוח'] || order.customer}</div>
        <div style="font-size: 12px; color: #666;">${order['כתובת אספקה'] || ''}</div>
        <div style="font-size: 11px; color: #888;">${order['שעה'] || ''} | ${order['סוג הובלה'] || ''}</div>
    `;
    
    div.addEventListener('click', () => {
        openEditModal(order);
    });
    
    return div;
}

// עדכון KPI
function updateKPIs() {
    document.getElementById('totalOrders').textContent = allOrders.length;
    
    const totalKm = allOrders.reduce((sum, order) => {
        const city = citiesData.find(c => c['עיר'] === (order['עיר'] || order.city));
        return sum + (city && city['מרחק מהוד השרון (ק"מ)'] ? parseFloat(city['מרחק מהוד השרון (ק"מ)']) : 0);
    }, 0);
    
    document.getElementById('totalKm').textContent = totalKm.toFixed(0);
}

// טעינת לקוחות
async function loadCustomers() {
    try {
        const url = `${BACKEND_URL}?action=getCustomers`;
        const response = await fetch(url);
        
        if (!response.ok) throw new Error(`שגיאה: ${response.status}`);
        
        const result = await response.json();
        
        if (result.status === 'success') {
            customersData = result.data || [];
            populateCustomersList();
        }
    } catch (error) {
        console.error('Error loading customers:', error);
        customersData = [];
    }
}

// טעינת ערים
async function loadCities() {
    try {
        const url = `${BACKEND_URL}?action=getCities`;
        const response = await fetch(url);
        
        if (!response.ok) throw new Error(`שגיאה: ${response.status}`);
        
        const result = await response.json();
        
        if (result.status === 'success') {
            citiesData = result.data || [];
            populateCitiesList();
            populateDeliveryTypes();
        }
    } catch (error) {
        console.error('Error loading cities:', error);
        citiesData = [];
    }
}

// מילוי רשימת לקוחות
function populateCustomersList() {
    const datalist = document.getElementById('customers-list');
    datalist.innerHTML = '';
    
    customersData.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer['שם לקוח'] || customer.name || '';
        datalist.appendChild(option);
    });
}

// מילוי רשימת ערים
function populateCitiesList() {
    const select = document.getElementById('orderCity');
    select.innerHTML = '<option value="">בחר עיר...</option>';
    
    citiesData.forEach(city => {
        const option = document.createElement('option');
        option.value = city['עיר'] || city.name || '';
        option.textContent = city['עיר'] || city.name || '';
        select.appendChild(option);
    });
}

// מילוי סוגי הובלה
function populateDeliveryTypes() {
    const select = document.getElementById('orderDeliveryType');
    select.innerHTML = '<option value="">בחר סוג הובלה...</option>';
    
    const types = new Set();
    citiesData.forEach(city => {
        if (city['סוג הובלה']) {
            types.add(city['סוג הובלה']);
        }
    });
    
    types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        select.appendChild(option);
    });
}

// פתיחת מודל לעריכה
function openEditModal(order) {
    document.getElementById('form-title').textContent = 'עריכת הזמנה';
    document.getElementById('orderId').value = order['חותמת זמן'] || order.id || '';
    document.getElementById('orderCustomer').value = order['לקוח'] || order.customer || '';
    document.getElementById('orderPhone').value = order['טלפון'] || order.phone || '';
    document.getElementById('orderContactName').value = order['שם איש קשר'] || order.contactName || '';
    document.getElementById('orderCity').value = order['עיר'] || order.city || '';
    document.getElementById('orderDeliveryType').value = order['סוג הובלה'] || order.deliveryType || '';
    document.getElementById('orderDriver').value = order['נהג'] || order.driver || 'חכמת';
    document.getElementById('orderDate').value = (order['תאריך'] || order.date || '').split(' ')[0] || document.getElementById('datePicker').value;
    document.getElementById('orderTime').value = (order['שעה'] || order.time || '').replace(':00', '') || '09:00';
    document.getElementById('orderWarehouse').value = order['מחסן'] || order.warehouse || 'התלמיד';
    document.getElementById('orderNotes').value = order['הערות'] || order.notes || '';
    
    // פירוק כתובת
    const address = order['כתובת אספקה'] || '';
    const streetMatch = address.match(/^(.*?)\s+(\d+.*)?$/);
    if (streetMatch) {
        document.getElementById('orderStreet').value = streetMatch[1] || '';
        document.getElementById('orderStreetNumber').value = streetMatch[2] || '';
    }
    
    openModal();
}

// פתיחת מודל חדש
function openNewModal(driver, time) {
    document.getElementById('form-title').textContent = 'הזמנה חדשה';
    document.getElementById('createOrderForm').reset();
    document.getElementById('orderId').value = '';
    document.getElementById('orderDate').value = document.getElementById('datePicker').value;
    document.getElementById('orderTime').value = time || '09:00';
    document.getElementById('orderDriver').value = driver || 'חכמת';
    openModal();
}

function openModal() {
    document.getElementById('orderModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('orderModal').style.display = 'none';
}

// שליחת טופס
async function handleFormSubmit(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitOrderBtn');
    const originalText = submitBtn.textContent;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'שומר...';
    
    try {
        const formData = {
            id: document.getElementById('orderId').value,
            customer: document.getElementById('orderCustomer').value,
            phone: document.getElementById('orderPhone').value,
            contactName: document.getElementById('orderContactName').value,
            street: document.getElementById('orderStreet').value,
            streetNumber: document.getElementById('orderStreetNumber').value,
            city: document.getElementById('orderCity').value,
            deliveryType: document.getElementById('orderDeliveryType').value,
            driver: document.getElementById('orderDriver').value,
            date: document.getElementById('orderDate').value,
            time: document.getElementById('orderTime').value,
            warehouse: document.getElementById('orderWarehouse').value,
            notes: document.getElementById('orderNotes').value
        };
        
        // וידוא שדות חובה
        if (!formData.customer || !formData.phone || !formData.street || !formData.city) {
            throw new Error('נא למלא את כל השדות המסומנים ב-*');
        }
        
        const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'saveOrder',
                ...formData
            })
        });
        
        if (!response.ok) {
            throw new Error(`שגיאת רשת: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showMessage('ההזמנה נשמרה בהצלחה!', 'success');
            closeModal();
            await loadOrders(document.getElementById('datePicker').value);
        } else {
            throw new Error(result.data || 'שגיאה בשמירת ההזמנה');
        }
        
    } catch (error) {
        console.error('Error saving order:', error);
        showMessage('שגיאה בשמירת ההזמנה: ' + error.message, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

// אתחול האפליקציה
async function initializeApp() {
    initializeDate();
    generateTimeSlots();
    
    // טען נתונים ראשוניים
    await Promise.all([
        loadCustomers(),
        loadCities()
    ]);
    
    // טען הזמנות לתאריך הנוכחי
    await loadOrders(document.getElementById('datePicker').value);
    
    // הגדר מאזיני אירועים
    setupEventListeners();
    
    showMessage('המערכת מוכנה לשימוש', 'success');
}

function setupEventListeners() {
    // שינוי תאריך
    document.getElementById('datePicker').addEventListener('change', function() {
        loadOrders(this.value);
    });
    
    // כפתור הזמנה חדשה
    document.getElementById('addNewOrderBtn').addEventListener('click', () => {
        openNewModal('חכמת', '09:00');
    });
    
    // שליחת טופס
    document.getElementById('createOrderForm').addEventListener('submit', handleFormSubmit);
    
    // לחיצה על חלונות זמן ריקים
    document.querySelectorAll('.timeline').forEach(timeline => {
        timeline.addEventListener('click', (e) => {
            if (e.target.classList.contains('drop-zone') && e.target.children.length === 0) {
                const driver = e.target.dataset.driver === 'hakmat' ? 'חכמת' : 'עלי';
                const time = e.target.dataset.time;
                openNewModal(driver, time);
            }
        });
    });
    
    // אוטופיל לקוח
    document.getElementById('orderCustomer').addEventListener('change', function() {
        const customer = customersData.find(c => c['שם לקוח'] === this.value);
        if (customer) {
            document.getElementById('orderPhone').value = customer['טלפון'] || '';
            document.getElementById('orderContactName').value = customer['שם איש קשר'] || '';
        }
    });
}

// התחל את האפליקציה
initializeApp().catch(error => {
    console.error('Failed to initialize app:', error);
    showMessage('שגיאה בהפעלת המערכת: ' + error.message, 'error');
});
</script>
</body>
</html>
