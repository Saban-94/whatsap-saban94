<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>××¤×œ×™×§×¦×™×™×ª ×œ×§×•×—×•×ª | ×—. ×¡×‘×Ÿ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel for running JSX in the browser -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- OneSignal SDK for Push Notifications -->
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
    <script>
      window.OneSignal = window.OneSignal || [];
      OneSignal.push(function() {
        OneSignal.init({
          appId: "3e5551c0-255d-424a-b150-a92c0199f1e1", // Your OneSignal App ID
        });
      });
    </script>
    
    <style>
        body { font-family: 'Arial', sans-serif; }
        .whatsapp-bg { background-image: url('https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg'); background-size: contain; }
        .login-bg { background-image: url('https://source.unsplash.com/1600x900/?construction,architecture'); background-size: cover; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
    
    // =================================================================
    //  Google Apps Script Backend Configuration
    // =================================================================
    // !!! ×—×©×•×‘ ×××•×“: ××—×¨×™ ×©×ª×¢×œ×” ××ª ×§×•×‘×¥ ×”-Code.gs ×•×ª×¤×¨×¡× ××•×ª×• ×›-WebApp,
    // !!! ×”×“×‘×§ ×›××Ÿ ××ª ×”×›×ª×•×‘×ª ×©×§×™×‘×œ×ª.
    const WEB_APP_URL = '×”×“×‘×§ ×›××Ÿ ××ª ×›×ª×•×‘×ª ×”-URL ×©×œ ×”-WebApp ×©×œ×š ×-Google Apps Script';

    // =================================================================
    //  Data Simulation & Helper Functions
    // =================================================================
    
    const MOCK_CUSTOMERS = [
        { id: '60120', name: '×‘×¨ ××•×¨× ×™×œ', phone: '050-1234567', avatar: 'https://placehold.co/100x100/7F9CF5/EBF4FF?text=×‘.×' },
        { id: '60100', name: '×ª×—×¡×™×Ÿ', phone: '050-1234568', avatar: 'https://placehold.co/100x100/6366F1/EBF4FF?text=×ª' },
        { id: '608190', name: '×—.×¢× ×‘×¨ ××—×–×§×•×ª', phone: '052-5777307', avatar: 'https://placehold.co/100x100/F59E0B/FFFBEB?text=×—.×¢' },
        { id: 'cust_3', name: '×¨×•×ª× ×›×—×™×œ×”', phone: '052-4811575', avatar: 'https://placehold.co/100x100/10B981/ECFDF5?text=×¨.×›' },
    ];
    
    const MOCK_CHAT_TEMPLATES = {
        welcome: [ "×©×œ×•× {name} ğŸ‘‹, ××” ×ª×¨×¦×” ×œ×”×–××™×Ÿ ×”×™×•×?", "×”×™×™ {name}, ××¤×©×¨ ×œ×§×‘×œ ××ª ×¨×©×™××ª ×”×—×•××¨×™× ×©×“×¨×•×©×™× ×œ×š?", "×©××— ×œ×¨××•×ª ××•×ª×š, {name}! ×”×“×‘×§ ×›××Ÿ ××ª ×”×”×–×× ×” ×©×œ×š (×’× ×× ×”×™× ×œ× ××¡×•×“×¨×ª) ×•××¢×–×•×¨ ×œ×¡×“×¨ ×”×›×œ âœ…." ],
        order_confirmation: [ "×§×™×‘×œ×ª×™, ×‘×•×“×§ ××ª ×”×¤×¨×™×˜×™×...", "×× ×ª×— ××ª ×”×¨×©×™××” ×©×”×“×‘×§×ª, ×¨×’×¢...", "××¢×•×œ×”, ×ª×•×“×”! ××¡×“×¨ ×œ×š ××ª ×–×” ×¢×›×©×™×•." ],
        address: [ "××” ×”×›×ª×•×‘×ª ×”××“×•×™×§×ª ×œ××©×œ×•×—?", "×œ××Ÿ ×ª×¨×¦×” ×©× ×¡×¤×§ ××ª ×”×”×–×× ×”?" ],
        summary: [ "×”×”×–×× ×” ×›×•×œ×œ×ª ××ª: {items} â€” ×–×” × ×›×•×Ÿ?", "×¨×§ ×œ×•×•×“×, ×–×• ×”×¨×©×™××”: {items}. ×œ××©×¨?" ]
    };

    const getGreetingMessage = () => {
        const hour = new Date().getHours();
        if (hour < 12) return { text: "×‘×•×§×¨ ×˜×•×‘, {name}! ××™×–×” ×›×™×£ ×œ×”×ª×—×™×œ ××™×ª×š ××ª ×”×™×•×", emoji: "â˜€ï¸" };
        if (hour < 18) return { text: "×¦×”×¨×™×™× ×˜×•×‘×™×, {name}! ××§×•×•×” ×©×”×›×œ ×”×•×œ×š ×—×œ×§", emoji: "ğŸ˜Š" };
        return { text: "×¢×¨×‘ ×˜×•×‘, {name}! ×ª×¤×¡×ª ×œ×š ×¨×’×¢ ×©×œ × ×—×ª ×œ×ª×›× ×Ÿ ××ª ×™×•× ×”××—×¨? ×× ×—× ×• ×›××Ÿ 24/7 ×‘×©×‘×™×œ×š.", emoji: "ğŸŒ™" };
    };
    
    // Function to communicate with Google Apps Script
    const logActivityToSheet = async (action, data) => {
      if (!WEB_APP_URL.startsWith('https://')) {
        console.warn('WEB_APP_URL is not configured. Skipping sheet log.');
        return;
      }
      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'no-cors', // Important for simple POST requests to Apps Script
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            action: action,
            ...data
          })
        });
        console.log('Activity logged successfully');
      } catch (error) {
        console.error('Error logging to Google Sheet:', error);
      }
    };
    
    // --- SVG Icons ---
    const Icons = {
        Building: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0v-4m6 4v-4m6 4v-4m-9 4H3m2 0h5M9 7h6m-6 4h6m-6 4h6" /></svg>,
        Container: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-14L4 7v10l8 4m0-14V3" /></svg>,
        History: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        Chat: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
        Paperclip: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>,
        Send: () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
    };

    // =================================================================
    //  React Components
    // =================================================================
    
    function App() {
      const [currentUser, setCurrentUser] = React.useState(null);

      if (!currentUser) {
        return <LoginScreen onLogin={(user) => {
            setCurrentUser(user);
            logActivityToSheet('userLogin', { customerId: user.id, customerName: user.name });
        }} />;
      }

      return <DashboardScreen user={currentUser} onLogout={() => setCurrentUser(null)} />;
    }
    
    function LoginScreen({ onLogin }) {
      const [phone, setPhone] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [error, setError] = React.useState('');

      const handleLogin = (e) => {
        e.preventDefault();
        const foundUser = MOCK_CUSTOMERS.find(c => c.phone.replace(/-/g, '') === phone.replace(/-/g, ''));
        if (foundUser && password === '×¡×‘×Ÿ') {
          setError('');
          onLogin(foundUser);
        } else {
          setError('××¡×¤×¨ × ×™×™×“ ××• ×¡×™×¡××” ×©×’×•×™×™×.');
        }
      };

      return (
        <div className="flex items-center justify-center min-h-screen login-bg">
          <div className="absolute inset-0 bg-black opacity-60"></div>
          <div className="relative bg-white/10 backdrop-blur-lg p-8 rounded-2xl shadow-2xl text-center w-full max-w-md text-white border border-white/20">
            <img src="https://placehold.co/150x50/FFFFFF/000000?text=×œ×•×’×•+×—.×¡×‘×Ÿ" alt="Saban Logo" className="mx-auto mb-6"/>
            <h1 className="text-2xl font-bold mb-2">×‘×¨×•×›×™× ×”×‘××™×</h1>
            <p className="text-gray-300 mb-8">×”×–×× ×•×ª 24/7 ×‘×›×£ ×™×“×š</p>
            <form onSubmit={handleLogin} className="space-y-4">
              <input
                type="tel"
                value={phone}
                onChange={(e) => setPhone(e.target.value)}
                placeholder="××¡×¤×¨ × ×™×™×“"
                className="w-full bg-white/20 border-white/30 rounded-lg p-3 text-center text-white placeholder-gray-300 focus:ring-2 focus:ring-amber-400 focus:outline-none"
                required
              />
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder='×¡×™×¡××” (×‘×¨×™×¨×ª ××—×“×œ: "×¡×‘×Ÿ")'
                className="w-full bg-white/20 border-white/30 rounded-lg p-3 text-center text-white placeholder-gray-300 focus:ring-2 focus:ring-amber-400 focus:outline-none"
                required
              />
              {error && <p className="text-red-400 text-sm">{error}</p>}
              <button type="submit" className="w-full bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-3 rounded-lg transition-transform transform hover:scale-105">
                ×›× ×™×¡×”
              </button>
            </form>
          </div>
        </div>
      );
    }

    function DashboardScreen({ user, onLogout }) {
        const [view, setView] = React.useState('dashboard');
        const greeting = React.useMemo(() => getGreetingMessage(), []);

        const navigateTo = (newView) => {
            setView(newView);
            if(newView === 'chat') {
                logActivityToSheet('chatView', { customerId: user.id, customerName: user.name });
            }
        };

        return (
            <div className="bg-gray-100 min-h-screen">
                <header className="bg-white shadow-sm p-4 flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        <img src={user.avatar} alt="User Avatar" className="w-12 h-12 rounded-full border-2 border-indigo-500"/>
                        <div>
                            <h1 className="font-bold text-lg text-gray-800">{greeting.text.replace('{name}', user.name.split(' ')[0])} {greeting.emoji}</h1>
                            <p className="text-sm text-gray-500">××—×•×‘×¨ ×›: {user.name}</p>
                        </div>
                    </div>
                    <button onClick={onLogout} className="text-gray-500 hover:text-indigo-600">×”×ª× ×ª×§×•×ª</button>
                </header>

                <main className="p-6">
                    {view === 'dashboard' && (
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <DashboardButton icon={<Icons.Chat />} label="×¦'××˜ ×•×”×–×× ×” ×—×“×©×”" onClick={() => navigateTo('chat')} />
                            <DashboardButton icon={<Icons.Building />} label="×—×•××¨×™ ×‘× ×™×™×Ÿ" onClick={() => navigateTo('chat')} />
                            <DashboardButton icon={<Icons.Container />} label="××›×•×œ×•×ª" onClick={() => navigateTo('chat')} />
                            <DashboardButton icon={<Icons.History />} label="×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª" onClick={() => alert('×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª ×ª×”×™×” ×–××™× ×” ×‘×§×¨×•×‘!')} />
                        </div>
                    )}
                    {view === 'chat' && <ChatScreen user={user} onBack={() => setView('dashboard')} />}
                </main>
            </div>
        );
    }

    const DashboardButton = ({ icon, label, onClick }) => (
        <button onClick={onClick} className="bg-white p-6 rounded-xl shadow-md text-center text-gray-700 font-semibold hover:shadow-xl hover:bg-indigo-500 hover:text-white transition-all duration-300 transform hover:-translate-y-1">
            <div className="mx-auto mb-2">{icon}</div>
            {label}
        </button>
    );

    function ChatScreen({ user, onBack }) {
        const [messages, setMessages] = React.useState([]);
        const [inputText, setInputText] = React.useState('');
        const [isTyping, setIsTyping] = React.useState(false);
        const messagesEndRef = React.useRef(null);

        React.useEffect(() => {
            setIsTyping(true);
            setTimeout(() => {
                const welcomeMsg = MOCK_CHAT_TEMPLATES.welcome[Math.floor(Math.random() * MOCK_CHAT_TEMPLATES.welcome.length)].replace('{name}', user.name.split(' ')[0]);
                const welcomeMessageObject = { sender: 'bot', text: welcomeMsg, type: 'text' };
                setMessages([welcomeMessageObject]);
                setIsTyping(false);
                logActivityToSheet('chatMessage', {
                    customerId: user.id,
                    customerName: user.name,
                    sender: 'bot',
                    message: welcomeMsg
                });
            }, 1500);
        }, [user.name, user.id]);

        React.useEffect(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [messages, isTyping]);
        
        const handleSendMessage = async () => {
            if (inputText.trim() === '') return;

            const userMessage = { sender: 'user', text: inputText, type: 'text' };
            setMessages(prev => [...prev, userMessage]);
            setInputText('');
            setIsTyping(true);
            
            logActivityToSheet('chatMessage', {
                customerId: user.id,
                customerName: user.name,
                sender: 'user',
                message: inputText
            });

            setTimeout(() => {
                const lines = userMessage.text.split('\n').filter(l => l.trim().length > 1);
                if(lines.length > 1) {
                    const confirmationMsg = MOCK_CHAT_TEMPLATES.order_confirmation[0];
                    const parsedItems = lines.map(line => {
                        const match = line.match(/(\d+)/);
                        const quantity = match ? parseInt(match[1], 10) : 1;
                        const name = line.replace(/(\d+)/, '').trim();
                        return { name, quantity };
                    });
                    const summaryText = parsedItems.map(p => `- ${p.quantity} x ${p.name}`).join('\n');
                    const summaryMsg = MOCK_CHAT_TEMPLATES.summary[0].replace('{items}', `\n${summaryText}`);
                    
                    const botMsg1 = { sender: 'bot', text: confirmationMsg, type: 'text' };
                    const botMsg2 = { sender: 'bot', text: summaryMsg, type: 'order_summary', items: parsedItems };

                    setMessages(prev => [...prev, botMsg1, botMsg2]);

                    logActivityToSheet('chatMessage', { customerId: user.id, customerName: user.name, sender: 'bot', message: confirmationMsg });
                    logActivityToSheet('chatMessage', { customerId: user.id, customerName: user.name, sender: 'bot', message: `×¡×™×›×•× ×”×–×× ×”:\n${summaryText}` });


                } else {
                    const botReply = { sender: 'bot', text: "×§×™×‘×œ×ª×™. ××™×š ×× ×™ ×™×›×•×œ ×œ×”××©×™×š ××›××Ÿ?", type: 'text' };
                    setMessages(prev => [...prev, botReply]);
                    logActivityToSheet('chatMessage', { customerId: user.id, customerName: user.name, sender: 'bot', message: botReply.text });
                }
                setIsTyping(false);
            }, 2000);
        };
        
        const handleOrderApproval = async (items) => {
            setIsTyping(true);
            setMessages(prev => [...prev, { sender: 'bot', type: 'progress', text: "×™×•×¦×¨ ×”×–×× ×” ×•×©×•×œ×— ×œ××¢×¨×›×ª..." }]);
            
            await new Promise(r => setTimeout(r, 2000));
            
            const orderId = `SBN-${Date.now()}`;
            const finalMessage = `×”×–×× ×” ${orderId.slice(-6)} × ×•×¦×¨×” ×‘×”×¦×œ×—×”! âœ…\n\n×¤×¨×˜×™ ×”×”×–×× ×” × ×©××¨×• ×‘××¢×¨×›×ª.\n×ª×•×“×” ×©×‘×—×¨×ª ×‘× ×•!`;

            setMessages(prev => prev.filter(m => m.type !== 'progress'));
            setMessages(prev => [...prev, { sender: 'bot', text: finalMessage, type: 'text' }]);
            setIsTyping(false);
            
            logActivityToSheet('newOrder', { 
                customerId: user.id,
                customerName: user.name,
                orderId: orderId,
                items: JSON.stringify(items)
            });
        };

        return (
            <div className="flex flex-col h-[calc(100vh-150px)] bg-white rounded-lg shadow-xl">
                 <header className="p-3 border-b flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <img src={user.avatar} alt="User Avatar" className="w-10 h-10 rounded-full"/>
                        <div>
                            <p className="font-semibold">{user.name}</p>
                            <p className="text-xs text-green-500">×–××™×Ÿ</p>
                        </div>
                    </div>
                    <button onClick={onBack} className="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </header>
                
                <div className="flex-1 overflow-y-auto p-4 space-y-4 whatsapp-bg">
                    {messages.map((msg, index) => (
                        <div key={index} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                            {msg.type === 'order_summary' ? (
                                <div className="bg-white rounded-lg p-3 max-w-lg shadow-md border border-gray-200">
                                   <p className="mb-3 whitespace-pre-wrap font-sans">{msg.text}</p>
                                   <button onClick={() => handleOrderApproval(msg.items)} className="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">
                                       ××™×©×•×¨ ×•×¡×™×•× ×”×–×× ×”
                                    </button>
                                </div>
                            ) : msg.type === 'progress' ? (
                                <div className="bg-white rounded-lg p-3 max-w-lg shadow-md w-full text-center">
                                    <p>{msg.text}</p>
                                    <div className="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                      <div className="bg-blue-600 h-2.5 rounded-full animate-pulse" style={{width: '100%'}}></div>
                                    </div>
                                </div>
                            ) : (
                                 <div className={`p-3 rounded-lg max-w-lg ${msg.sender === 'user' ? 'bg-green-100' : 'bg-white shadow-sm'}`}>
                                    <p className="whitespace-pre-wrap">{msg.text}</p>
                                </div>
                            )}
                        </div>
                    ))}
                    {isTyping && (
                        <div className="flex justify-start">
                            <div className="bg-white shadow-sm p-3 rounded-lg">
                                <div className="flex items-center gap-1">
                                    <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                                    <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></span>
                                    <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></span>
                                </div>
                            </div>
                        </div>
                    )}
                    <div ref={messagesEndRef} />
                </div>

                <div className="p-3 bg-gray-100 border-t flex items-center gap-2">
                    <button className="text-gray-500 p-2 hover:bg-gray-200 rounded-full"><Icons.Paperclip /></button>
                    <textarea
                        value={inputText}
                        onChange={(e) => setInputText(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSendMessage())}
                        placeholder="×”×§×œ×“ ×”×–×× ×” ××• ×”×“×‘×§ ×›××Ÿ ×¨×©×™××”..."
                        rows="1"
                        className="flex-1 bg-white p-3 rounded-full border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                    />
                    <button onClick={handleSendMessage} className="bg-green-500 text-white p-3 rounded-full hover:bg-green-600 transition-colors"><Icons.Send /></button>
                </div>
            </div>
        );
    }

    // =================================================================
    //  Render the App
    // =================================================================
    ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
