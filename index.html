<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שער הזמנות</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- PWA Manifest and Service Worker would be added here for full PWA functionality -->
    <style>
        body {
            font-family: 'Rubik', sans-serif;
        }
        /* Helper class to hide elements */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="max-w-lg mx-auto bg-white min-h-screen shadow-lg">

        <!-- ===== Login Screen ===== -->
        <div id="login-screen" class="p-8 flex flex-col items-center justify-center h-screen">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">שער הזמנות</h1>
            <p class="text-gray-600 mb-8">זיהוי לקוח או הזמנה קיימת</p>
            <input type="tel" id="login-input" placeholder="הכנס מספר טלפון / לקוח / הזמנה" class="w-full p-4 border border-gray-300 rounded-lg text-center text-lg focus:ring-2 focus:ring-blue-500 transition">
            <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg mt-4 hover:bg-blue-700 transition-transform transform hover:scale-105">
                כניסה / חיפוש
            </button>
        </div>

        <!-- ===== Dashboard Screen ===== -->
        <div id="dashboard-screen" class="hidden">
            <header class="bg-gray-800 text-white p-4 flex justify-between items-center">
                <h1 class="text-xl font-bold">ניהול הזמנות</h1>
                <button id="logout-btn" class="text-sm">התנתק</button>
            </header>
            <main class="p-4">
                <div class="mb-4">
                    <input type="search" id="search-orders" placeholder="חיפוש מהיר..." class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="grid grid-cols-3 gap-2 text-center mb-4">
                     <div class="bg-blue-100 text-blue-800 p-3 rounded-lg">
                        <div class="font-bold text-2xl" id="new-orders-count">0</div>
                        <div>חדשות</div>
                    </div>
                    <div class="bg-yellow-100 text-yellow-800 p-3 rounded-lg">
                        <div class="font-bold text-2xl" id="pending-orders-count">0</div>
                        <div>בטיפול</div>
                    </div>
                    <div class="bg-green-100 text-green-800 p-3 rounded-lg">
                        <div class="font-bold text-2xl" id="today-orders-count">0</div>
                        <div>היום</div>
                    </div>
                </div>
                
                <div id="orders-list" class="space-y-3">
                    <!-- Order cards will be injected here -->
                </div>
            </main>
            <div class="fixed bottom-4 right-4 z-10" style="left: 50%; transform: translateX(-50%); max-width: calc(100% - 2rem); width: calc(500px - 2rem);">
                 <button id="new-order-btn" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg shadow-xl hover:bg-blue-700 transition-transform transform hover:scale-105 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    הזמנה חדשה
                </button>
            </div>
        </div>

        <!-- ===== Order Screen ===== -->
        <div id="order-screen" class="hidden">
             <header class="bg-gray-800 text-white p-4 flex justify-between items-center sticky top-0 z-10">
                <button id="back-to-dashboard-btn" class="text-xl">→</button>
                <h1 id="order-title" class="text-xl font-bold">הזמנה חדשה</h1>
                <div class="w-8"></div>
            </header>
            <main class="p-4 pb-20">
                <!-- Smart Paste Section -->
                <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-dashed border-gray-400">
                    <label for="smart-paste-area" class="block text-lg font-semibold text-gray-700 mb-2">הדבקה חכמה מ-WhatsApp</label>
                    <textarea id="smart-paste-area" rows="6" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="הדבק כאן את תוכן ההודעה..."></textarea>
                    <button id="parse-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg mt-2 hover:bg-indigo-700 transition">נתח טקסט ומלא טופס</button>
                </div>

                <!-- Order Form -->
                <form id="order-form" class="space-y-4">
                    <input type="hidden" id="order-id">
                    
                    <div>
                        <label for="client-name" class="block font-medium text-gray-700">שם לקוח / פרויקט*</label>
                        <input type="text" id="client-name" class="w-full mt-1 p-2 border border-gray-300 rounded-lg" required>
                    </div>
                     <div>
                        <label for="contact-phone" class="block font-medium text-gray-700">טלפון איש קשר בשטח*</label>
                        <input type="tel" id="contact-phone" class="w-full mt-1 p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="delivery-address" class="block font-medium text-gray-700">כתובת אספקה*</label>
                        <input type="text" id="delivery-address" class="w-full mt-1 p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="delivery-date" class="block font-medium text-gray-700">תאריך אספקה*</label>
                        <input type="date" id="delivery-date" class="w-full mt-1 p-2 border border-gray-300 rounded-lg" required>
                    </div>

                    <!-- Items Section -->
                    <div class="border-t pt-4">
                         <h3 class="text-lg font-semibold text-gray-800">פריטים</h3>
                         <div id="items-container" class="space-y-2 mt-2">
                             <!-- Item rows will be injected here -->
                         </div>
                         <button type="button" id="add-item-btn" class="mt-2 text-blue-600 font-semibold">+ הוסף פריט</button>
                    </div>
                    
                    <div>
                        <label for="notes" class="block font-medium text-gray-700">הערות</label>
                        <textarea id="notes" rows="3" class="w-full mt-1 p-2 border border-gray-300 rounded-lg"></textarea>
                    </div>
                </form>
            </main>
             <footer class="fixed bottom-0 bg-white border-t p-3 grid grid-cols-2 gap-3" style="max-width: 512px; width: 100%;">
                <button id="save-order-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition">שמור הזמנה</button>
                <button id="share-whatsapp-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition flex items-center justify-center" disabled>
                     <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 ml-2" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.586-1.456l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.803 6.283l-.52 1.905 1.973-.518zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                     שתף ב-WhatsApp
                </button>
            </footer>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // State Management
            let state = {
                loggedIn: false,
                currentScreen: 'login', // 'login', 'dashboard', 'order'
                orders: [], // This will hold our orders data
                nextOrderId: 1001,
                currentOrder: null // Order being edited or created
            };

            // DOM Elements
            const screens = {
                login: document.getElementById('login-screen'),
                dashboard: document.getElementById('dashboard-screen'),
                order: document.getElementById('order-screen')
            };
            const loginInput = document.getElementById('login-input');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const newOrderBtn = document.getElementById('new-order-btn');
            const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
            const ordersList = document.getElementById('orders-list');
            const orderTitle = document.getElementById('order-title');
            const orderForm = document.getElementById('order-form');
            const saveOrderBtn = document.getElementById('save-order-btn');
            const shareWhatsappBtn = document.getElementById('share-whatsapp-btn');
            
            // Smart Paste elements
            const smartPasteArea = document.getElementById('smart-paste-area');
            const parseBtn = document.getElementById('parse-btn');

            // --- Core Functions ---

            function navigateTo(screenName) {
                state.currentScreen = screenName;
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[screenName]) {
                    screens[screenName].classList.remove('hidden');
                }
            }

            function init() {
                // Load mock data and set initial state
                loadMockData();
                renderDashboard();
                navigateTo('login');
            }
            
            function loadMockData() {
                state.orders = [
                    { id: 1001, clientName: "זבולון עדירן", deliveryAddress: "השקד 2, רשפון", deliveryDate: "2025-10-15", status: "New", contactPhone: "0538224169", items: [{name: 'מלט שחור', qty: 5}, {name: 'קלקר 5/100/50', qty: 3}] },
                    { id: 1002, clientName: "רותם כחילה", deliveryAddress: "אבא קובנר 6, כפר סבא", deliveryDate: "2025-10-16", status: "Pending", contactPhone: "0524811575", items: [{name: 'בטון ב 30', qty: 8}] },
                ];
                state.nextOrderId = 1003;
            }

            // --- Rendering Functions ---

            function renderDashboard() {
                ordersList.innerHTML = '';
                if (state.orders.length === 0) {
                    ordersList.innerHTML = `<p class="text-center text-gray-500">אין הזמנות להצגה.</p>`;
                } else {
                    state.orders.slice().reverse().forEach(order => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:border-blue-500';
                        card.dataset.orderId = order.id;
                        
                        const statusColors = {
                            New: 'bg-blue-500',
                            Pending: 'bg-yellow-500',
                            Confirmed: 'bg-green-500',
                        };
                        
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-lg">${order.clientName}</p>
                                    <p class="text-sm text-gray-600">${order.deliveryAddress}</p>
                                    <p class="text-sm text-gray-500">#${order.id} - ${new Date(order.deliveryDate).toLocaleDateString('he-IL')}</p>
                                </div>
                                <span class="text-white text-xs font-semibold px-2 py-1 rounded-full ${statusColors[order.status] || 'bg-gray-500'}">${order.status}</span>
                            </div>
                        `;
                        card.addEventListener('click', () => handleEditOrder(order.id));
                        ordersList.appendChild(card);
                    });
                }
                // Update counts
                document.getElementById('new-orders-count').textContent = state.orders.filter(o => o.status === 'New').length;
                document.getElementById('pending-orders-count').textContent = state.orders.filter(o => o.status === 'Pending').length;
            }

            function renderOrderForm(order) {
                state.currentOrder = order;
                orderForm.reset();
                smartPasteArea.value = '';
                
                document.getElementById('order-id').value = order ? order.id : '';
                document.getElementById('client-name').value = order ? order.clientName : '';
                document.getElementById('contact-phone').value = order ? order.contactPhone : '';
                document.getElementById('delivery-address').value = order ? order.deliveryAddress : '';
                document.getElementById('delivery-date').value = order ? order.deliveryDate : new Date().toISOString().split('T')[0];
                document.getElementById('notes').value = order ? order.notes : '';

                renderItems(order ? order.items : []);

                orderTitle.textContent = order ? `עריכת הזמנה #${order.id}` : 'הזמנה חדשה';
                shareWhatsappBtn.disabled = !order; // Enable share only for saved orders
                navigateTo('order');
            }

            function renderItems(items) {
                const container = document.getElementById('items-container');
                container.innerHTML = '';
                if (items && items.length > 0) {
                    items.forEach((item, index) => {
                         createItemRow(item.name, item.qty);
                    });
                } else {
                     createItemRow(); // Start with one empty row
                }
            }
            
            function createItemRow(name = '', qty = '') {
                 const container = document.getElementById('items-container');
                 const itemRow = document.createElement('div');
                 itemRow.className = 'grid grid-cols-12 gap-2 items-center';
                 itemRow.innerHTML = `
                    <input type="text" placeholder="שם מוצר" value="${name}" class="col-span-7 p-2 border border-gray-300 rounded-lg item-name">
                    <input type="number" placeholder="כמות" value="${qty}" class="col-span-3 p-2 border border-gray-300 rounded-lg item-qty">
                    <button type="button" class="col-span-2 text-red-500 font-bold text-2xl remove-item-btn">×</button>
                 `;
                 container.appendChild(itemRow);
            }

            // --- Event Handlers ---

            loginBtn.addEventListener('click', () => {
                if (loginInput.value.trim() !== '') {
                    state.loggedIn = true;
                    renderDashboard();
                    navigateTo('dashboard');
                }
            });
            
            logoutBtn.addEventListener('click', () => {
                state.loggedIn = false;
                loginInput.value = '';
                navigateTo('login');
            });

            newOrderBtn.addEventListener('click', () => renderOrderForm(null));
            backToDashboardBtn.addEventListener('click', () => navigateTo('dashboard'));

            document.getElementById('items-container').addEventListener('click', (e) => {
                if(e.target.classList.contains('remove-item-btn')) {
                    e.target.closest('.grid').remove();
                }
            });
            
            document.getElementById('add-item-btn').addEventListener('click', () => createItemRow());
            
            saveOrderBtn.addEventListener('click', handleSaveOrder);
            
            shareWhatsappBtn.addEventListener('click', handleShareToWhatsapp);

            parseBtn.addEventListener('click', handleParseText);
            
            function handleEditOrder(orderId) {
                const order = state.orders.find(o => o.id === orderId);
                if(order) {
                    renderOrderForm(order);
                }
            }

            function handleSaveOrder() {
                const id = document.getElementById('order-id').value;
                const items = [];
                document.querySelectorAll('#items-container .grid').forEach(row => {
                    const name = row.querySelector('.item-name').value.trim();
                    const qty = row.querySelector('.item-qty').value.trim();
                    if(name && qty) {
                        items.push({ name, qty });
                    }
                });

                const orderData = {
                    clientName: document.getElementById('client-name').value.trim(),
                    contactPhone: document.getElementById('contact-phone').value.trim(),
                    deliveryAddress: document.getElementById('delivery-address').value.trim(),
                    deliveryDate: document.getElementById('delivery-date').value,
                    notes: document.getElementById('notes').value.trim(),
                    items: items,
                    status: 'New' // default status
                };
                
                // Basic validation
                if (!orderData.clientName || !orderData.contactPhone || !orderData.deliveryAddress || !orderData.deliveryDate) {
                    alert('נא למלא את כל שדות החובה (*)');
                    return;
                }

                if (id) { // Update existing order
                    const index = state.orders.findIndex(o => o.id == id);
                    if (index > -1) {
                        state.orders[index] = { ...state.orders[index], ...orderData };
                    }
                } else { // Create new order
                    orderData.id = state.nextOrderId++;
                    state.orders.push(orderData);
                }
                
                // Mock saving to Google Sheets
                console.log("Saving order:", orderData);
                
                renderDashboard();
                navigateTo('dashboard');
            }

            function handleShareToWhatsapp() {
                if (!state.currentOrder) return;
                
                const order = state.currentOrder;
                let message = `*הזמנה חדשה #${order.id}*\n\n`;
                message += `*לקוח:* ${order.clientName}\n`;
                message += `*כתובת:* ${order.deliveryAddress}\n`;
                message += `*איש קשר:* ${order.contactPhone}\n`;
                message += `*תאריך אספקה:* ${new Date(order.deliveryDate).toLocaleDateString('he-IL')}\n\n`;
                message += `*פירוט:*\n`;
                order.items.forEach(item => {
                    message += `- ${item.name} (כמות: ${item.qty})\n`;
                });
                if(order.notes) {
                    message += `\n*הערות:* ${order.notes}`;
                }
                
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }

            // --- Text Parsing Logic (MVP) ---
            function handleParseText() {
                const text = smartPasteArea.value;
                if (!text.trim()) return;

                const parsedData = {
                    clientName: '',
                    contactPhone: '',
                    deliveryAddress: '',
                    items: []
                };

                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                // Rule 1: First line often contains project, address, contact
                if (lines.length > 0) {
                    const firstLine = lines[0];
                    
                    // Extract phone number
                    const phoneRegex = /05\d-?\d{7}/;
                    const phoneMatch = firstLine.match(phoneRegex);
                    if (phoneMatch) {
                        parsedData.contactPhone = phoneMatch[0];
                    }
                    
                    // Simple address/name parsing (can be improved)
                    let remainingText = firstLine.replace(phoneRegex, '').trim();
                    // Assume name is before number
                    const contactNameRegex = new RegExp(`([א-ת\\s]+)(?=\\s*${parsedData.contactPhone})`);
                    const nameMatch = remainingText.match(contactNameRegex);
                    if (nameMatch) {
                         // This is often not just the name but the address part too
                         remainingText = remainingText.replace(nameMatch[0], '').trim();
                    }
                    parsedData.deliveryAddress = remainingText.replace(/,/g, ' ').trim();
                }

                // Rule 2: Lines starting with a number are items
                const itemRegex = /^(?:\d+\.?\s*)(.*?)(?:(?:x|×)\s*(\d+)|כמות:?\s*(\d+)).*$/i;
                lines.forEach(line => {
                    const match = line.match(itemRegex);
                    if (match) {
                        const name = match[1].trim();
                        const qty = match[2] || match[3] || '1'; // Default to 1 if not found
                        parsedData.items.push({ name, qty });
                    }
                });

                // Apply parsed data to form
                document.getElementById('contact-phone').value = parsedData.contactPhone;
                document.getElementById('delivery-address').value = parsedData.deliveryAddress;
                // A more complex logic is needed for client name, for now, we leave it to the user.
                
                renderItems(parsedData.items);
                
                alert('הטקסט נותח. אנא בדוק והשלם את הפרטים החסרים.');
            }

            // --- Initialise the App ---
            init();
        });
    </script>
</body>
</html>
