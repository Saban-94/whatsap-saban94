<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> .住</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { background: #f4f6f8; padding-bottom: 250px; }
        .sidebar { background: #263238; color: white; min-height: 100vh; padding: 20px; }
        .news-studio { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; border-top: 2px solid #008069; z-index: 2000; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); display: flex; gap: 20px; }
        .color-btn { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .selected { border-color: black; transform: scale(1.1); }
        .bg-b { background: #0078d4; } .bg-r { background: #d32f2f; } .bg-g { background: #2e7d32; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar">
            <h4></h4>
            <br>
            <div><i class="material-icons">dvr</i>  </div>
        </div>
        <div class="col-md-10 p-4">
            <div class="d-flex justify-content-between">
                <h3> 转</h3>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModal" onclick="resetForm()">+ 砖</button>
            </div>
            <div class="card mt-3 p-3 border-0 shadow-sm">
                <table class="table">
                    <thead><tr><th># 转注</th><th>拽</th><th></th><th>转转</th><th>驻注转</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="news-studio">
    <div style="width: 400px;">
        <h6> 注专 砖转 住</h6>
        <input id="news-in" class="form-control mb-2" placeholder="拽 注..." oninput="upd()">
        <div class="d-flex gap-2 mb-2">
            <div class="color-btn bg-b selected" onclick="setC('blue',this)"></div>
            <div class="color-btn bg-r" onclick="setC('red',this)"></div>
            <div class="color-btn bg-g" onclick="setC('green',this)"></div>
            <select id="icon-in" class="form-select form-select-sm" style="width:100px;" onchange="upd()">
                <option value="campaign"></option><option value="warning">锔</option><option value="celebration"></option>
            </select>
        </div>
        <button class="btn btn-dark w-100" onclick="sendNews()">注 住</button>
    </div>
    <div style="flex:1; background:#eee; padding:10px; border-radius:8px;">
        <small>转爪 拽:</small>
        <div id="prev-bar" style="background:#0078d4; color:white; padding:10px; margin-top:5px; border-radius:4px; display:flex; align-items:center; gap:10px;">
            <i class="material-icons" id="prev-ic">campaign</i><b id="prev-tit">注</b> | <span id="prev-txt">...</span>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">注专/住驻</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <form id="frm">
        <input type="hidden" id="eid">
        <div class="row">
            <div class="col-6 mb-2"><label>住驻专 转注/</label><input type="text" id="e-oid" class="form-control" placeholder="1025"></div>
            <div class="col-6 mb-2"><label>砖 拽</label><input type="text" id="e-name" class="form-control" required></div>
        </div>
        <div class="mb-2"><label>转转  ( 驻!)</label><input type="text" id="e-addr" class="form-control" placeholder="注专, 专 住驻专"></div>
        <div class="row">
            <div class="col-6 mb-2"><label>砖 </label><input type="text" id="e-drv" class="form-control"></div>
            <div class="col-6 mb-2"><label>住</label><select id="e-typ" class="form-select"><option>祝 10 专</option><option> 8 拽</option><option>砖转 专</option></select></div>
        </div>
        <div class="row">
            <div class="col-6"><label>转专</label><input type="date" id="e-date" class="form-control"></div>
            <div class="col-6"><label>砖注</label><input type="time" id="e-time" class="form-control"></div>
        </div>
        <button class="btn btn-success w-100 mt-3">砖专</button>
    </form>
</div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, setDoc, doc, onSnapshot, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const db = getFirestore(initializeApp({ apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60", projectId: "app-saban94-57361", appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa" }));
    let orders=[], col='blue';

    // 砖转
    window.setC=(c,el)=>{ col=c; document.querySelectorAll('.color-btn').forEach(b=>b.classList.remove('selected')); el.classList.add('selected'); upd(); };
    window.upd=()=>{
        const t=document.getElementById('news-in').value, i=document.getElementById('icon-in').value;
        const p=document.getElementById('prev-bar');
        document.getElementById('prev-txt').innerText=t; document.getElementById('prev-ic').innerText=i;
        p.style.background = col==='red'?'#d32f2f':col==='green'?'#2e7d32':'#0078d4';
        document.getElementById('prev-tit').innerText = col==='red'?'专':col==='green'?'注':'注';
    };
    window.sendNews=async()=>{
        let typ='info', tit='注'; if(col==='red'){typ='alert';tit='专';} if(col==='green'){typ='success';tit='注';}
        await setDoc(doc(db,"settings","news"), { text:document.getElementById('news-in').value, icon:document.getElementById('icon-in').value, type:typ, title:tit });
        alert('注!');
    };

    // 转
    onSnapshot(query(collection(db,"users"),orderBy("lastUpdate","desc")), s=>{
        document.getElementById('table-body').innerHTML=''; orders=[];
        s.forEach(d=>{
            const o=d.data(); o.id=d.id; orders.push(o);
            if(o.status!==4) document.getElementById('table-body').innerHTML += `<tr><td>${o.orgId||'-'}</td><td><b>${o.name}</b></td><td>${o.driverName||'-'}</td><td>${o.address||'<b class="text-danger">住专!</b>'}</td><td><button class="btn btn-sm btn-outline-primary" onclick="ed('${o.id}')">注专</button> <button class="btn btn-sm btn-success" onclick="ok('${o.id}')">住驻拽</button></td></tr>`;
        });
    });

    window.resetForm=()=>{ document.getElementById('frm').reset(); document.getElementById('eid').value=''; };
    window.ed=(id)=>{
        const o=orders.find(x=>x.id===id);
        document.getElementById('eid').value=id; document.getElementById('e-oid').value=o.orgId||'';
        document.getElementById('e-name').value=o.name; document.getElementById('e-addr').value=o.address||'';
        document.getElementById('e-drv').value=o.driverName||''; document.getElementById('e-typ').value=o.deliveryType;
        document.getElementById('e-time').value=o.targetTime||'';
        new bootstrap.Modal(document.getElementById('editModal')).show();
    };
    document.getElementById('frm').onsubmit=async(e)=>{
        e.preventDefault(); const id=document.getElementById('eid').value;
        const d={ orgId:document.getElementById('e-oid').value, name:document.getElementById('e-name').value, address:document.getElementById('e-addr').value, driverName:document.getElementById('e-drv').value, deliveryType:document.getElementById('e-typ').value, targetTime:document.getElementById('e-time').value, lastUpdate:new Date() };
        if(id) await updateDoc(doc(db,"users",id),d); else { d.status=1; await addDoc(collection(db,"users"),d); }
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    };
    window.ok=async(id)=>updateDoc(doc(db,"users",id),{status:4});
</script>
</body>
</html>
