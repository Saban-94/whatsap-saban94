<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.住 -  + 住</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { background-color: #f4f6f8; font-family: 'Segoe UI', sans-serif; padding-bottom: 250px; /* 拽 驻 转转 */ }
        .sidebar { background: #263238; min-height: 100vh; color: white; padding: 20px; }
        .nav-link { color: #b0bec5; cursor: pointer; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { background: #37474f; color: white; }
        .nav-link i { font-size: 20px; }
        
        .main-content { padding: 30px; }
        .card-custom { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); background: white; }
        
        /* --- 住 注转 (转转) --- */
        .news-studio {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid #ddd;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            padding: 15px; z-index: 2000;
            display: flex; gap: 20px; align-items: flex-start;
        }
        
        .preview-box {
            flex: 1; background: #f0f2f5; border-radius: 8px; padding: 15px;
            display: flex; flex-direction: column; gap: 10px; border: 1px dashed #ccc;
        }
        .ticker-preview {
            background: #0078d4; color: white; padding: 10px 15px; border-radius: 4px;
            display: flex; align-items: center; gap: 10px; font-weight: 500;
        }
        .ticker-preview.alert { background: #d32f2f; }
        .ticker-preview.success { background: #2e7d32; }
        
        .tools-box { width: 400px; display: flex; flex-direction: column; gap: 10px; }
        .color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; }
        .color-btn.selected { border-color: #333; transform: scale(1.1); }
        .bg-blue { background: #0078d4; } .bg-red { background: #d32f2f; } .bg-green { background: #2e7d32; }

    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar">
            <h4 class="mb-4 text-center fw-bold">注专转 </h4>
            <div class="nav-link active" onclick="switchTab('live')"><i class="material-icons">dvr</i>  </div>
            <div class="nav-link" onclick="switchTab('history')"><i class="material-icons">history</i> 专</div>
        </div>

        <div class="col-md-10 main-content">
            <div id="tab-live">
                <div class="d-flex justify-content-between mb-3">
                    <h3>  转</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModal" onclick="resetForm()">
                        <i class="material-icons" style="vertical-align:middle">add</i> 砖
                    </button>
                </div>
                <div class="card card-custom p-3">
                    <table class="table">
                        <thead><tr><th>拽</th><th>住</th><th></th><th>砖注</th><th>驻注转</th></tr></thead>
                        <tbody id="live-table"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="tab-history" style="display:none;">
                <h3> 专</h3>
                <div class="card card-custom p-3">
                    <table class="table table-striped"><tbody id="history-table"></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="news-studio">
    <div class="tools-box">
        <h6 style="margin:0;"><i class="material-icons" style="font-size:16px; vertical-align:middle;">palette</i> 住 注转 住</h6>
        
        <input type="text" id="studio-text" class="form-control" placeholder="拽 转 注 ..." oninput="updatePreview()">
        
        <div class="d-flex align-items-center gap-2">
            <span style="font-size:0.9rem;">爪注:</span>
            <div class="color-btn bg-blue selected" onclick="setColor('blue', this)"></div>
            <div class="color-btn bg-red" onclick="setColor('red', this)"></div>
            <div class="color-btn bg-green" onclick="setColor('green', this)"></div>
            
            <span style="font-size:0.9rem; margin-right:10px;">拽:</span>
            <select id="studio-icon" class="form-select form-select-sm" style="width:120px;" onchange="updatePreview()">
                <option value="campaign"> 专</option>
                <option value="cake">  转</option>
                <option value="warning">锔 专</option>
                <option value="celebration"> </option>
                <option value="info">癸 注</option>
            </select>
        </div>
        
        <button class="btn btn-dark w-100" onclick="publishNews()">
            <i class="material-icons" style="vertical-align:middle">send</i> 砖 住
        </button>
    </div>

    <div class="preview-box">
        <small class="text-muted">转爪 拽 (  专 ):</small>
        <div id="ticker-preview" class="ticker-preview">
            <i class="material-icons" id="prev-icon">campaign</i>
            <span id="prev-title" style="background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px;">注</span>
            <span id="prev-text">拽 注...</span>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"></h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="orderForm"><input type="hidden" id="edit-id"><div class="mb-3"><label>拽</label><input type="text" id="in-name" class="form-control" required></div><div class="mb-3"><label>住</label><select id="in-type" class="form-select"><option>祝 10 专</option><option>祝 15 专</option><option>砖转 专</option><option> 8 拽</option></select></div><div class="row"><div class="col-6"><label></label><input type="text" id="in-driver" class="form-control"></div><div class="col-6"><label>砖注</label><input type="time" id="in-time" class="form-control"></div></div><button type="submit" class="btn btn-primary w-100 mt-3">砖专</button></form></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, setDoc, doc, onSnapshot, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60", projectId: "app-saban94-57361", appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let allOrders = [];
    let selectedColor = 'blue';

    // --- 拽转 住 ---
    window.setColor = (color, btn) => {
        selectedColor = color;
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        updatePreview();
    };

    window.updatePreview = () => {
        const text = document.getElementById('studio-text').value || "拽 注...";
        const icon = document.getElementById('studio-icon').value;
        const prev = document.getElementById('ticker-preview');
        
        document.getElementById('prev-text').innerText = text;
        document.getElementById('prev-icon').innerText = icon;
        
        prev.className = 'ticker-preview'; // Reset
        if(selectedColor === 'red') prev.classList.add('alert');
        if(selectedColor === 'green') prev.classList.add('success');
        
        // 转专转
        let title = "注";
        if(selectedColor === 'red') title = "专";
        if(selectedColor === 'green') title = "注 砖转";
        document.getElementById('prev-title').innerText = title;
    };

    window.publishNews = async () => {
        const text = document.getElementById('studio-text').value;
        if(!text) return alert(", 转转 砖!");
        
        let type = 'info';
        if(selectedColor === 'red') type = 'alert';
        if(selectedColor === 'green') type = 'success';
        
        let title = document.getElementById('prev-title').innerText;

        await setDoc(doc(db, "settings", "news"), {
            text: text,
            icon: document.getElementById('studio-icon').value,
            type: type,
            title: title,
            timestamp: new Date()
        });
        alert("注 砖专 爪 住! ");
    };

    // ---  转 (专) ---
    const q = query(collection(db, "users"), orderBy("lastUpdate", "desc"));
    onSnapshot(q, (snap) => {
        const live = document.getElementById('live-table');
        const hist = document.getElementById('history-table');
        live.innerHTML = ''; hist.innerHTML = '';
        allOrders = [];

        snap.forEach(docSnap => {
            const d = docSnap.data(); d.id = docSnap.id; allOrders.push(d);
            const row = document.createElement('tr');
            
            if(d.status === 4) {
                row.innerHTML = `<td>${d.targetDate||'-'}</td><td>${d.name}</td><td>${d.deliveryType}</td><td>${d.driverName||'-'}</td>
                <td><button class="btn btn-sm btn-outline-danger" onclick="window.del('${d.id}')"><i class="material-icons">delete</i></button></td>`;
                hist.appendChild(row);
            } else {
                row.innerHTML = `<td><b>${d.name}</b></td><td>${d.deliveryType}</td><td>${d.driverName||'-'}</td><td class="text-success fw-bold">${d.targetTime||''}</td>
                <td><button class="btn btn-sm btn-primary" onclick="window.edit('${d.id}')">注专</button> <button class="btn btn-sm btn-success" onclick="window.done('${d.id}')">住驻拽</button></td>`;
                live.appendChild(row);
            }
        });
    });

    // 驻拽爪转 注专 转
    window.switchTab = (t) => {
        document.getElementById('tab-live').style.display = t==='live'?'block':'none';
        document.getElementById('tab-history').style.display = t==='history'?'block':'none';
    };
    window.resetForm = () => { document.getElementById('orderForm').reset(); document.getElementById('edit-id').value=''; };
    window.edit = (id) => {
        const o = allOrders.find(x=>x.id===id);
        document.getElementById('edit-id').value=id; document.getElementById('in-name').value=o.name;
        document.getElementById('in-type').value=o.deliveryType; document.getElementById('in-driver').value=o.driverName||'';
        document.getElementById('in-time').value=o.targetTime||'';
        new bootstrap.Modal(document.getElementById('editModal')).show();
    };
    document.getElementById('orderForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const d = { name:document.getElementById('in-name').value, deliveryType:document.getElementById('in-type').value, driverName:document.getElementById('in-driver').value, targetTime:document.getElementById('in-time').value, lastUpdate:new Date() };
        if(id) await updateDoc(doc(db,"users",id), d);
        else { d.status=1; await addDoc(collection(db,"users"), d); }
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    };
    window.done = async (id) => updateDoc(doc(db,"users",id), {status:4});
    window.del = async (id) => { if(confirm('拽?')) deleteDoc(doc(db,"users",id)); };

</script>
</body>
</html>
