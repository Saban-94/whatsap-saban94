const SS_ID = "1e9gAjJA4e1MY4pATx1wVsx1IJZoD4jzKkcnHRvZKv5s";
const DRIVE_FOLDER_ID = "1AWl10eAyTLOzNSp3LibtScDeH_SQKNZj";

// --- Caching variables for performance ---
let catalogCache = null;

// Helper function to get sheet by name
function getSheet(name) {
    try {
        const ss = SpreadsheetApp.openById(SS_ID);
        return ss.getSheetByName(name);
    } catch (e) {
        Logger.log(`Error getting sheet "${name}": ${e}`);
        return null;
    }
}

// Helper to convert sheet data to array of objects
function sheetToObjects(sheet) {
    if (!sheet) return [];
    const data = sheet.getDataRange().getValues();
    const headers = data.shift();
    if(!headers) return [];
    return data.map(row => {
        let obj = {};
        headers.forEach((header, i) => {
            if(header) { // Only add property if header is not empty
               obj[header.trim()] = row[i];
            }
        });
        return obj;
    });
}


function doPost(e) {
  try {
    const body = JSON.parse(e.postData.contents);
    let result;

    switch (body.action) {
      // --- NEW ENDPOINT FOR PRODUCT CATALOG ---
      case 'getProductCatalog': result = getProductCatalog(); break;

      // Existing endpoints...
      case 'getDashboardData': result = getDashboardData(); break;
      case 'createOrderFromText': result = createOrderFromText(body.text, body.clientId, body.confirmed); break;
      case 'analyzeMessage': result = analyzeMessage(body.text, body.clientId); break;
      // ... other cases
      default: throw new Error(`פעולה לא מוכרת: ${body.action}`);
    }
    
    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log(`Error in doPost: ${error.toString()} \nStack: ${error.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * NEW FUNCTION
 * Fetches the entire product catalog from the Google Sheet.
 * Uses caching to avoid reading the sheet on every single request for massive performance boost.
 */
function getProductCatalog() {
  if (catalogCache) {
    Logger.log("Returning product catalog from cache.");
    return { success: true, catalog: catalogCache };
  }

  Logger.log("Fetching product catalog from sheet...");
  const sheet = getSheet("קטלוג מוצרים");
  if (!sheet) {
    return { success: false, error: "גיליון קטלוג המוצרים לא נמצא." };
  }
  
  const catalogData = sheetToObjects(sheet);
  
  // Clean and structure the data for the client-side app
  const cleanedCatalog = catalogData.map(product => ({
    sku: product['מק"ט'] || '',
    name: product['שם מוצר'] || 'ללא שם',
    category: product['קטגוריה'] || 'כללי',
    description: product['תיאור'] || '',
    image: product['תמונה'] || 'https://placehold.co/400x300/e2e8f0/64748b?text=אין+תמונה',
    keywords: product['כינויים'] || ''
  })).filter(p => p.sku && p.name !== 'ללא שם'); // Filter out empty or invalid products

  catalogCache = cleanedCatalog; // Store in cache for next time
  Logger.log(`Successfully loaded and cached ${cleanedCatalog.length} products.`);
  
  return { success: true, catalog: cleanedCatalog };
}


// =============================================================
// Placeholder for your other existing functions
// =============================================================
function getDashboardData() { /* ... your existing code ... */ return { orders: [] };}
function createOrderFromText(text, clientId, confirmed) { /* ... your existing code ... */ return { success: true };}
function analyzeMessage(text, clientId) { /* ... your existing code ... */ return { success: true }; }

