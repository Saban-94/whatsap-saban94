<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×—.×¡×‘×Ÿ - ××¡×š ×©×™×“×•×¨ ×œ×•×’×™×¡×˜×™</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { margin: 0; background: #e0e0e0; font-family: 'Rubik', sans-serif; overflow: hidden; }

        /* --- ×›×•×ª×¨×ª --- */
        .map-header {
            position: absolute; top: 20px; right: 20px; z-index: 500;
            background: rgba(255,255,255,0.95); padding: 10px 25px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-left: 5px solid #008069;
            display: flex; align-items: center; gap: 15px;
        }

        #map { width: 100vw; height: 100vh; }

        /* --- 1. ×¨×©×™××ª "×¡×•×¤×§×• ×”×™×•×" (×¦×“ ×©×××œ + ×’×œ×™×œ×”) --- */
        .completed-panel {
            position: absolute; bottom: 20px; left: 20px; /* ×¢×‘×¨ ×œ×¦×“ ×©×××œ */
            z-index: 500;
            width: 320px; height: 35vh; /* ×’×•×‘×” ×§×‘×•×¢ ×›×“×™ ×œ××¤×©×¨ ×’×œ×™×œ×” */
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
            display: flex; flex-direction: column;
            overflow: hidden; /* ××¡×ª×™×¨ ××ª ××” ×©×™×•×¦× ××”××¡×’×¨×ª */
        }
        
        .panel-header {
            background: #263238; color: white; padding: 12px;
            font-size: 1rem; font-weight: bold; text-align: center;
            z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ××™×›×œ ×”×’×œ×™×œ×” */
        .marquee-container {
            flex: 1; position: relative; overflow: hidden;
        }

        /* ×”×ª×•×›×Ÿ ×©×–×– */
        .marquee-content {
            position: absolute; width: 100%;
            animation: scrollUp 20s linear infinite; /* ××”×™×¨×•×ª ×”×’×œ×™×œ×” */
        }
        
        /* ×× ×”×¨×©×™××” ×§×¦×¨×”, ×œ× ×¦×¨×™×š ×× ×™××¦×™×” (JS ×™×˜×¤×œ ×‘×–×”, ××‘×œ ×–×” ×”×“×™×¤×•×œ×˜) */
        @keyframes scrollUp {
            0% { transform: translateY(100%); }
            100% { transform: translateY(-100%); } 
        }

        .completed-item {
            background: #fff; border-bottom: 1px solid #eee;
            padding: 10px; margin: 5px 10px;
            border-radius: 6px; border-right: 4px solid #4caf50;
            display: flex; justify-content: space-between; align-items: center;
        }
        .c-name { font-weight: bold; font-size: 0.95rem; color: #333; }
        .c-desc { font-size: 0.8rem; color: #666; }

        /* --- 2. ×¤×•×¤-××¤ "××§×“×•× ×œ×“×¡" (Big Alert Overlay) --- */
        .big-alert-overlay {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            z-index: 2000;
            display: none; /* ××•×¡×ª×¨ ×›×‘×¨×™×¨×ª ××—×“×œ */
            flex-direction: column; align-items: center;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .alert-card {
            background: #fff; width: 500px; text-align: center;
            border-radius: 20px; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            border: 4px solid #fff;
        }

        .alert-header {
            background: #d32f2f; color: white; padding: 15px;
            font-size: 1.5rem; font-weight: 900;
            animation: flashHeader 1s infinite alternate;
        }
        
        .alert-body { padding: 30px; }
        .alert-client { font-size: 2.5rem; font-weight: 900; color: #333; margin-bottom: 10px; line-height: 1; }
        .alert-type { font-size: 1.5rem; color: #666; background: #eee; display: inline-block; padding: 5px 15px; border-radius: 50px; margin-bottom: 20px; }
        .alert-timer { font-size: 4rem; font-weight: 900; color: #d32f2f; font-family: monospace; letter-spacing: -2px; }
        .alert-address { margin-top: 15px; font-size: 1.1rem; color: #555; border-top: 1px solid #eee; padding-top: 10px; }

        @keyframes popIn { from { transform: translateX(-50%) scale(0.5); opacity: 0; } to { transform: translateX(-50%) scale(1); opacity: 1; } }
        @keyframes flashHeader { from { background: #d32f2f; } to { background: #b71c1c; } }

        /* --- 3. ×”×’×“×¨×•×ª ×¡×™×›×•×ª (CSS PINS) --- */
        /* ×›××Ÿ ××ª×” ××›× ×™×¡ ××ª ×”×œ×™× ×§×™× ×©×œ×š ×œ×ª××•× ×•×ª */
        
        .custom-pin-icon {
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }

        /* ×”×—×œ×£ ××ª ×”-URL ×‘×œ×™× ×§×™× ×”×××™×ª×™×™× ×©×œ×š */
        .pin-crane { 
            background-image: url('https://cdn-icons-png.flaticon.com/512/2329/2329113.png'); /* ×œ×™× ×§ ×œ×× ×•×£ */
            border-color: #fbc02d; 
        }
        .pin-truck { 
            background-image: url('https://cdn-icons-png.flaticon.com/512/2555/2555013.png'); /* ×œ×™× ×§ ×œ××©××™×ª */
            border-color: #2196f3;
        }
        .pin-container { 
            background-image: url('https://cdn-icons-png.flaticon.com/512/9333/9333994.png'); /* ×œ×™× ×§ ×œ××›×•×œ×” */
            border-color: #ff9800;
        }
        .pin-default { 
            background-image: url('https://cdn-icons-png.flaticon.com/512/664/664468.png'); 
        }

        /* ×× ×™××¦×™×” ×œ×¡×™×›×” ×“×—×•×¤×” */
        .pin-urgent {
            border-color: #ff3b30 !important;
            animation: bouncePin 1s infinite;
        }
        @keyframes bouncePin { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    </style>
</head>
<body>

    <div class="map-header">
        <div style="font-weight:900; font-size:1.2rem; color:#008069;">
            <i class="material-icons" style="vertical-align:middle;">tv</i> ×—.×¡×‘×Ÿ ON-AIR
        </div>
        <div style="border-right:1px solid #ccc; height:20px; margin:0 15px;"></div>
        <div id="active-count" style="font-weight:bold; color:#555;">×˜×•×¢×Ÿ...</div>
    </div>

    <div id="map"></div>

    <div id="big-alert" class="big-alert-overlay">
        <div class="alert-card">
            <div class="alert-header">ğŸš¨ ×”×–×× ×” ×§×¨×™×˜×™×ª</div>
            <div class="alert-body">
                <div class="alert-client" id="ba-client">×™×©×¨××œ ×™×©×¨××œ×™</div>
                <div class="alert-type" id="ba-type">×× ×•×£ 10 ××˜×¨</div>
                <div class="alert-timer" id="ba-timer">00:14:59</div>
                <div class="alert-address" id="ba-addr">×”×¨×¦×œ 50, ×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ</div>
            </div>
        </div>
    </div>

    <div class="completed-panel">
        <div class="panel-header">âœ… ×”×•×©×œ××• ×”×™×•× (<span id="comp-count">0</span>)</div>
        <div class="marquee-container">
            <div class="marquee-content" id="completed-list">
                </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60",
            authDomain: "app-saban94-57361.firebaseapp.com",
            projectId: "app-saban94-57361",
            storageBucket: "app-saban94-57361.firebasestorage.app",
            messagingSenderId: "275366913167",
            appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ××¤×”
        const map = L.map('map', { zoomControl: false }).setView([32.3215, 34.8532], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        const markersLayer = L.layerGroup().addTo(map);
        const geoCache = {};

        // ××©×ª× ×™× ×œ× ×™×”×•×œ ×”×¤×•×¤-××¤ ×”××ª×—×œ×£
        let criticalOrders = [];
        let alertIndex = 0;
        let alertInterval = null;

        async function getCoords(address) {
            if (!address) return null;
            if (geoCache[address]) return geoCache[address];
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Israel')}&limit=1`);
                const data = await res.json();
                if (data.length > 0) {
                    const c = { lat: data[0].lat, lon: data[0].lon };
                    geoCache[address] = c;
                    return c;
                }
            } catch (e) {}
            return null;
        }

        function getMinutesLeft(date, time) {
            if(!time) return 999;
            const now = new Date();
            let target = date ? new Date(date) : new Date();
            const [h, m] = time.split(':');
            target.setHours(h, m, 0, 0);
            return Math.floor((target - now) / 60000);
        }

        // ×¤×•× ×§×¦×™×” ×œ×‘×—×™×¨×ª CSS Class ×œ×¤×™ ×¡×•×’ (×¢×‘×•×¨ ×”×ª××•× ×•×ª)
        function getPinClass(type) {
            if(!type) return 'pin-default';
            if(type.includes('×× ×•×£')) return 'pin-crane';
            if(type.includes('××›×•×œ×”')) return 'pin-container';
            if(type.includes('××©××™×ª')) return 'pin-truck';
            return 'pin-default';
        }

        // × ×™×”×•×œ ×”×¨×•×˜×¦×™×” ×©×œ ×”×”×ª×¨××•×ª (××§×“×•× ×œ×“×¡)
        function updateAlertRotation() {
            const overlay = document.getElementById('big-alert');
            
            // ×× ××™×Ÿ ×”×–×× ×•×ª ×§×¨×™×˜×™×•×ª - ×¡×’×•×¨
            if (criticalOrders.length === 0) {
                overlay.style.display = 'none';
                return;
            }

            // ×”×¦×’ ××ª ×”×”×–×× ×” ×”× ×•×›×—×™×ª ×‘×ª×•×¨
            const order = criticalOrders[alertIndex];
            overlay.style.display = 'flex';
            
            document.getElementById('ba-client').innerText = order.name;
            document.getElementById('ba-type').innerText = order.deliveryType;
            document.getElementById('ba-addr').innerText = order.address;
            
            // ×¢×“×›×•×Ÿ ×˜×™×™××¨ ×—×™ ×‘×¤×•×¤-××¤
            const min = order.minutesLeft;
            const sign = min < 0 ? '-' : '';
            const absMin = Math.abs(min);
            const h = Math.floor(absMin / 60);
            const m = absMin % 60;
            document.getElementById('ba-timer').innerText = `${sign}${h < 10 ? '0'+h : h}:${m < 10 ? '0'+m : m}:00`;

            // ×§×™×“×•× ×”××™× ×“×§×¡ ×œ×¤×¢× ×”×‘××” (×¨×•×˜×¦×™×”)
            alertIndex = (alertIndex + 1) % criticalOrders.length;
        }

        // ×”×ª×—×œ×ª ×”×¨×•×˜×¦×™×” (×›×œ 5 ×©× ×™×•×ª ××—×œ×™×£ ×”×–×× ×”)
        setInterval(updateAlertRotation, 5000);

        // --- Snapshot ×¨××©×™ ---
        const q = query(collection(db, "users"));
        onSnapshot(q, async (snap) => {
            markersLayer.clearLayers();
            criticalOrders = []; // ××™×¤×•×¡ ×¨×©×™××ª ×“×—×•×¤×™×

            const compList = document.getElementById('completed-list');
            compList.innerHTML = ''; 
            
            let active = 0;
            let completed = 0;
            const bounds = [];

            const promises = snap.docs.map(async docSnap => {
                const d = docSnap.data();

                // 1. ×˜×™×¤×•×œ ×‘×”×–×× ×•×ª ×©×¡×•×¤×§×• (×¨×©×™××” × ×’×œ×œ×ª)
                if (d.status === 4) {
                    completed++;
                    const row = document.createElement('div');
                    row.className = 'completed-item';
                    row.innerHTML = `
                        <div>
                            <div class="c-name">${d.name}</div>
                            <div class="c-desc">${d.deliveryType}</div>
                        </div>
                        <i class="material-icons" style="color:#4caf50;">check_circle</i>
                    `;
                    compList.appendChild(row);
                    return;
                }

                // 2. ×˜×™×¤×•×œ ×‘×”×–×× ×•×ª ×¤×¢×™×œ×•×ª (××¤×”)
                if (!d.address) return;
                active++;
                const coords = await getCoords(d.address);

                if (coords) {
                    const minutesLeft = getMinutesLeft(d.targetDate, d.targetTime);
                    const isUrgent = minutesLeft < 30; // ××ª×—×ª ×œ×—×¦×™ ×©×¢×” ×–×” ×“×—×•×£
                    
                    // ×”×•×¡×¤×” ×œ×¨×©×™××ª ×”×“×—×•×¤×™× ×× ×¨×œ×•×•× ×˜×™
                    if (isUrgent || d.isUrgent) {
                        criticalOrders.push({ ...d, minutesLeft });
                    }

                    // ×™×¦×™×¨×ª ×”×¡×™×›×” ×¢× ×”-CSS ×©×œ×š
                    const pinClass = getPinClass(d.deliveryType);
                    const urgentClass = (isUrgent || d.isUrgent) ? 'pin-urgent' : '';
                    
                    const icon = L.divIcon({
                        className: `custom-pin-icon ${pinClass} ${urgentClass}`,
                        iconSize: [60, 60],
                        iconAnchor: [30, 30]
                    });

                    L.marker([coords.lat, coords.lon], { icon: icon }).addTo(markersLayer);
                    bounds.push([coords.lat, coords.lon]);
                }
            });

            await Promise.all(promises);
            
            document.getElementById('active-count').innerText = active;
            document.getElementById('comp-count').innerText = completed;
            
            // ×¢×“×›×•×Ÿ ×’×•×‘×” ×× ×™××¦×™×™×ª ×”×’×œ×™×œ×” ×œ×¤×™ ×›××•×ª ×”×¤×¨×™×˜×™×
            const contentHeight = compList.scrollHeight;
            const containerHeight = document.querySelector('.marquee-container').clientHeight;
            // ×× ×™×© ××¡×¤×™×§ ×ª×•×›×Ÿ ×œ×’×œ×™×œ×”, ×¢×“×›×Ÿ ××ª ××©×š ×”×× ×™××¦×™×”
            if (contentHeight > containerHeight) {
                compList.style.animationDuration = `${contentHeight / 20}s`; // ×”×ª×××ª ××”×™×¨×•×ª
            } else {
                compList.style.animation = 'none'; // ×‘×˜×œ ×’×œ×™×œ×” ×× ×§×¦×¨
            }

            if (bounds.length) map.fitBounds(bounds, { padding: [80, 80] });
        });

    </script>
</body>
</html>
