<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.住 - 驻转 砖 (专)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; background: #f5f5f5; font-family: 'Rubik', sans-serif; overflow: hidden; }
        
        /* 注爪 转专转 爪驻 (专) */
        .map-header {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); /*  爪 砖拽祝 */
            padding: 15px 25px; border-radius: 12px;
            color: #333; /* 拽住  */
            border: 1px solid #ddd;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); /* 爪 注 */
            backdrop-filter: blur(5px);
            min-width: 250px;
        }
        .header-title { margin: 0; font-weight: 700; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        .stats { font-size: 0.9rem; color: #666; margin-top: 5px; font-weight: 500; }
        .live-indicator { display: inline-block; width: 12px; height: 12px; background: #00c853; border-radius: 50%; box-shadow: 0 0 0 3px rgba(0, 200, 83, 0.2); }

        /* 驻 转驻住转 转  住 */
        #map { width: 100vw; height: 100vh; background: #e0e0e0; }

        /* 注爪 注转 注 (Popup) - 专 */
        .leaflet-popup-content-wrapper { 
            background: #ffffff; 
            color: #333; 
            border-radius: 10px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            padding: 5px;
        }
        .leaflet-popup-tip { background: #ffffff; }
        .popup-title { font-weight: 700; font-size: 1.1rem; color: #008069; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .popup-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 0.95rem; color: #444; }
        
        /* 转转 住住 */
        .chip { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .st-1 { background: #2196f3; } /* 转 -  */
        .st-2 { background: #fbc02d; color: #333; } /* 驻 - 爪 */
        .st-3 { background: #4caf50; } /* 专 - 专拽 */
        .st-urgent { background: #f44336; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* 爪 住转 */
        .custom-pin { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .custom-pin:hover { transform: scale(1.15) translateY(-5px); z-index: 1000 !important; }
    </style>
</head>
<body>

    <div class="map-header">
        <h2 class="header-title"><span class="live-indicator"></span> .住 住拽</h2>
        <div class="stats" id="status-text">注专转 转专转...</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 专转 Firebase 砖 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60",
            authDomain: "app-saban94-57361.firebaseapp.com",
            projectId: "app-saban94-57361",
            storageBucket: "app-saban94-57361.firebasestorage.app",
            messagingSenderId: "275366913167",
            appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa",
            measurementId: "G-E297QYKZKQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 转 驻 (专住 专) ---
        const map = L.map('map', {
            zoomControl: false // 住转专 转 驻住/住 专 拽 (驻砖专 专  专爪)
        }).setView([32.3215, 34.8532], 12); // 专 专专转  (转)

        // 砖砖 驻转 CartoDB Positron (驻 专 拽 )
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // 驻拽爪 爪专转 拽 住
        const createIcon = (type, color) => {
            let iconShape = 'local_shipping'; // 砖转 专专转 
            if(type && type.includes('祝')) iconShape = 'construction';
            if(type && type.includes('')) iconShape = 'delete_outline';

            return L.divIcon({
                className: 'custom-pin',
                html: `<div style="
                    background-color: ${color};
                    width: 40px; height: 40px;
                    border-radius: 50% 50% 50% 0; /* 爪专转 驻 */
                    transform: rotate(-45deg);
                    display: flex; justify-content: center; align-items: center;
                    border: 3px solid white; /* 住专转  转 */
                    box-shadow: 0 3px 10px rgba(0,0,0,0.3);">
                    <span class="material-icons" style="
                        font-size: 22px; 
                        color: white; 
                        transform: rotate(45deg);">
                        ${iconShape}
                    </span>
                </div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40], // 拽爪 转转 砖 住
                popupAnchor: [0, -45]
            });
        };

        // Cache 专
        const geoCache = {}; 
        const markersLayer = L.layerGroup().addTo(map);

        // --- 砖专转 专转 转转 (Geocoding) ---
        async function getCoords(address) {
            if (!address) return null;
            if (geoCache[address]) return geoCache[address]; // 砖驻 专

            try {
                // 住驻转 'Israel' 驻砖 拽 转专
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Israel')}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const coords = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                    geoCache[address] = coords;
                    return coords;
                }
            } catch (e) {
                console.error("Geocoding error:", address);
            }
            return null;
        }

        // ---  转  转 ---
        const q = query(collection(db, "users"));
        
        onSnapshot(q, async (snapshot) => {
            markersLayer.clearLayers();
            let activeCount = 0;
            const bounds = [];

            const promises = snapshot.docs.map(async (docSnap) => {
                const d = docSnap.data();
                
                // 专拽 转 驻注转 注 转转
                if (d.status >= 4 || !d.address) return;

                activeCount++;
                const coords = await getCoords(d.address);
                
                if (coords) {
                    // 专转 爪注 驻 住住
                    let color = '#2196f3'; // 
                    let statusTxt = '转 砖抓';
                    
                    if (d.status == 2) { color = '#fbc02d'; statusTxt = '驻'; }
                    if (d.status == 3) { color = '#4caf50'; statusTxt = '爪 专'; }
                    if (d.isUrgent) { color = '#f44336'; statusTxt = '祝!'; }

                    const marker = L.marker([coords.lat, coords.lon], {
                        icon: createIcon(d.deliveryType, color)
                    });

                    // 转 注
                    const popupContent = `
                        <div class="popup-title">${d.name}</div>
                        <div class="popup-row">
                            <span class="chip" style="background:${color}">${statusTxt}</span>
                            ${d.isUrgent ? '<span class="chip st-urgent"></span>' : ''}
                        </div>
                        <div class="popup-row"><i class="material-icons" style="font-size:16px;color:#777;">category</i> ${d.deliveryType || ' 爪'}</div>
                        <div class="popup-row"><i class="material-icons" style="font-size:16px;color:#777;">location_on</i> ${d.address}</div>
                        ${d.notes ? `<div style="margin-top:5px; padding:5px; background:#ffebee; color:#d32f2f; border-radius:4px; font-size:0.85rem;">${d.notes}</div>` : ''}
                    `;

                    marker.bindPopup(popupContent);
                    markersLayer.addLayer(marker);
                    bounds.push([coords.lat, coords.lon]);
                }
            });

            await Promise.all(promises);

            // 注 转专转
            document.getElementById('status-text').innerText = activeCount > 0 ? 
                `爪 ${activeCount} 转 驻注转` : ' 转 驻注转 专注';

            // 专 驻 转  砖 住转
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [80, 80], maxZoom: 15 });
            }
        });

    </script>
</body>
</html>
