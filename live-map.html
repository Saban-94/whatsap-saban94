<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.住 - 拽专转 砖 (爪)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { margin: 0; background: #263238; font-family: 'Rubik', sans-serif; overflow: hidden; }

        /* 转专转 */
        .map-header {
            position: absolute; top: 20px; right: 20px; z-index: 500;
            background: rgba(255,255,255,0.95); padding: 10px 25px; border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 2px solid #008069;
            display: flex; align-items: center; gap: 15px;
        }

        #map { width: 100vw; height: 100vh; filter: brightness(1.1); }

        /* 住拽 (驻转专 转拽转) */
        #debug-console {
            position: absolute; bottom: 10px; right: 10px; z-index: 1000;
            background: rgba(0,0,0,0.8); color: #00e676; padding: 10px;
            font-family: monospace; font-size: 12px; border-radius: 5px;
            pointer-events: none; max-width: 300px;
        }

        /* 专砖转 爪 砖 */
        .completed-panel {
            position: absolute; bottom: 20px; left: 20px; z-index: 500;
            width: 300px; height: 35vh;
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .panel-header {
            background: linear-gradient(135deg, #008069, #004d40); color: white; padding: 15px;
            font-size: 1rem; font-weight: bold; text-align: center;
        }

        .marquee-container { flex: 1; position: relative; overflow: hidden; }
        .marquee-content { position: absolute; width: 100%; top: 0; transition: top 0.5s; }

        .completed-item {
            background: #fff; margin: 8px 12px; padding: 10px;
            border-radius: 8px; border-right: 4px solid #008069;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* 驻驻-驻 注拽 */
        .big-alert-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }

        .alert-card {
            background: #fff; width: 600px; text-align: center;
            border-radius: 30px; overflow: hidden;
            box-shadow: 0 0 100px rgba(255, 59, 48, 0.5);
            border: 6px solid #fff;
            animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .alert-header { background: #ff3b30; color: white; padding: 20px; font-size: 2rem; font-weight: 900; }
        .alert-body { padding: 40px; }
        .alert-client { font-size: 3rem; font-weight: 900; color: #222; margin-bottom: 10px; }
        .alert-timer { font-size: 5rem; font-weight: 900; color: #ff3b30; font-family: monospace; }
        
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* 住转 */
        .pin-wrapper { position: relative; display: flex; justify-content: center; align-items: center; }

        .radar-blip {
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(0, 128, 105, 0.15); border: 1px solid rgba(0, 128, 105, 0.4);
            position: absolute; animation: pulseWave 3s infinite;
        }
        
        .center-icon {
            width: 50px; height: 50px; border-radius: 50%;
            background-color: white; background-size: 60%; background-repeat: no-repeat; background-position: center;
            position: relative; z-index: 2; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 3px solid white;
        }

        /* 拽 */
        .icon-crane { background-image: url('https://cdn-icons-png.flaticon.com/512/2329/2329113.png'); border-color: #fbc02d; }
        .icon-truck { background-image: url('https://saban-94.github.io/whatsap-saban94/track.png'); border-color: #2196f3; }
        .icon-container { background-image: url('https://cdn-icons-png.flaticon.com/512/9333/9333994.png'); border-color: #ff9800; }
        .icon-default { background-image: url('https://cdn-icons-png.flaticon.com/512/664/664468.png'); }

        .floating-sign {
            position: absolute; bottom: 70px; background: white; color: #333;
            padding: 8px 15px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            text-align: center; min-width: 140px; font-weight: bold; border-bottom: 4px solid #008069;
            z-index: 10; animation: floatSign 3s ease-in-out infinite;
        }
        .floating-sign::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; margin-left: -8px;
            border-width: 8px 8px 0; border-style: solid; border-color: #008069 transparent transparent transparent;
        }
        .fs-timer { font-family: monospace; font-size: 1.2rem; color: #008069; font-weight: 900; }

        /* 爪 祝 */
        .pin-wrapper.urgent .radar-blip { background: rgba(255, 59, 48, 0.2); border-color: #ff3b30; animation: pulseWave 1s infinite; }
        .pin-wrapper.urgent .center-icon { border-color: #ff3b30; }
        .pin-wrapper.urgent .floating-sign { border-bottom-color: #ff3b30; }
        .pin-wrapper.urgent .floating-sign::after { border-top-color: #ff3b30; }
        .pin-wrapper.urgent .fs-timer { color: #ff3b30; }

        @keyframes pulseWave { 0% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(2.2); opacity: 0; } }
        @keyframes floatSign { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

    </style>
</head>
<body>

    <div class="map-header">
        <div style="font-weight:900; font-size:1.4rem; color:#008069;">
            <i class="material-icons" style="vertical-align:middle;">flight_takeoff</i> 拽专转 住 - .住
        </div>
        <div style="border-right:1px solid #ccc; height:20px; margin:0 15px;"></div>
        <div id="active-count" style="font-weight:bold; color:#555;">注...</div>
    </div>

    <div id="map"></div>

    <div id="debug-console">转 注专转...</div>

    <div id="big-alert" class="big-alert-overlay">
        <div class="alert-card">
            <div class="alert-header"> 注 转拽专 (5 拽')</div>
            <div class="alert-body">
                <div class="alert-client" id="ba-client">拽</div>
                <div class="alert-type" id="ba-type">住 </div>
                <div class="alert-timer" id="ba-timer">00:05:00</div>
                <div class="alert-address" id="ba-addr">转转</div>
            </div>
        </div>
    </div>

    <div class="completed-panel">
        <div class="panel-header"> 砖 (<span id="comp-count">0</span>)</div>
        <div class="marquee-container">
            <div class="marquee-content" id="completed-list"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, updateDoc, doc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60",
            authDomain: "app-saban94-57361.firebaseapp.com",
            projectId: "app-saban94-57361",
            storageBucket: "app-saban94-57361.firebasestorage.app",
            messagingSenderId: "275366913167",
            appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([32.3215, 34.8532], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        const markersLayer = L.layerGroup().addTo(map);

        // ---  Cache  (砖专 转转 专 驻驻) ---
        //   砖爪 转 驻 注转!
        function getCachedCoord(address) {
            const saved = localStorage.getItem('geo_' + address);
            if(saved) return JSON.parse(saved);
            return null;
        }

        function setCachedCoord(address, coords) {
            localStorage.setItem('geo_' + address, JSON.stringify(coords));
        }

        function logDebug(msg) {
            const el = document.getElementById('debug-console');
            el.innerText = msg;
            console.log(msg);
        }

        async function getCoords(address) {
            if (!address) return null;
            
            // 1. 拽 专 拽
            const cached = getCachedCoord(address);
            if (cached) return cached;

            // 2.   拽, 驻 砖专转 (注 砖 拽 注转 注住)
            try {
                await new Promise(r => setTimeout(r, 1000)); // 砖 转转 砖 砖
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Israel')}&limit=1`);
                if (!res.ok) throw new Error('Network response was not ok');
                const data = await res.json();
                if (data.length > 0) {
                    const c = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                    setCachedCoord(address, c); // 砖专 注转
                    return c;
                } else {
                    logDebug(` 爪 转转: ${address}`);
                }
            } catch (e) {
                logDebug(`砖转 专砖转 转转: ${address}`);
            }
            return null;
        }

        // --- 砖专 拽 (住, 专) ---
        let activeLocations = [];
        let currentFlyIndex = 0;
        let isUserInteracting = false;
        let criticalOrders = [];
        let alertIndex = 0;

        function getSecondsLeft(date, time) {
            if(!time) return 9999;
            const now = new Date();
            let target = date ? new Date(date) : new Date();
            const [h, m] = time.split(':');
            target.setHours(h, m, 0, 0);
            return Math.floor((target - now) / 1000);
        }

        function formatTime(totalSeconds) {
            if (totalSeconds <= 0) return "00:00:00";
            const h = Math.floor(Math.abs(totalSeconds) / 3600);
            const m = Math.floor((Math.abs(totalSeconds) % 3600) / 60);
            const s = Math.abs(totalSeconds) % 60;
            return `${h < 10 ? '0'+h : h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
        }

        function getIconClass(type) {
            if(!type) return 'icon-default';
            if(type.includes('祝')) return 'icon-crane';
            if(type.includes('')) return 'icon-container';
            if(type.includes('砖转')) return 'icon-truck';
            return 'icon-default';
        }

        async function completeOrder(id) {
            try { await updateDoc(doc(db, "users", id), { status: 4 }); } catch (e) {}
        }

        //  住
        setInterval(() => {
            if (activeLocations.length === 0 || isUserInteracting || criticalOrders.length > 0) return;
            const loc = activeLocations[currentFlyIndex];
            if (loc) {
                map.flyTo([loc.lat, loc.lon], 15, { animate: true, duration: 3 });
                currentFlyIndex = (currentFlyIndex + 1) % activeLocations.length;
            }
        }, 12000);

        map.on('mousedown touchstart', () => { isUserInteracting = true; setTimeout(() => isUserInteracting = false, 30000); });

        // 驻驻-驻 转祝
        setInterval(() => {
            const overlay = document.getElementById('big-alert');
            if (criticalOrders.length === 0) {
                overlay.style.display = 'none';
                return;
            }
            const order = criticalOrders[alertIndex];
            overlay.style.display = 'flex';
            document.getElementById('ba-client').innerText = order.name;
            document.getElementById('ba-type').innerText = order.deliveryType;
            document.getElementById('ba-addr').innerText = order.address;
            document.getElementById('ba-timer').innerText = formatTime(order.secondsLeft);
            alertIndex = (alertIndex + 1) % criticalOrders.length;
        }, 5000);

        // 注 专
        setInterval(() => {
            document.querySelectorAll('.fs-timer').forEach(el => {
                const date = el.getAttribute('data-date');
                const time = el.getAttribute('data-time');
                const id = el.getAttribute('data-id');
                const seconds = getSecondsLeft(date, time);
                el.innerText = formatTime(seconds);
                if (seconds <= 0) completeOrder(id);
            });
            if(criticalOrders.length > 0) criticalOrders.forEach(o => o.secondsLeft = getSecondsLeft(o.targetDate, o.targetTime));
        }, 1000);

        //  转
        const q = query(collection(db, "users"));
        onSnapshot(q, async (snap) => {
            //  拽 砖转   注 ,  专拽  砖 砖 专
            markersLayer.clearLayers();
            const compList = document.getElementById('completed-list');
            compList.innerHTML = ''; 

            let activeCount = 0;
            let completedCount = 0;
            let loadedCoords = 0;

            activeLocations = []; 
            criticalOrders = [];
            
            const docs = snap.docs;
            logDebug(`注 ${docs.length} 转...`);

            for (const docSnap of docs) {
                const d = docSnap.data();

                if (d.status === 4) {
                    completedCount++;
                    const row = document.createElement('div');
                    row.className = 'completed-item';
                    row.innerHTML = `<div><div class="c-name">${d.name}</div><div class="c-desc">${d.deliveryType}</div></div>`;
                    compList.appendChild(row);
                    continue;
                }

                if (!d.address) continue;
                activeCount++;
                
                const coords = await getCoords(d.address);
                if (coords) {
                    loadedCoords++;
                    logDebug(`注 ${loadedCoords}/${activeCount} 转转`);
                    
                    activeLocations.push(coords);
                    const seconds = getSecondsLeft(d.targetDate, d.targetTime);
                    const isAlert = seconds < 300; 

                    if (isAlert) criticalOrders.push({ ...d, secondsLeft: seconds });

                    const urgentClass = isAlert ? 'urgent' : '';
                    const iconClass = getIconClass(d.deliveryType);
                    
                    const html = `
                        <div class="pin-wrapper ${urgentClass}">
                            <div class="floating-sign">
                                <div class="fs-name">${d.name}</div>
                                <div class="fs-timer" data-id="${docSnap.id}" data-date="${d.targetDate||''}" data-time="${d.targetTime||''}">--:--</div>
                            </div>
                            <div class="radar-blip"></div>
                            <div class="center-icon ${iconClass}"></div>
                        </div>
                    `;
                    const icon = L.divIcon({ className: 'custom-div', html: html, iconSize: [60, 60], iconAnchor: [30, 30] });
                    L.marker([coords.lat, coords.lon], { icon: icon }).addTo(markersLayer);
                }
            }
            
            document.getElementById('active-count').innerText = activeCount + " 驻注 | " + loadedCoords + " 爪";
            document.getElementById('comp-count').innerText = completedCount;
            logDebug(`住 注. ${loadedCoords} 住转 注 驻.`);

            // 爪转 
            const contentH = compList.scrollHeight;
            if(contentH > 300) {
                let pos = 0;
                if(window.scrInt) clearInterval(window.scrInt);
                window.scrInt = setInterval(() => {
                    pos -= 1;
                    if(Math.abs(pos) >= contentH) pos = 300;
                    compList.style.top = pos + 'px';
                }, 50);
            } else { compList.style.top = '0px'; }
        });
    </script>
</body>
</html>
