<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×—.×¡×‘×Ÿ - ××¤×ª ×©×œ×™×˜×” ×˜×§×˜×™×ª</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { margin: 0; background: #e0e0e0; font-family: 'Rubik', sans-serif; overflow: hidden; }

        /* --- ×›×•×ª×¨×ª ×¢×œ×™×•× ×” --- */
        .map-header {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 10px 25px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-left: 5px solid #008069;
            display: flex; align-items: center; gap: 15px;
        }

        #map { width: 100vw; height: 100vh; }

        /* --- ×¤×™× ×ª ×”×–×× ×•×ª ×©×¡×•×¤×§×• (××¨×›×™×•×Ÿ ×™×•××™) --- */
        .completed-panel {
            position: absolute; bottom: 20px; right: 20px; z-index: 1000;
            width: 600px; max-height: 40vh;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            display: flex; flex-direction: column;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        .panel-header {
            background: #263238; color: white; padding: 10px 15px;
            font-size: 0.95rem; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .completed-list {
            padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
        }
        .completed-item {
            background: #f1f8e9; border-right: 4px solid #4caf50;
            padding: 8px; border-radius: 4px; font-size: 0.85rem;
            animation: slideInRight 0.5s ease-out;
        }
        .c-client { font-weight: bold; color: #333; }
        .c-type { color: #666; font-size: 0.8rem; display: flex; align-items: center; gap: 4px; }

        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- ×¢×™×¦×•×‘ ×¡×™×›×” ×˜×§×˜×™×ª --- */
        .pin-wrapper { position: relative; display: flex; justify-content: center; align-items: center; }

        .radar-blip {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0, 128, 105, 0.2);
            border: 2px solid #008069;
            position: absolute;
            animation: pulseWave 2s infinite;
        }
        
        .center-dot {
            width: 40px; height: 40px; background: white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; position: relative; z-index: 2;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            border: 2px solid white;
        }

        /* ××¦×‘ ×—×™×¨×•× / ××ª×§×¨×‘ ×œ×–××Ÿ */
        .pin-wrapper.urgent .radar-blip {
            background: rgba(255, 59, 48, 0.3);
            border-color: #ff3b30;
            animation: pulseWave 0.8s infinite; /* ×“×•×¤×§ ××”×™×¨ */
        }
        .pin-wrapper.urgent .center-dot { border-color: #ff3b30; }

        @keyframes pulseWave {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        /* --- ×ª×•×•×™×ª "×—×“×©×•×ª ××ª×¤×¨×¦×•×ª" ××¢×œ ×”×¡×™×›×” --- */
        .ticker-label {
            position: absolute; bottom: 50px;
            background: white; color: #333;
            padding: 5px 10px; border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            white-space: nowrap; font-size: 0.85rem; font-weight: bold;
            transform: translateX(-50%); left: 50%;
            border-bottom: 2px solid #008069;
            z-index: 10;
        }
        
        /* ×¢×™×¦×•×‘ ×œ××¦×‘ ×“×—×•×£ (×©×•×¨×” ××”×‘×”×‘×ª) */
        .ticker-label.breaking-news {
            background: #d32f2f; color: white;
            border: none;
            animation: tickerFlash 1s infinite alternate;
            padding: 6px 12px;
            font-size: 0.95rem;
        }

        @keyframes tickerFlash { from { background: #d32f2f; } to { background: #b71c1c; transform: translate(-50%, 0) scale(1.05); } }

    </style>
</head>
<body>

    <div class="map-header">
        <div style="font-weight:900; font-size:1.2rem; color:#008069;">
            <i class="material-icons" style="vertical-align:middle;">radar</i> ×—.×¡×‘×Ÿ ×œ×•×’×™×¡×˜×™×§×”
        </div>
        <div style="border-right:1px solid #ccc; height:20px; margin:0 15px;"></div>
        <div id="active-count" style="font-weight:bold; color:#555;">×˜×•×¢×Ÿ ××¤×”...</div>
    </div>

    <div id="map"></div>

    <div class="completed-panel">
        <div class="panel-header">
            <span>âœ… ×¡×•×¤×§×• ×”×™×•×</span>
            <span id="completed-count" style="background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:10px;">0</span>
        </div>
        <div class="completed-list" id="completed-list-container">
            </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60",
            authDomain: "app-saban94-57361.firebaseapp.com",
            projectId: "app-saban94-57361",
            storageBucket: "app-saban94-57361.firebasestorage.app",
            messagingSenderId: "275366913167",
            appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ××¤×ª ×¨×—×•×‘×•×ª ×‘×”×™×¨×”
        const map = L.map('map', { zoomControl: false }).setView([32.3215, 34.8532], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        const markersLayer = L.layerGroup().addTo(map);
        const geoCache = {};

        async function getCoords(address) {
            if (!address) return null;
            if (geoCache[address]) return geoCache[address];
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Israel')}&limit=1`);
                const data = await res.json();
                if (data.length > 0) {
                    const c = { lat: data[0].lat, lon: data[0].lon };
                    geoCache[address] = c;
                    return c;
                }
            } catch (e) {}
            return null;
        }

        function getEmoji(type) {
            if(!type) return 'ğŸ“¦';
            if(type.includes('×× ×•×£')) return 'ğŸ—ï¸';
            if(type.includes('××›×•×œ×”')) return 'ğŸ—‘ï¸';
            if(type.includes('××©××™×ª')) return 'ğŸšš';
            return 'ğŸ“¦';
        }

        // ×—×™×©×•×‘ ×–××Ÿ ×‘×“×§×•×ª
        function getMinutesRemaining(targetDate, targetTime) {
            if(!targetTime) return 999;
            const now = new Date();
            let target = new Date();
            if(targetDate) target = new Date(targetDate);
            const [h, m] = targetTime.split(':');
            target.setHours(h, m, 0, 0);
            return Math.floor((target - now) / 60000); // ×”×—×–×¨×” ×‘×“×§×•×ª
        }

        // ×”××–× ×” ×¨××©×™×ª
        const q = query(collection(db, "users"));
        onSnapshot(q, async (snap) => {
            markersLayer.clearLayers();
            
            const completedContainer = document.getElementById('completed-list-container');
            completedContainer.innerHTML = ''; // ××™×¤×•×¡ ×¨×©×™××ª ×©×¡×•×¤×§×•

            let activeCount = 0;
            let completedCount = 0;
            const bounds = [];

            const promises = snap.docs.map(async docSnap => {
                const d = docSnap.data();
                
                // --- ×˜×™×¤×•×œ ×‘×”×–×× ×•×ª ×©×¡×•×¤×§×• (×¡×˜×˜×•×¡ 4) ---
                if (d.status === 4) {
                    completedCount++;
                    // ×”×•×¡×¤×” ×œ×¨×©×™××” ×”×¦×“×“×™×ª
                    const item = document.createElement('div');
                    item.className = 'completed-item';
                    item.innerHTML = `
                        <div class="c-client">${d.name} <i class="material-icons" style="font-size:12px; color:green;">check_circle</i></div>
                        <div class="c-type">
                            <span>${d.deliveryType}</span>
                            <span>â€¢ ${d.address ? d.address.split(',')[0] : ''}</span>
                        </div>
                    `;
                    completedContainer.appendChild(item);
                    return;
                }

                // --- ×˜×™×¤×•×œ ×‘×”×–×× ×•×ª ×¤×¢×™×œ×•×ª (×¢×œ ×”××¤×”) ---
                if (!d.address) return;
                activeCount++;
                const coords = await getCoords(d.address);

                if (coords) {
                    const minLeft = getMinutesRemaining(d.targetDate, d.targetTime);
                    const isUrgentTime = minLeft < 60; // ×¤×—×•×ª ××©×¢×” × ×—×©×‘ ×“×—×•×£
                    const isCritical = minLeft < 15; // ×¤×—×•×ª ×-15 ×“×§×•×ª ×–×” ×§×¨×™×˜×™
                    const isOverdue = minLeft < 0;

                    let urgencyClass = '';
                    let labelClass = 'ticker-label';
                    let labelText = `${d.name}`;
                    let subText = d.deliveryType;

                    // ×œ×•×’×™×§×ª ×ª×¦×•×’×” ×œ×¤×™ ×–××Ÿ
                    if (isOverdue) {
                        urgencyClass = 'urgent';
                        labelClass += ' breaking-news';
                        labelText = `âš ï¸ ××™×—×•×¨! ${Math.abs(minLeft)} ×“×§'`;
                    } else if (isCritical) {
                        urgencyClass = 'urgent';
                        labelClass += ' breaking-news';
                        labelText = `â³ ××’×™×¢ ×¢×•×“ ${minLeft} ×“×§'`;
                    } else if (isUrgentTime) {
                        urgencyClass = 'urgent';
                        subText = `× ×•×ª×¨×• ${minLeft} ×“×§'`;
                    }

                    const html = `
                        <div class="pin-wrapper ${urgencyClass}">
                            <div class="${labelClass}">
                                <div>${labelText}</div>
                                ${!isCritical && !isOverdue ? `<div style="font-weight:normal; font-size:0.75em;">${subText}</div>` : ''}
                            </div>
                            <div class="radar-blip"></div>
                            <div class="center-dot">${getEmoji(d.deliveryType)}</div>
                        </div>
                    `;

                    const icon = L.divIcon({
                        className: 'custom-radar-icon',
                        html: html,
                        iconSize: [80, 80],
                        iconAnchor: [40, 40]
                    });

                    L.marker([coords.lat, coords.lon], { icon: icon }).addTo(markersLayer);
                    bounds.push([coords.lat, coords.lon]);
                }
            });

            await Promise.all(promises);
            
            document.getElementById('active-count').innerText = `${activeCount} ×›×œ×™× ×¤×¢×™×œ×™×`;
            document.getElementById('completed-count').innerText = completedCount;
            
            if (bounds.length) map.fitBounds(bounds, { padding: [100, 100] });
        });

    </script>
</body>
</html>
