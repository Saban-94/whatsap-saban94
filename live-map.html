<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.住 - 驻转 爪 </title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; background: #121212; font-family: 'Rubik', sans-serif; overflow: hidden; }
        
        /* Header Overlay */
        .map-header {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(30, 30, 30, 0.9); padding: 15px 25px; border-radius: 12px;
            color: white; border: 1px solid #444; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        .stats { font-size: 0.9rem; color: #aaa; margin-top: 5px; }
        .live-indicator { display: inline-block; width: 10px; height: 10px; background: #00e676; border-radius: 50%; margin-left: 5px; box-shadow: 0 0 8px #00e676; }

        /* The Map */
        #map { width: 100vw; height: 100vh; background: #121212; }

        /* Custom Popup Styles */
        .leaflet-popup-content-wrapper { background: #1e1e1e; color: white; border-radius: 8px; border: 1px solid #444; }
        .leaflet-popup-tip { background: #1e1e1e; }
        .popup-title { font-weight: bold; font-size: 1.1rem; color: #008069; margin-bottom: 5px; }
        .popup-row { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; font-size: 0.9rem; }
        .chip { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; color: #000; }
        .st-1 { background: #34B7F1; } /* 转 */
        .st-2 { background: #fbc02d; } /* 驻 */
        .st-3 { background: #00e676; } /* 专 */

        /* Marker Icons Animation */
        .custom-pin { transition: transform 0.2s; }
        .custom-pin:hover { transform: scale(1.2) translateY(-5px); }
    </style>
</head>
<body>

    <div class="map-header">
        <h2 style="margin:0;"><span class="live-indicator"></span> 驻转 砖 住转</h2>
        <div class="stats" id="status-text">注 转...</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. Firebase Config (砖) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60",
            authDomain: "app-saban94-57361.firebaseapp.com",
            projectId: "app-saban94-57361",
            storageBucket: "app-saban94-57361.firebasestorage.app",
            messagingSenderId: "275366913167",
            appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa",
            measurementId: "G-E297QYKZKQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 2. Map Initialization (Dark Mode) ---
        const map = L.map('map').setView([32.0853, 34.7818], 10); // 专 转  专专转 

        // 砖砖 驻  (CartoDB Dark Matter) - 专 拽爪注 住
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // 拽 转 砖转 (SVG)
        const createIcon = (type, color) => {
            let iconShape = 'local_shipping'; // 砖转
            if(type.includes('祝')) iconShape = 'construction';
            if(type.includes('')) iconShape = 'delete_outline';

            return L.divIcon({
                className: 'custom-pin',
                html: `<div style="
                    background-color: ${color};
                    width: 36px; height: 36px;
                    border-radius: 50%;
                    display: flex; justify-content: center; align-items: center;
                    border: 2px solid white;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
                    <span class="material-icons" style="font-size:20px; color:black;">${iconShape}</span>
                </div>`,
                iconSize: [36, 36],
                iconAnchor: [18, 36],
                popupAnchor: [0, -36]
            });
        };

        // Cache 转转 (  拽砖 砖 砖 转 转 转转)
        const geoCache = {}; 
        const markersLayer = L.layerGroup().addTo(map);

        // --- 3. Geocoding Function (Address -> Lat/Lon) ---
        // 砖转砖 -Nominatim (, 专砖 砖砖 )
        async function getCoords(address) {
            if (!address) return null;
            
            // 拽 专 
            if (geoCache[address]) return geoCache[address];

            try {
                // 驻砖 砖专
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Israel')}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const coords = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                    geoCache[address] = coords; // 砖专 专
                    return coords;
                }
            } catch (e) {
                console.error("Geocoding failed for:", address);
            }
            return null;
        }

        // --- 4. Real-time Listener ---
        const q = query(collection(db, "users"));
        
        onSnapshot(q, async (snapshot) => {
            markersLayer.clearLayers(); // 拽 驻
            let activeCount = 0;
            const bounds = []; //  专 转 驻 住祝

            const processPromises = snapshot.docs.map(async (docSnap) => {
                const d = docSnap.data();
                
                // 住: 专拽 转 驻注转 (住住 1-3)
                if (d.status === 4 || !d.address) return;

                activeCount++;
                
                // 砖转 拽
                const coords = await getCoords(d.address);
                
                if (coords) {
                    let color = '#34B7F1'; //  (砖)
                    let statusTxt = '转';
                    if (d.status == 2) { color = '#fbc02d'; statusTxt = '驻'; } // 爪
                    if (d.status == 3) { color = '#00e676'; statusTxt = '专'; } // 专拽
                    if (d.isUrgent) color = '#ff3b30'; //  (祝)

                    const marker = L.marker([coords.lat, coords.lon], {
                        icon: createIcon(d.deliveryType || '', color)
                    });

                    const popupContent = `
                        <div class="popup-title">${d.name}</div>
                        <div class="popup-row"><span class="chip" style="background:${color}">${statusTxt}</span></div>
                        <div class="popup-row"> ${d.deliveryType}</div>
                        <div class="popup-row"> ${d.address}</div>
                        ${d.notes ? `<div style="color:#ff5252;font-weight:bold;">锔 ${d.notes}</div>` : ''}
                    `;

                    marker.bindPopup(popupContent);
                    markersLayer.addLayer(marker);
                    bounds.push([coords.lat, coords.lon]);
                }
            });

            await Promise.all(processPromises);

            // 注 转专转
            document.getElementById('status-text').innerText = `${activeCount}  驻注 砖`;

            // 专 驻 注  住转
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        });

    </script>
</body>
</html>
