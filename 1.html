<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×—.×¡×‘×Ÿ - ×”×–×× ×” ××”×™×¨×”</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #008069;
            --accent-container: #ff9800; /* ×›×ª×•× ×œ××›×•×œ×•×ª */
            --accent-material: #2196f3; /* ×›×—×•×œ ×œ×—×•××¨×™× */
            --bg: #f0f2f5;
        }
        body { margin: 0; font-family: 'Heebo', sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; }
        
        /* Header */
        .app-header {
            background: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between; z-index: 10;
        }
        .logo-area { display: flex; align-items: center; gap: 10px; font-weight: 900; font-size: 1.2rem; color: var(--primary); }
        
        /* Main Selection Screen */
        .selection-screen {
            flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px;
            justify-content: center; animation: fadeIn 0.5s;
        }
        
        .big-card {
            flex: 1; border-radius: 20px; color: white; padding: 30px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; cursor: pointer; transition: transform 0.2s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); position: relative; overflow: hidden;
        }
        .big-card:active { transform: scale(0.96); }
        .big-card i { font-size: 4rem; margin-bottom: 10px; }
        .big-card h2 { margin: 0; font-size: 1.8rem; }
        
        .card-material { background: linear-gradient(135deg, #42a5f5, #1976d2); }
        .card-container { background: linear-gradient(135deg, #ffa726, #f57c00); }

        /* Forms */
        .form-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 20; transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column;
        }
        .form-container.active { transform: translateY(0); }
        
        .form-header {
            padding: 20px; background: var(--primary); color: white;
            display: flex; align-items: center; gap: 15px; font-size: 1.2rem;
        }
        
        .form-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        .input-group { margin-bottom: 20px; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 0.9rem; }
        .input-field {
            width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 12px;
            font-size: 1rem; font-family: inherit; background: #f9f9f9; box-sizing: border-box;
            transition: 0.3s;
        }
        .input-field:focus { border-color: var(--primary); background: white; outline: none; }
        
        /* Auto-complete list styling */
        datalist { max-height: 200px; overflow: auto; }

        .btn-submit {
            width: 100%; padding: 18px; border: none; border-radius: 12px;
            background: var(--primary); color: white; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; margin-top: 20px; box-shadow: 0 5px 15px rgba(0,128,105,0.3);
        }
        
        .back-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; }
        
        /* Loading Overlay */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9);
            display: none; justify-content: center; align-items: center; z-index: 50; flex-direction: column;
        }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><p style="margin-top:10px;">××¢×‘×“ × ×ª×•× ×™×...</p></div>

    <header class="app-header">
        <div class="logo-area">
            <i class="material-icons" style="color:var(--primary);">architecture</i>
            ×—.×¡×‘×Ÿ ××¢×¨×›×•×ª
        </div>
        <div style="font-size:0.8rem; color:#888;" id="user-type">××•×¨×—</div>
    </header>

    <div class="selection-screen">
        <h1 style="text-align:center; margin:0 0 10px 0;">××” ××–××™× ×™× ×”×™×•×?</h1>
        
        <div class="big-card card-material" onclick="openForm('material')">
            <i class="material-icons">handyman</i>
            <h2>×—×•××¨×™ ×‘× ×™×™×Ÿ</h2>
            <span style="opacity:0.8; font-size:0.9rem;">××œ×˜, ×‘×œ×•×§×™×, ×× ×•×¤×™×</span>
        </div>

        <div class="big-card card-container" onclick="openForm('container')">
            <i class="material-icons">delete_outline</i>
            <h2>××›×•×œ×ª ×¤×¡×•×œ×ª</h2>
            <span style="opacity:0.8; font-size:0.9rem;">×”×¦×‘×”, ×”×—×œ×¤×” ××• ×¤×™× ×•×™</span>
        </div>
    </div>

    <div id="form-material" class="form-container">
        <div class="form-header" style="background: var(--accent-material);">
            <button class="back-btn" onclick="closeForms()"><i class="material-icons">arrow_forward</i></button>
            <span>×”×–×× ×ª ×—×•××¨×™× / ×× ×•×£</span>
        </div>
        <div class="form-body">
            <div class="input-group">
                <label>×©× ×œ×§×•×—</label>
                <input type="text" id="mat-client" class="input-field" list="clients-list" placeholder="×”×ª×—×œ ×œ×”×§×œ×™×“ ×©×..." onchange="autoFillAddress(this.value, 'mat')">
            </div>
            <div class="input-group">
                <label>×›×ª×•×‘×ª ×œ××¡×¤×§×”</label>
                <input type="text" id="mat-addr" class="input-field" placeholder="×¨×—×•×‘, ×¢×™×¨">
            </div>
            <div class="input-group">
                <label>×¡×•×’ ×”×•×‘×œ×”</label>
                <select id="mat-type" class="input-field">
                    <option value="××©××™×ª ×—×•××¨×™×">ğŸš› ×”×•×‘×œ×ª ××©××™×ª (×—×•××¨×™×)</option>
                    <option value="×× ×•×£ 10 ××˜×¨">ğŸ—ï¸ ×× ×•×£ 10 ××˜×¨</option>
                    <option value="×× ×•×£ 15 ××˜×¨">ğŸ—ï¸ ×× ×•×£ 15 ××˜×¨</option>
                    <option value="×¢×‘×•×“×ª ×× ×•×£">ğŸ‘· ×¢×‘×•×“×ª ×× ×•×£ (×œ×¤×™ ×©×¢×”)</option>
                </select>
            </div>
            <div class="input-group">
                <label>×¤×™×¨×•×˜ ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)</label>
                <textarea id="mat-desc" class="input-field" rows="3" placeholder="××” ×œ×”×‘×™×?"></textarea>
            </div>
            <div class="input-group">
                <label>×©×¢×ª ××¡×¤×§×” ××‘×•×§×©×ª</label>
                <input type="time" id="mat-time" class="input-field">
            </div>
            <button class="btn-submit" onclick="submitOrder('material')" style="background: var(--accent-material);">×©×œ×— ×œ×¡×™×“×•×¨</button>
        </div>
    </div>

    <div id="form-container-waste" class="form-container">
        <div class="form-header" style="background: var(--accent-container);">
            <button class="back-btn" onclick="closeForms()"><i class="material-icons">arrow_forward</i></button>
            <span>×”×–×× ×ª ××›×•×œ×”</span>
        </div>
        <div class="form-body">
            <div class="input-group">
                <label>×©× ×œ×§×•×—</label>
                <input type="text" id="cont-client" class="input-field" list="clients-list" placeholder="×‘×—×¨ ×œ×§×•×—..." onblur="checkContainerHistory(this.value)">
                <small style="color:#666;" id="history-hint">××‘×¦×¢ ×‘×“×™×§×ª ×”×™×¡×˜×•×¨×™×”...</small>
            </div>
            <div class="input-group">
                <label>××¡×¤×¨ ×”×–×× ×” (×—×•×‘×”)</label>
                <input type="number" id="cont-num" class="input-field" placeholder="××¡' ×”×–×× ×”">
            </div>
            <div class="input-group">
                <label>×¡×•×’ ×¤×¢×•×œ×”</label>
                <select id="cont-action" class="input-field">
                    <option value="×”×¦×‘×”">â¬‡ï¸ ×”×¦×‘×” (×—×“×©)</option>
                    <option value="×”×—×œ×¤×”">ğŸ”„ ×”×—×œ×¤×” (×¨×™×§ ×ª××•×¨×ª ××œ×)</option>
                    <option value="×”×•×¦××”">â¬†ï¸ ×”×•×¦××” (×¤×™× ×•×™ ×¡×•×¤×™)</option>
                </select>
            </div>
            <div class="input-group">
                <label>×›×ª×•×‘×ª ×”×¦×‘×”/×¤×™× ×•×™</label>
                <input type="text" id="cont-addr" class="input-field" placeholder="××™×§×•× ×”××›×•×œ×”">
            </div>
            <div class="input-group">
                <label>×–××Ÿ ×œ×‘×™×¦×•×¢</label>
                <input type="time" id="cont-time" class="input-field">
            </div>
            <button class="btn-submit" onclick="submitOrder('container')" style="background: var(--accent-container);">×¢×“×›×Ÿ ×™×•××Ÿ ××›×•×œ×•×ª</button>
        </div>
    </div>

    <datalist id="clients-list"></datalist>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60",
            projectId: "app-saban94-57361",
            appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ×–×™×”×•×™ ××›×©×™×¨
        document.getElementById('user-type').innerText = 
            /Android|iPhone|iPad/i.test(navigator.userAgent) ? 'ğŸ“± ××—×•×‘×¨ ×××•×‘×™×™×œ' : 'ğŸ’» ××—×•×‘×¨ ××“×¡×§×˜×•×¤';

        // ×˜×¢×™× ×ª ×œ×§×•×—×•×ª ×œ-Autocomplete
        let clientsData = {}; // Cache for client details
        db.collection('users').get().then(snap => {
            const dl = document.getElementById('clients-list');
            snap.forEach(doc => {
                const d = doc.data();
                if(d.name) {
                    clientsData[d.name] = d;
                    const opt = document.createElement('option');
                    opt.value = d.name;
                    dl.appendChild(opt);
                }
            });
        });

        function openForm(type) {
            if(type === 'material') document.getElementById('form-material').classList.add('active');
            if(type === 'container') {
                document.getElementById('form-container-waste').classList.add('active');
                document.getElementById('history-hint').style.opacity = '0';
            }
        }
        
        function closeForms() {
            document.querySelectorAll('.form-container').forEach(e => e.classList.remove('active'));
        }

        // ××™×œ×•×™ ××•×˜×•××˜×™ ×œ×—×•××¨×™×
        function autoFillAddress(name, prefix) {
            if(clientsData[name]) {
                document.getElementById(prefix + '-addr').value = clientsData[name].address || '';
            }
        }

        // ×”×œ×•×’×™×§×” ×”×—×›××” ×œ××›×•×œ×•×ª
        function checkContainerHistory(name) {
            if(!name) return;
            const hint = document.getElementById('history-hint');
            hint.style.opacity = '1';
            hint.innerText = 'ğŸ” ××—×¤×© ××›×•×œ×•×ª ×¤×¢×™×œ×•×ª...';
            
            // ×©××™×œ×ª×”: ××—×¤×© ×”×–×× ×ª ××›×•×œ×” ××—×¨×•× ×” ×©×œ ×”×œ×§×•×— ×©××™× ×” "×”×•×¦××”"
            db.collection('users')
              .where('name', '==', name)
              .where('serviceType', '==', 'container')
              .orderBy('lastUpdate', 'desc')
              .limit(1)
              .get().then(snap => {
                  if(!snap.empty) {
                      const lastOrder = snap.docs[0].data();
                      // ×× ×”××—×¨×•× ×” ×”×™×™×ª×” ×”×¦×‘×” ××• ×”×—×œ×¤×” -> ×›× ×¨××” ×¦×¨×™×š ×”×—×œ×¤×”/×”×•×¦××”
                      if(lastOrder.actionType !== '×”×•×¦××”') {
                          document.getElementById('cont-action').value = '×”×—×œ×¤×”'; // ×‘×¨×™×¨×ª ××—×“×œ ×—×›××”
                          document.getElementById('cont-addr').value = lastOrder.address || '';
                          hint.innerText = 'âœ… × ××¦××” ××›×•×œ×” ×¤×¢×™×œ×” ×‘×›×ª×•×‘×ª ×–×•. ×”×•×’×“×¨ ×œ"×”×—×œ×¤×”".';
                          hint.style.color = 'green';
                      } else {
                          document.getElementById('cont-action').value = '×”×¦×‘×”';
                          hint.innerText = 'â„¹ï¸ ×œ× × ××¦××” ××›×•×œ×” ×¤×¢×™×œ×”. ×”×•×’×“×¨ ×œ"×”×¦×‘×”".';
                          hint.style.color = '#555';
                      }
                  } else {
                      document.getElementById('cont-action').value = '×”×¦×‘×”';
                      hint.innerText = 'âœ¨ ×œ×§×•×— ×—×“×© ×‘××›×•×œ×•×ª.';
                  }
                  
                  // ×× ×™×© ×›×ª×•×‘×ª ×‘×–×™×›×¨×•×Ÿ ×”×›×œ×œ×™ ×•×œ× ××”××›×•×œ×” ×”××—×¨×•× ×”
                  if(!document.getElementById('cont-addr').value && clientsData[name]) {
                      document.getElementById('cont-addr').value = clientsData[name].address;
                  }
              });
        }

        function submitOrder(type) {
            document.getElementById('loader').style.display = 'flex';
            
            let data = {
                status: 1, // 1 = ×—×“×©
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if(type === 'material') {
                data.serviceType = 'material';
                data.name = document.getElementById('mat-client').value;
                data.address = document.getElementById('mat-addr').value;
                data.deliveryType = document.getElementById('mat-type').value; // ×¡×•×’ ××©××™×ª/×× ×•×£
                data.notes = document.getElementById('mat-desc').value;
                data.deliveryTime = document.getElementById('mat-time').value;
            } else {
                data.serviceType = 'container';
                data.name = document.getElementById('cont-client').value;
                data.orgId = document.getElementById('cont-num').value; // ××¡×¤×¨ ×”×–×× ×”
                data.actionType = document.getElementById('cont-action').value; // ×”×¦×‘×”/×”×—×œ×¤×”
                data.deliveryType = '××›×•×œ×” - ' + data.actionType; // ×œ×ª×¦×•×’×” ×‘×“×©×‘×•×¨×“
                data.address = document.getElementById('cont-addr').value;
                data.deliveryTime = document.getElementById('cont-time').value;
            }

            if(!data.name) {
                alert('× × ×œ×”×–×™×Ÿ ×©× ×œ×§×•×—');
                document.getElementById('loader').style.display = 'none';
                return;
            }

            db.collection('users').add(data).then(() => {
                document.getElementById('loader').style.display = 'none';
                alert('×”×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×œ×¡×™×“×•×¨!');
                location.reload();
            }).catch(err => {
                console.error(err);
                alert('×©×’×™××” ×‘×©×œ×™×—×”');
                document.getElementById('loader').style.display = 'none';
            });
        }
    </script>
</body>
</html>
