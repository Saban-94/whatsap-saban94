<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×—.×¡×‘×Ÿ - Neon Control Center</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00d2ff;
            --neon-green: #00ff41;
            --neon-yellow: #fbc02d;
            --whatsapp-dark: #0b141a;
        }
        body { background: #010409; color: white; margin: 0; font-family: 'Heebo', sans-serif; overflow: hidden; }

        /* ××“×“×™ ×¨××© ×“×£ - ××¤×§×˜ × ×™××•×Ÿ ×•× ×—×© */
        .metrics-bar {
            display: flex; justify-content: space-around; padding: 20px;
            background: rgba(255,255,255,0.02); border-bottom: 1px solid #333;
        }
        .metric-card {
            position: relative; background: #161b22; padding: 15px 30px;
            border-radius: 10px; text-align: center; cursor: pointer;
            min-width: 150px; overflow: hidden; transition: 0.3s;
        }
        .metric-card:hover { transform: translateY(-5px); background: #21262d; }
        
        /* ××¤×§×˜ × ×—×© (Snake Border) */
        .metric-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--status-color));
            animation: snake 2s linear infinite;
        }
        @keyframes snake { 0% { left: -100%; } 100% { left: 100%; } }

        .metric-num { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 10px var(--status-color); }
        .metric-label { font-size: 0.9rem; color: #8696a0; margin-top: 5px; }

        /* ×¦×‘×¢×™ ×¡×˜×˜×•×¡ × ×™××•×Ÿ */
        .status-1 { --status-color: var(--neon-blue); }
        .status-2 { --status-color: var(--neon-yellow); }
        .status-3 { --status-color: var(--neon-green); }

        /* ×¤×¨×™×¡×” ×¨××©×™×ª */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; height: calc(100vh - 150px); }
        .driver-col { border-left: 1px solid #333; overflow-y: auto; padding: 15px; }

        /* ×¤×•×¤××¤ ×¨×©×™××” */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center;
            align-items: center; z-index: 1000; backdrop-filter: blur(5px);
        }
        .popup-content {
            background: #161b22; width: 80%; max-width: 600px; max-height: 80vh;
            border-radius: 15px; padding: 20px; border: 1px solid #333; overflow-y: auto;
        }
    </style>
</head>
<body>

<div class="metrics-bar">
    <div class="metric-card status-1" onclick="openStatusPopup(1)">
        <div id="count-1" class="metric-num">0</div>
        <div class="metric-label">×”×–×× ×•×ª ×—×“×©×•×ª ğŸ“¥</div>
    </div>
    <div class="metric-card status-2" onclick="openStatusPopup(2)">
        <div id="count-2" class="metric-num">0</div>
        <div class="metric-label">×¢×œ×• ×œ××¢×¨×›×ª ğŸ’»</div>
    </div>
    <div class="metric-card status-3" onclick="openStatusPopup(3)">
        <div id="count-3" class="metric-num">0</div>
        <div class="metric-label">×‘×“×¨×š ×œ××¡×¤×§×” ğŸšš</div>
    </div>
</div>

<div class="main-grid">
    <div class="driver-col" id="col-truck">
        <h3 style="color:var(--neon-blue); border-bottom:1px solid #333; padding-bottom:10px;">× ×”×’ ××©××™×ª ğŸš›</h3>
        <div id="orders-truck"></div>
    </div>
    <div class="driver-col" id="col-crane">
        <h3 style="color:var(--neon-green); border-bottom:1px solid #333; padding-bottom:10px;">× ×”×’ ×× ×•×£ ğŸ—ï¸</h3>
        <div id="orders-crane"></div>
    </div>
</div>

<div id="status-popup" class="popup-overlay" onclick="closePopup()">
    <div class="popup-content" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 id="popup-title">×¨×©×™××ª ×”×–×× ×•×ª</h2>
            <i class="material-icons" style="cursor:pointer;" onclick="closePopup()">close</i>
        </div>
        <div id="popup-list"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script>
    // ×©×™××•×© ×‘×§×•× ×¤×™×’×•×¨×¦×™×” ××”×××’×¨
    const firebaseConfig = {
        apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60",
        projectId: "app-saban94-57361",
        appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let allOrders = [];

    // ×”××–× ×” ×—×™×” ×œ× ×ª×•× ×™×
    db.collection('users').onSnapshot(snap => {
        allOrders = [];
        let counts = { 1: 0, 2: 0, 3: 0 };
        const truckList = document.getElementById('orders-truck');
        const craneList = document.getElementById('orders-crane');
        truckList.innerHTML = ''; craneList.innerHTML = '';

        snap.forEach(doc => {
            const d = doc.data(); d.id = doc.id;
            if (d.status && d.status < 4) {
                allOrders.push(d);
                counts[d.status]++;
                renderToColumn(d, d.address && d.address.includes('×× ×•×£') ? craneList : truckList);
            }
        });

        // ×¢×“×›×•×Ÿ ×”××“×“×™× ×‘×¨××© ×”×“×£
        document.getElementById('count-1').innerText = counts[1];
        document.getElementById('count-2').innerText = counts[2];
        document.getElementById('count-3').innerText = counts[3];
    });

    function renderToColumn(d, container) {
        const orgId = d.orgId || `6210${Math.floor(10 + Math.random() * 90)}`;
        container.innerHTML += `
            <div class="order-card" style="margin-bottom:10px; border-right:4px solid var(--status-color); background:#161b22; padding:15px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between;">
                    <b>${d.name}</b>
                    <span style="color:var(--neon-blue)">#${orgId}</span>
                </div>
                <div style="font-size:0.8rem; color:#8696a0; margin-top:5px;">ğŸ“ ${d.address || '×¢×™×¨ ×œ× ×¦×•×™× ×”'}</div>
            </div>
        `;
    }

    // × ×™×”×•×œ ×¤×•×¤××¤×™×
    window.openStatusPopup = function(status) {
        const popup = document.getElementById('status-popup');
        const list = document.getElementById('popup-list');
        const titles = { 1: "×”×–×× ×•×ª ×—×“×©×•×ª", 2: "×¢×œ×• ×œ××¢×¨×›×ª", 3: "×‘×“×¨×š ×œ××¡×¤×§×”" };
        
        document.getElementById('popup-title').innerText = titles[status];
        list.innerHTML = '';
        
        const filtered = allOrders.filter(o => o.status === status);
        filtered.forEach(o => {
            list.innerHTML += `
                <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
                    <div><strong>${o.name}</strong><br><small>${o.address || ''}</small></div>
                    <button class="chip" onclick="updateStatusFromPopup('${o.id}', ${status + 1})">×§×“× ×©×œ×‘</button>
                </div>`;
        });
        popup.style.display = 'flex';
    };

    window.closePopup = () => document.getElementById('status-popup').style.display = 'none';

    window.updateStatusFromPopup = function(id, newStatus) {
        db.collection('users').doc(id).update({ status: newStatus, lastUpdate: firebase.firestore.FieldValue.serverTimestamp() });
        closePopup();
    };
</script>
</body>
</html>
