<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>×©×¢×¨ ×”×–×× ×•×ª | ×—. ×¡×‘×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Rubik', sans-serif; -webkit-tap-highlight-color: transparent; }
        .screen { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .screen.hidden { opacity: 0; pointer-events: none; position: absolute; transform: scale(0.95); }
        .product-search-results {
            position: absolute; background-color: white; border: 1px solid #ddd; border-radius: 0.5rem; max-height: 200px;
            overflow-y: auto; z-index: 1000; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .search-item { padding: 0.75rem; cursor: pointer; }
        .search-item:hover { background-color: #f0f0f0; }
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <div id="app-container" class="max-w-lg mx-auto bg-gray-50 min-h-screen shadow-2xl">
        
        <!-- ===== Loader Overlay ===== -->
        <div id="loader-overlay" class="hidden"><div class="loader"></div></div>

        <!-- ===== Login Screen ===== -->
        <div id="login-screen" class="screen p-8 flex flex-col items-center justify-center h-screen bg-white">
            <img src="https://placehold.co/150x50/000000/FFFFFF?text=%D7%97.+%D7%A1%D7%91%D7%9F" alt="×œ×•×’×• ×—. ×¡×‘×Ÿ" class="mb-8">
            <img src="https://placehold.co/100x100/EFEFEF/333333?text=AVATAR" class="rounded-full mb-6 shadow-md">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">×‘×¨×•×›×™× ×”×‘××™×</h1>
            <p class="text-gray-500 mb-8">×× × ×”×–×“×”×” ×›×“×™ ×œ×”××©×™×š</p>
            <input type="tel" id="login-input" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ / ×©× / ××¡' ×œ×§×•×—" class="w-full p-4 border-2 border-gray-200 bg-gray-50 rounded-lg text-center text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg mt-4 hover:bg-blue-700 transition-transform transform hover:scale-105 shadow-lg">
                ×›× ×™×¡×”
            </button>
        </div>

        <!-- ===== Dashboard Screen ===== -->
        <div id="dashboard-screen" class="screen hidden">
            <header class="bg-white border-b border-gray-200 p-4 flex justify-between items-center sticky top-0 z-20">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">×”×”×–×× ×•×ª ×©×œ×™</h1>
                    <p id="client-greeting" class="text-sm text-gray-500"></p>
                </div>
                <button id="logout-btn" class="text-sm text-red-500 font-semibold">×”×ª× ×ª×§</button>
            </header>
            <main class="p-4 pb-24">
                <div class="mb-4">
                    <input type="search" id="search-orders" placeholder="×—×™×¤×•×© ×œ×¤×™ ×œ×§×•×—, ×›×ª×•×‘×ª ××• ××¡×¤×¨ ×”×–×× ×”..." class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                </div>
                <div id="orders-list" class="space-y-3"></div>
            </main>
            <div class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto p-4 bg-white/80 backdrop-blur-sm border-t border-gray-200 z-10">
                 <button id="new-order-btn" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-xl shadow-xl hover:bg-blue-700 transition-transform transform hover:scale-105 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    ×”×–×× ×” ×—×“×©×”
                </button>
            </div>
        </div>

        <!-- ===== Order Screen ===== -->
        <div id="order-screen" class="screen hidden">
             <header class="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-20">
                <button id="back-to-dashboard-btn" class="text-2xl text-gray-600">â†’ </button>
                <h1 id="order-title" class="text-xl font-bold text-gray-800">×”×–×× ×” ×—×“×©×”</h1>
                <div class="w-8"></div>
            </header>
            <main class="p-4 pb-24">
                <div id="smart-paste-container" class="mb-6 bg-indigo-50 p-4 rounded-lg border border-dashed border-indigo-200">
                    <label class="block text-lg font-semibold text-indigo-800 mb-2">×”×“×‘×§×” ×—×›××” ×-WhatsApp</label>
                    <textarea id="smart-paste-area" rows="5" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×ª×•×›×Ÿ ×”×”×•×“×¢×”..."></textarea>
                    <button id="parse-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg mt-2 hover:bg-indigo-700 transition">× ×ª×— ×˜×§×¡×˜</button>
                </div>

                <form id="order-form" class="space-y-4">
                    <input type="hidden" id="order-id">
                    <div><label for="client-name" class="block font-medium text-gray-700">×©× ×œ×§×•×— / ×¤×¨×•×™×§×˜*</label><input type="text" id="client-name" class="w-full mt-1 p-3 border border-gray-300 rounded-lg bg-gray-50" required></div>
                    <div><label for="contact-phone" class="block font-medium text-gray-700">×˜×œ×¤×•×Ÿ ××™×© ×§×©×¨ ×‘×©×˜×—*</label><input type="tel" id="contact-phone" class="w-full mt-1 p-3 border border-gray-300 rounded-lg bg-gray-50" required></div>
                    <div><label for="delivery-address" class="block font-medium text-gray-700">×›×ª×•×‘×ª ××¡×¤×§×”*</label><input type="text" id="delivery-address" class="w-full mt-1 p-3 border border-gray-300 rounded-lg bg-gray-50" required></div>
                    <div><label for="delivery-date" class="block font-medium text-gray-700">×ª××¨×™×š ××¡×¤×§×”*</label><input type="date" id="delivery-date" class="w-full mt-1 p-3 border border-gray-300 rounded-lg bg-gray-50" required></div>

                    <div class="border-t pt-4">
                         <h3 class="text-lg font-semibold text-gray-800">×¤×¨×™×˜×™×</h3>
                         <div id="items-container" class="space-y-3 mt-2"></div>
                         <button type="button" id="add-item-btn" class="mt-2 text-blue-600 font-semibold">+ ×”×•×¡×£ ×¤×¨×™×˜</button>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-semibold text-gray-800">×§×‘×¦×™× ×•××™×§×•×</h3>
                        <div class="grid grid-cols-2 gap-3 mt-2">
                             <button type="button" id="attach-photo-btn" class="bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center">ğŸ“· ×¦×¨×£ ×ª××•× ×”</button>
                             <button type="button" id="attach-location-btn" class="bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center">ğŸ“ ×¦×¨×£ ××™×§×•×</button>
                        </div>
                        <input type="file" id="photo-input" class="hidden" accept="image/*">
                        <div id="attachments-preview" class="mt-3 space-y-2"></div>
                    </div>
                    
                    <div><label for="notes" class="block font-medium text-gray-700">×”×¢×¨×•×ª</label><textarea id="notes" rows="3" class="w-full mt-1 p-3 border border-gray-300 rounded-lg bg-gray-50"></textarea></div>
                </form>
            </main>
             <footer class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white/80 backdrop-blur-sm border-t p-3 grid grid-cols-2 gap-3 z-10">
                <button id="save-order-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition">×©××•×¨ ×”×–×× ×”</button>
                <button id="share-whatsapp-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition flex items-center justify-center" disabled>
                     <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 ml-2" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.586-1.456l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.803 6.283l-.52 1.905 1.973-.518zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                     ×©×ª×£
                </button>
            </footer>
        </div>

        <!-- Product Details Modal -->
        <div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-sm w-full p-4 relative">
                <button id="close-modal-btn" class="absolute top-2 left-2 text-2xl font-bold">&times;</button>
                <img id="modal-image" src="" alt="×ª××•× ×ª ××•×¦×¨" class="w-full h-48 object-contain mb-4 rounded">
                <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
                <p id="modal-description" class="text-gray-600"></p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJ81UzZAq-m8BJ11QY06rhFfcORUQDICpnhWoTim6u51hvd98ztuOscrj_svsIi_OK/exec';
            let state = { orders: [], currentOrder: null, currentClient: null, attachments: { photo: null, location: null } };
            
            const screens = {
                login: document.getElementById('login-screen'),
                dashboard: document.getElementById('dashboard-screen'),
                order: document.getElementById('order-screen')
            };
            const loader = document.getElementById('loader-overlay');
            const productModal = document.getElementById('product-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            
            function showLoader(show) {
                loader.classList.toggle('hidden', !show);
            }

            function navigateTo(screenName) {
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[screenName]) {
                    screens[screenName].classList.remove('hidden');
                }
            }
            
            async function loadOrdersFromServer() {
                showLoader(true);
                screens.dashboard.querySelector('#orders-list').innerHTML = `<p class="text-center text-gray-500">×˜×•×¢×Ÿ ×”×–×× ×•×ª...</p>`;
                try {
                    const response = await fetch(GAS_URL);
                    const result = await response.json();
                    if (result.success) state.orders = result.data; else throw new Error(result.error);
                } catch (error) {
                    console.error('Error fetching orders:', error);
                    alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×”×–×× ×•×ª ××”×©×¨×ª.');
                }
                renderDashboard();
                showLoader(false);
            }

            function renderDashboard() {
                const clientGreeting = screens.dashboard.querySelector('#client-greeting');
                clientGreeting.textContent = state.currentClient ? `×©×œ×•×, ${state.currentClient.clientName}` : '×¢×•×‘×“ ×›××•×¨×—';

                const ordersList = screens.dashboard.querySelector('#orders-list');
                ordersList.innerHTML = '';
                if (!state.orders || state.orders.length === 0) {
                    ordersList.innerHTML = `<div class="text-center p-8 bg-white rounded-lg"><p class="text-gray-500">×œ× × ××¦××• ×”×–×× ×•×ª.</p><p class="text-sm text-gray-400 mt-2">×œ×—×¥ ×¢×œ '×”×–×× ×” ×—×“×©×”' ×›×“×™ ×œ×”×ª×—×™×œ</p></div>`;
                } else {
                    state.orders.slice().reverse().forEach(order => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-xl border border-gray-200 shadow-sm cursor-pointer hover:shadow-md transition';
                        card.addEventListener('click', () => handleEditOrder(order.id));
                        const statusColors = { New: 'bg-blue-100 text-blue-800', Pending: 'bg-yellow-100 text-yellow-800', Confirmed: 'bg-green-100 text-green-800' };
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-lg text-gray-800">${order.clientName}</p>
                                    <p class="text-sm text-gray-600">${order.deliveryAddress}</p>
                                </div>
                                <span class="text-xs font-semibold px-3 py-1 rounded-full ${statusColors[order.status] || 'bg-gray-100 text-gray-800'}">${order.status || '×œ× ×™×“×•×¢'}</span>
                            </div>
                            <div class="mt-3 border-t pt-2 flex justify-between items-center text-sm text-gray-500">
                                <span>#${order.id}</span>
                                <span>${new Date(order.deliveryDate || Date.now()).toLocaleDateString('he-IL')}</span>
                            </div>
                        `;
                        ordersList.appendChild(card);
                    });
                }
            }

            function renderOrderForm(order) {
                state.currentOrder = order;
                state.attachments = { photo: null, location: null }; // Reset attachments
                document.getElementById('attachments-preview').innerHTML = '';

                const form = screens.order.querySelector('#order-form');
                form.reset();
                screens.order.querySelector('#smart-paste-area').value = '';
                form.querySelector('#order-id').value = order ? order.id : '';

                if (!order && state.currentClient) {
                    form.querySelector('#client-name').value = state.currentClient.clientName || '';
                    form.querySelector('#contact-phone').value = state.currentClient.contactPhone || '';
                    form.querySelector('#delivery-address').value = state.currentClient.defaultAddress || '';
                } else {
                    form.querySelector('#client-name').value = order ? order.clientName : '';
                    form.querySelector('#contact-phone').value = order ? order.contactPhone : '';
                    form.querySelector('#delivery-address').value = order ? order.deliveryAddress : '';
                }
                
                form.querySelector('#delivery-date').value = order ? order.deliveryDate : new Date().toISOString().split('T')[0];
                form.querySelector('#notes').value = order ? (order.notes || '') : '';

                renderItems(order ? order.items : []);
                screens.order.querySelector('#order-title').textContent = order ? `×¢×¨×™×›×ª ×”×–×× ×” #${order.id}` : '×”×–×× ×” ×—×“×©×”';
                screens.order.querySelector('#share-whatsapp-btn').disabled = !order;
                screens.order.querySelector('#smart-paste-container').style.display = order ? 'none' : 'block';
                navigateTo('order');
            }

            function renderItems(items) {
                const container = screens.order.querySelector('#items-container');
                container.innerHTML = '';
                if (items && items.length > 0) {
                    items.forEach(item => createItemRow(item.name, item.qty, item.sku));
                } else {
                     createItemRow();
                }
            }
            
            function createItemRow(name = '', qty = '', sku = '') {
                 const container = screens.order.querySelector('#items-container');
                 const itemRow = document.createElement('div');
                 itemRow.className = 'grid grid-cols-12 gap-2 items-center relative';
                 itemRow.innerHTML = `
                    <div class="col-span-7 relative">
                        <input type="text" placeholder="×”×§×œ×“ ×©× ××•×¦×¨..." autocomplete="off" value="${name}" class="product-search-input w-full p-3 border border-gray-300 rounded-lg bg-gray-50">
                        <div class="product-search-results hidden"></div>
                    </div>
                    <input type="hidden" class="item-sku" value="${sku}">
                    <input type="number" placeholder="×›××•×ª" value="${qty}" class="col-span-3 p-3 border border-gray-300 rounded-lg bg-gray-50 text-center">
                    <button type="button" class="col-span-2 text-red-500 font-bold text-2xl remove-item-btn flex items-center justify-center h-full">Ã—</button>
                 `;
                 container.appendChild(itemRow);
            }

            async function handleProductSearch(event) {
                const input = event.target;
                const resultsContainer = input.parentElement.querySelector('.product-search-results');
                const query = input.value.trim();

                if (query.length < 2) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.add('hidden');
                    return;
                }
                
                resultsContainer.classList.remove('hidden');
                resultsContainer.innerHTML = '<div class="p-2 text-center text-gray-500">××—×¤×©...</div>';

                try {
                    const response = await fetch(`${GAS_URL}?action=searchProducts&query=${encodeURIComponent(query)}`);
                    const result = await response.json();
                    if (result.success) {
                        renderSearchResults(result.data, input, resultsContainer);
                    } else { throw new Error(result.error); }
                } catch (error) {
                    console.error('Product search error:', error);
                    resultsContainer.innerHTML = `<div class="p-2 text-red-500">×©×’×™××” ×‘×—×™×¤×•×©</div>`;
                }
            }

            function renderSearchResults(products, input, container) {
                container.innerHTML = '';
                if (products.length === 0) {
                    container.innerHTML = `<div class="p-2 text-center text-gray-500">×œ× × ××¦××• ××•×¦×¨×™×</div>`;
                    return;
                }
                products.forEach(product => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'search-item border-b last:border-b-0 flex justify-between items-center';
                    itemDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${product.name}</p>
                            <p class="text-sm text-gray-500">××§"×˜: ${product.sku || 'N/A'}</p>
                        </div>
                        <div class="flex items-center space-x-3 rtl:space-x-reverse">
                            ${product.image ? `<span class="view-image-btn text-xl cursor-pointer">ğŸ‘ï¸</span>` : ''}
                            ${product.description ? `<span class="view-desc-btn text-xl cursor-pointer">â„¹ï¸</span>` : ''}
                        </div>
                    `;
                    itemDiv.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('view-image-btn') && !e.target.classList.contains('view-desc-btn')) {
                            const parentRow = input.closest('.relative');
                            parentRow.querySelector('.product-search-input').value = product.name;
                            parentRow.closest('.grid').querySelector('.item-sku').value = product.sku;
                            container.classList.add('hidden');
                        }
                    });
                    if (product.image) itemDiv.querySelector('.view-image-btn').addEventListener('click', () => showProductModal(product));
                    if (product.description) itemDiv.querySelector('.view-desc-btn').addEventListener('click', () => showProductModal(product));
                    container.appendChild(itemDiv);
                });
            }

            function showProductModal(product) {
                productModal.querySelector('#modal-image').src = product.image || 'https://placehold.co/400x300?text=No+Image';
                productModal.querySelector('#modal-image').classList.toggle('hidden', !product.image);
                productModal.querySelector('#modal-title').textContent = product.name;
                productModal.querySelector('#modal-description').textContent = product.description || '××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ.';
                productModal.classList.remove('hidden');
            }
            
            async function handleLogin() {
                const loginInput = screens.login.querySelector('#login-input');
                const loginBtn = screens.login.querySelector('#login-btn');
                const query = loginInput.value.trim();
                if (!query) return;
                showLoader(true);
                try {
                    const response = await fetch(`${GAS_URL}?action=findClient&query=${encodeURIComponent(query)}`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        state.currentClient = result.data;
                    } else {
                        state.currentClient = null;
                        alert('×œ×§×•×— ×œ× × ××¦×. × ×™×ª×Ÿ ×œ×”××©×™×š ×œ×™×¦×™×¨×ª ×”×–×× ×” ×—×“×©×” ×›××•×¨×—.');
                    }
                    await loadOrdersFromServer(); 
                    navigateTo('dashboard');
                } catch (error) {
                    console.error("Login error:", error);
                    alert("×©×’×™××” ×‘×ª×”×œ×™×š ×”×–×™×”×•×™. × ×›× ×¡ ×‘××¦×‘ ××•×¨×—.");
                    await loadOrdersFromServer();
                    navigateTo('dashboard');
                } finally {
                    showLoader(false);
                }
            }

            function handleEditOrder(orderId) {
                const order = state.orders.find(o => o.id == orderId);
                if(order) renderOrderForm(order);
            }

            async function handleSaveOrder() {
                const items = [];
                document.querySelectorAll('#items-container .grid').forEach(row => {
                    const name = row.querySelector('.product-search-input').value.trim();
                    const qty = row.querySelector('.item-qty').value.trim();
                    const sku = row.querySelector('.item-sku').value.trim();
                    if(name && qty) items.push({ name, qty, sku });
                });
                const orderData = {
                    id: document.getElementById('order-id').value || null,
                    clientName: document.getElementById('client-name').value.trim(),
                    contactPhone: document.getElementById('contact-phone').value.trim(),
                    deliveryAddress: document.getElementById('delivery-address').value.trim(),
                    deliveryDate: document.getElementById('delivery-date').value,
                    notes: document.getElementById('notes').value.trim(),
                    items: items,
                    attachments: state.attachments // Add attachments to the payload
                };
                if (!orderData.clientName || !orderData.contactPhone || !orderData.deliveryAddress || !orderData.deliveryDate) {
                    return alert('× × ×œ××œ× ××ª ×›×œ ×©×“×•×ª ×”×—×•×‘×” (*)');
                }
                
                showLoader(true);

                // If there's a photo, convert it to base64
                if (state.attachments.photo) {
                    try {
                        const base64 = await fileToBase64(state.attachments.photo.file);
                        orderData.attachments.photo.data = base64;
                    } catch (error) {
                        showLoader(false);
                        return alert('×©×’×™××” ×‘×”×›× ×ª ×”×ª××•× ×” ×œ×©×œ×™×—×”.');
                    }
                }
                
                try {
                    const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(orderData), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
                    const result = await response.json();
                    if (result.success) {
                        const savedOrder = result.data;
                        await loadOrdersFromServer(); 
                        renderOrderForm(savedOrder);
                        alert('×”×”×–×× ×” × ×©××¨×” ×‘×”×¦×œ×—×”!');
                    } else { throw new Error(result.error); }
                } catch (error) {
                    console.error('Error saving order:', error);
                    alert('×©×’×™××” ×‘×©××™×¨×ª ×”×”×–×× ×”: ' + error.message);
                } finally {
                    showLoader(false);
                }
            }
            
            function handleAttachPhoto() {
                document.getElementById('photo-input').click();
            }

            function handlePhotoSelected(event) {
                const file = event.target.files[0];
                if (file) {
                    state.attachments.photo = { file: file, name: file.name };
                    renderAttachmentsPreview();
                }
            }

            function handleAttachLocation() {
                if (!navigator.geolocation) {
                    return alert('×©×™×¨×•×ª×™ ××™×§×•× ××™× × × ×ª××›×™× ×‘×“×¤×“×¤×Ÿ ×–×”.');
                }
                showLoader(true);
                navigator.geolocation.getCurrentPosition(position => {
                    state.attachments.location = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    renderAttachmentsPreview();
                    showLoader(false);
                }, error => {
                    showLoader(false);
                    alert('×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ××ª ×”××™×§×•×.');
                    console.error('Geolocation error:', error);
                });
            }

            function renderAttachmentsPreview() {
                const container = document.getElementById('attachments-preview');
                container.innerHTML = '';
                if (state.attachments.photo) {
                    container.innerHTML += `<div class="bg-gray-100 p-2 rounded-lg flex justify-between items-center"><span>ğŸ“· ${state.attachments.photo.name}</span><button data-type="photo" class="text-red-500 remove-attachment-btn">Ã—</button></div>`;
                }
                if (state.attachments.location) {
                    const lat = state.attachments.location.lat.toFixed(4);
                    const lng = state.attachments.location.lng.toFixed(4);
                    container.innerHTML += `<div class="bg-gray-100 p-2 rounded-lg flex justify-between items-center"><span>ğŸ“ ××™×§×•× × ×©××¨ (${lat}, ${lng})</span><button data-type="location" class="text-red-500 remove-attachment-btn">Ã—</button></div>`;
                }
            }

            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
            }
            
            // --- Event Listeners Init ---
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', () => { state.currentClient = null; navigateTo('login'); });
            document.getElementById('new-order-btn').addEventListener('click', () => renderOrderForm(null));
            document.getElementById('back-to-dashboard-btn').addEventListener('click', () => { loadOrdersFromServer(); navigateTo('dashboard'); });
            document.getElementById('add-item-btn').addEventListener('click', () => createItemRow());
            document.getElementById('save-order-btn').addEventListener('click', handleSaveOrder);
            document.getElementById('attach-photo-btn').addEventListener('click', handleAttachPhoto);
            document.getElementById('photo-input').addEventListener('change', handlePhotoSelected);
            document.getElementById('attach-location-btn').addEventListener('click', handleAttachLocation);
            document.getElementById('attachments-preview').addEventListener('click', e => {
                if (e.target.classList.contains('remove-attachment-btn')) {
                    const type = e.target.dataset.type;
                    state.attachments[type] = null;
                    renderAttachmentsPreview();
                }
            });
            document.getElementById('items-container').addEventListener('click', (e) => {
                if(e.target.classList.contains('remove-item-btn')) {
                    if (document.querySelectorAll('#items-container .grid').length > 1) e.target.closest('.grid').remove();
                }
            });
            document.getElementById('items-container').addEventListener('input', (e) => {
                if (e.target.classList.contains('product-search-input')) {
                    clearTimeout(e.target.debounce);
                    e.target.debounce = setTimeout(() => handleProductSearch(e), 300);
                }
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.relative')) {
                    document.querySelectorAll('.product-search-results').forEach(res => res.classList.add('hidden'));
                }
            });
            closeModalBtn.addEventListener('click', () => productModal.classList.add('hidden'));

            navigateTo('login');
        });
    </script>
</body>
</html>

