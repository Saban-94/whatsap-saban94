<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>Saban Driver</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

    <style>
        :root { --primary: #00e676; --bg: #121212; --card: #1e1e1e; }
        body { background-color: var(--bg); color: #e0e0e0; font-family: 'Rubik', sans-serif; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        
        /* 住 住 */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; }
        .login-logo { width: 100px; height: 100px; background: var(--primary); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 50px; margin-bottom: 20px; box-shadow: 0 0 30px var(--primary); }
        .login-input { background: #222; border: 1px solid #444; color: white; text-align: center; font-size: 1.5rem; letter-spacing: 5px; border-radius: 12px; padding: 15px; width: 100%; margin-bottom: 20px; }
        
        /* 专住 砖 */
        .task-card {
            background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 12px;
            border-right: 5px solid var(--primary); position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .task-card:active { transform: scale(0.98); }
        .priority-high { border-right-color: #ff3b30; animation: flashBorder 2s infinite; }
        @keyframes flashBorder { 50% { border-right-color: transparent; } }

        .t-head { display: flex; justify-content: space-between; font-size: 0.85rem; color: #888; }
        .t-title { font-size: 1.2rem; font-weight: bold; color: white; margin: 5px 0; }
        .t-meta { font-size: 0.9rem; color: #bbb; display: flex; align-items: center; gap: 5px; }

        /* 驻转专 */
        .action-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }
        .btn-nav { background: #333; color: white; }
        .btn-done { background: var(--primary); color: black; }

        /* 转驻专 转转 */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: #1a1a1a; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { color: #666; text-align: center; font-size: 0.7rem; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-item i { font-size: 24px; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        /* 驻转专 转拽 */
        #install-btn { display: none; background: #0078d4; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; margin-bottom: 20px; width: 100%; }

    </style>
</head>
<body>

    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="login-screen">
        <div class="login-logo"><i class="material-icons">local_shipping</i></div>
        <h3 class="text-white mb-4">住转 </h3>
        <input type="tel" id="id-input" class="login-input" placeholder="住驻专 转注" maxlength="9">
        <button class="btn btn-success w-100 py-3 fw-bold fs-5" onclick="login()">住</button>
        <button id="install-btn" onclick="installApp()"> 转拽 驻拽爪</button>
    </div>

    <div id="app-screen" style="display:none;">
        <div class="p-3 bg-dark d-flex justify-content-between align-items-center sticky-top shadow-sm">
            <span class="text-white fw-bold">砖转 </span>
            <span class="badge bg-secondary" id="user-display">专</span>
        </div>

        <div class="container mt-3" style="padding-bottom: 100px;">
            <div id="tasks-list">
                <div class="text-center mt-5 text-muted">转 转...</div>
            </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active"><i class="material-icons">list</i>砖转</div>
            <div class="nav-item" onclick="testSound()"><i class="material-icons">volume_up</i>拽转 爪爪</div>
            <div class="nav-item" onclick="location.reload()"><i class="material-icons">refresh</i>专注</div>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60", projectId: "app-saban94-57361", appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa" }));
        
        let currentUser = null;
        let lastOrderCount = -1; // 注拽 专 转 砖转

        // ---  转拽 (PWA) ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').style.display = 'block';
        });

        window.installApp = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-btn').style.display = 'none';
                }
                deferredPrompt = null;
            }
        };

        // --- OneSignal (转专转 砖住专) ---
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(function(OneSignal) {
            OneSignal.init({
                appId: "YOUR-ONESIGNAL-APP-ID", // <-- 砖 驻 转 -ID 砖
            });
        });

        // --- 住 ---
        window.login = () => {
            const id = document.getElementById('id-input').value;
            if(id.length >= 2) {
                currentUser = id;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                document.getElementById('user-display').innerText = id;
                // 专砖 -OneSignal 注 转注转 转
                OneSignalDeferred.push(function(OneSignal) { OneSignal.login(id); });
                
                // 转转 
                startListening();
                
                //  "砖拽"  砖专专 转 住转  砖 驻驻
                playAlert(true);
            }
        };

        // --- 砖注转 爪 ---
        window.playAlert = (silent = false) => {
            const audio = document.getElementById('alert-sound');
            if(silent) { audio.volume = 0; audio.play().then(()=> audio.pause()).catch(()=>{}); audio.volume = 1; }
            else { 
                audio.currentTime = 0; 
                audio.play().catch(e => alert(" 砖! (抓 注 住 砖注转 爪)")); 
                navigator.vibrate([500, 200, 500]); // 专
            }
        };
        window.testSound = () => playAlert(false);

        // ---  转  转 ---
        function startListening() {
            onSnapshot(query(collection(db, "users")), (snap) => {
                const list = document.getElementById('tasks-list');
                list.innerHTML = '';
                let count = 0;
                
                snap.forEach(ds => {
                    const d = ds.data();
                    if(d.status !== 4) { // 专拽 砖转 驻转转
                        count++;
                        const isUrgent = d.targetTime && d.targetTime < new Date().toTimeString().substring(0,5);
                        const cls = isUrgent ? 'priority-high' : '';
                        
                        list.innerHTML += `
                        <div class="task-card ${cls} animate__animated animate__fadeIn">
                            <div class="t-head"><span>#${d.orgId||'--'}</span><span class="${isUrgent?'text-danger fw-bold':''}">${d.targetTime}</span></div>
                            <div class="t-title">${d.name}</div>
                            <div class="t-meta"><i class="material-icons" style="font-size:16px">location_on</i> ${d.address}</div>
                            <div class="t-meta mb-2"><i class="material-icons" style="font-size:16px">info</i> ${d.deliveryType} | ${d.driverName}</div>
                            <div class="d-flex gap-2">
                                <a href="waze://?q=${d.address}" class="action-btn btn-nav text-decoration-none"></a>
                                <button class="action-btn btn-done" onclick="done('${ds.id}')">爪注</button>
                            </div>
                        </div>`;
                    }
                });

                // ---  爪爪 ---
                //    注 专砖 (lastOrderCount != -1)
                //  住驻专 转  (count > lastOrderCount)
                if(lastOrderCount !== -1 && count > lastOrderCount) {
                    playAlert(); // 驻注 爪爪!
                    alert("  砖 转拽!");
                }
                lastOrderCount = count;
            });
        }

        window.done = async(id) => { if(confirm('住 砖?')) await updateDoc(doc(db,"users",id),{status:4}); };

    </script>
</body>
</html>
