<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××¨×›×– ×©×œ×™×˜×” - ×—.×¡×‘×Ÿ (××ª×•×§×Ÿ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Rubik', sans-serif; overflow-x: hidden; }
        
        /* ×¡×¨×’×œ ×¦×“ */
        .sidebar { position: fixed; right: 0; top: 0; bottom: 0; width: 260px; background: #263238; color: white; padding: 20px; z-index: 1000; display: flex; flex-direction: column; }
        .brand { text-align: center; font-weight: 900; font-size: 1.4rem; margin-bottom: 30px; color: #00e676; border-bottom: 1px solid #444; padding-bottom: 15px; }
        .nav-btn { background: transparent; border: none; color: #b0bec5; padding: 12px; margin-bottom: 8px; border-radius: 10px; text-align: right; display: flex; align-items: center; gap: 12px; width: 100%; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: #00e676; color: #121212; font-weight: bold; box-shadow: 0 4px 15px rgba(0,230,118,0.3); }
        
        /* ×ª×•×›×Ÿ */
        .main-content { margin-right: 260px; padding: 30px; }
        .card-box { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* ×›×¨×˜×™×¡×™ ×©×™×’×•×¨ ××”×™×¨ */
        .quick-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .quick-card { 
            background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; position: relative;
        }
        .quick-card:hover { border-color: #00e676; transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .quick-card:active { transform: scale(0.98); }
        .qc-icon { font-size: 2rem; color: #00e676; margin-bottom: 5px; }
        .qc-name { font-weight: bold; color: #333; }
        .qc-sub { font-size: 0.8rem; color: #888; margin-top: 2px; }

        /* ×¡×˜×•×“×™×• */
        .studio-panel { background: #1e1e1e; color: white; border-radius: 16px; padding: 20px; border: 1px solid #333; }
        .form-dark { background: #2c2c2c; border: 1px solid #444; color: white; }
        .form-dark:focus { background: #333; color: white; border-color: #00e676; box-shadow: none; }
        
        /* ×˜×‘×œ××•×ª */
        .table td { vertical-align: middle; }
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><i class="material-icons" style="vertical-align:middle">local_shipping</i> ×—.×¡×‘×Ÿ ×œ×•×’×™×¡×˜×™×§×”</div>
        <button class="nav-btn active" onclick="switchTab('live', this)"><i class="material-icons">dvr</i> ×œ×•×— ×‘×§×¨×”</button>
        <button class="nav-btn" onclick="switchTab('studio', this)"><i class="material-icons">campaign</i> ×¡×˜×•×“×™×• ×©×™×“×•×¨</button>
        <button class="nav-btn" onclick="switchTab('clients', this)"><i class="material-icons">people</i> × ×™×”×•×œ ×œ×§×•×—×•×ª</button>
        <button class="nav-btn" onclick="switchTab('history', this)"><i class="material-icons">history</i> ××¨×›×™×•×Ÿ</button>
    </div>

    <div class="main-content">
        
        <div id="tab-live" class="tab-pane">
            
            <div class="card-box">
                <h5 class="mb-3 text-secondary"><i class="material-icons" style="vertical-align:middle">rocket_launch</i> ×©×™×’×•×¨ ×”×–×× ×” ×œ×œ×§×•×— ×§×™×™×</h5>
                <div id="quick-grid" class="quick-grid">
                    <div class="text-muted p-2">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="fw-bold">×”×–×× ×•×ª ×¤×¢×™×œ×•×ª</h3>
                <button class="btn btn-primary shadow" onclick="openOrderModal()">
                    <i class="material-icons" style="vertical-align:middle">add</i> ×”×–×× ×” ×—×“×©×” (×¨×™×§)
                </button>
            </div>
            <div class="card-box p-0">
                <table class="table table-hover mb-0">
                    <thead class="bg-light"><tr><th>×ª×¢×•×“×”</th><th>×–××Ÿ</th><th>×œ×§×•×—</th><th>×›×ª×•×‘×ª</th><th>× ×”×’</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                    <tbody id="live-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-studio" class="tab-pane" style="display:none;">
            <div class="row">
                <div class="col-md-5">
                    <div class="studio-panel mb-3">
                        <h5>×¤×¡ ×—×“×©×•×ª (Ticker)</h5>
                        <input id="news-input" class="form-control form-dark mb-3" placeholder="×”×§×œ×“ ×”×•×“×¢×” ×¨×¦×”...">
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-sm btn-primary" onclick="updateNews('blue')">×›×—×•×œ</button>
                            <button class="btn btn-sm btn-danger" onclick="updateNews('red')">××“×•×</button>
                            <button class="btn btn-sm btn-success" onclick="updateNews('green')">×™×¨×•×§</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="studio-panel" style="border-color:#00e676;">
                        <h5 style="color:#00e676;">MEGA POPUP (×¤×•×¡×˜×¨)</h5>
                        <input id="pop-title" class="form-control form-dark mb-2" placeholder="×›×•×ª×¨×ª ×¨××©×™×ª">
                        <textarea id="pop-body" class="form-control form-dark mb-2" rows="2" placeholder="×ª×•×›×Ÿ ×”×”×•×“×¢×”..."></textarea>
                        <input id="pop-img" class="form-control form-dark mb-2" placeholder="×§×™×©×•×¨ ×œ×ª××•× ×” (URL)...">
                        
                        <div class="d-flex gap-2 mb-3 overflow-auto">
                            <button class="btn btn-outline-secondary btn-sm" onclick="setImg('https://img.freepik.com/free-photo/truck-highway_1112-964.jpg')">ğŸšš ××©××™×ª</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="setImg('https://img.freepik.com/free-photo/birthday-cake-with-candles_144627-42861.jpg')">ğŸ‚ ×¢×•×’×”</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="setImg('https://img.freepik.com/free-vector/warning-signs-collection_23-2148559052.jpg')">âš ï¸ ××–×”×¨×”</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="setImg('')">âŒ × ×§×”</button>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6"><select id="pop-icon" class="form-select form-dark"><option value="verified">âœ… ×•×™</option><option value="warning">âš ï¸ ××–×”×¨×”</option><option value="celebration">ğŸ‰ ×—×’×™×’×”</option></select></div>
                            <div class="col-6"><select id="pop-theme" class="form-select form-dark"><option value="neon">ğŸ’ × ×™××•×Ÿ</option><option value="gold">ğŸ¥‡ ×–×”×‘</option><option value="alert">ğŸš¨ ×—×™×¨×•×</option></select></div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success flex-fill" onclick="togglePopup(true)">×©×“×¨ ×œ××¡×š</button>
                            <button class="btn btn-danger flex-fill" onclick="togglePopup(false)">×›×‘×” ×©×™×“×•×¨</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-clients" class="tab-pane" style="display:none;">
            <div class="d-flex justify-content-between mb-3">
                <h3>× ×™×”×•×œ ×œ×§×•×—×•×ª</h3>
                <button class="btn btn-success" onclick="openClientModal()">+ ×”×•×¡×£ ×œ×§×•×— ×—×“×©</button>
            </div>
            <div class="card-box">
                <table class="table table-striped">
                    <thead><tr><th>×©× ×œ×§×•×—</th><th>×›×ª×•×‘×ª ×‘×¨×™×¨×ª ××—×“×œ</th><th>×¡×•×’</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                    <tbody id="clients-table"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-history" class="tab-pane" style="display:none;">
            <h3>××¨×›×™×•×Ÿ ×‘×™×¦×•×¢×™×</h3>
            <div class="card-box">
                <table class="table table-striped">
                    <thead><tr><th>×ª××¨×™×š</th><th>×œ×§×•×—</th><th>×›×ª×•×‘×ª</th><th>× ×”×’</th><th>××—×§</th></tr></thead>
                    <tbody id="history-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="orderModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white"><h5 class="modal-title">×¤×¨×˜×™ ×”×–×× ×”</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="orderForm">
                        <input type="hidden" id="o-id">
                        <div class="row g-2 mb-2">
                            <div class="col-4"><label>××¡' ×ª×¢×•×“×”</label><input id="o-oid" class="form-control" type="number"></div>
                            <div class="col-8"><label>×©× ×œ×§×•×—</label><input id="o-name" class="form-control" required></div>
                        </div>
                        <div class="mb-2"><label>×›×ª×•×‘×ª ××œ××”</label><input id="o-addr" class="form-control" placeholder="×¢×™×¨ ×•×¨×—×•×‘"></div>
                        <div class="row g-2 mb-2">
                            <div class="col-6"><label>× ×”×’</label><input id="o-drv" class="form-control"></div>
                            <div class="col-6"><label>×¡×•×’</label><select id="o-type" class="form-select"><option>×× ×•×£ 10 ××˜×¨</option><option>××›×•×œ×” 8 ×§×•×‘</option><option>××©××™×ª ×—×•××¨×™×</option></select></div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label>×ª××¨×™×š</label><input type="date" id="o-date" class="form-control"></div>
                            <div class="col-6"><label>×©×¢×”</label><input type="time" id="o-time" class="form-control"></div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">×©××•×¨ ×•×©×œ×—</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="clientModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white"><h5 class="modal-title">×œ×§×•×— ×—×“×©</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="clientForm">
                        <div class="mb-2"><label>×©×</label><input id="c-name" class="form-control" required></div>
                        <div class="mb-2"><label>×›×ª×•×‘×ª</label><input id="c-addr" class="form-control"></div>
                        <div class="mb-2"><label>×¡×•×’ ××•×¢×“×£</label><select id="c-type" class="form-select"><option>×× ×•×£ 10 ××˜×¨</option><option>××›×•×œ×” 8 ×§×•×‘</option></select></div>
                        <button type="submit" class="btn btn-success w-100">×©××•×¨</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, setDoc, doc, onSnapshot, query, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60", projectId: "app-saban94-57361", appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa" }));
        
        let allOrders = [];
        let allClients = []; // ××¢×¨×š ×œ×©××™×¨×ª ×”×œ×§×•×—×•×ª ×œ×©×™××•×© ×‘×œ×—×™×¦×”

        // 1. ×˜×¢×™× ×ª ×”×–×× ×•×ª
        onSnapshot(query(collection(db, "users"), orderBy("lastUpdate", "desc")), (snap) => {
            const l = document.getElementById('live-table-body');
            const h = document.getElementById('history-table');
            l.innerHTML = ''; h.innerHTML = ''; allOrders = [];

            snap.forEach(docSnap => {
                const d = docSnap.data(); d.id = docSnap.id; allOrders.push(d);
                if(d.status === 4) {
                    h.innerHTML += `<tr><td>${d.targetDate}</td><td>${d.name}</td><td>${d.address}</td><td>${d.driverName}</td><td><button class="btn btn-sm btn-outline-danger" onclick="del('${d.id}')">X</button></td></tr>`;
                } else {
                    l.innerHTML += `<tr><td>${d.orgId||'--'}</td><td class="text-primary fw-bold">${d.targetTime}</td><td><b>${d.name}</b></td><td>${d.address}</td><td>${d.driverName}<br><small>${d.deliveryType}</small></td><td><button class="btn btn-sm btn-light" onclick="edit('${d.id}')">×¢×¨×•×š</button> <button class="btn btn-sm btn-success" onclick="done('${d.id}')">âœ“</button></td></tr>`;
                }
            });
        });

        // 2. ×˜×¢×™× ×ª ×œ×§×•×—×•×ª (×•×ª×™×§×•×Ÿ ×”×›×¤×ª×•×¨×™×!)
        onSnapshot(collection(db, "clients"), (snap) => {
            const grid = document.getElementById('quick-grid');
            const table = document.getElementById('clients-table');
            grid.innerHTML = ''; table.innerHTML = ''; allClients = [];

            snap.forEach(docSnap => {
                const c = docSnap.data(); c.id = docSnap.id; allClients.push(c);

                // ×™×¦×™×¨×ª ×›×¨×˜×™×¡ ×œ×—×™×¥
                grid.innerHTML += `
                    <div class="quick-card" onclick="launchClient('${c.id}')">
                        <div class="qc-icon"><i class="material-icons">touch_app</i></div>
                        <div class="qc-name">${c.name}</div>
                        <div class="qc-sub">${c.type}</div>
                    </div>`;

                // ×™×¦×™×¨×ª ×©×•×¨×” ×‘×˜×‘×œ×”
                table.innerHTML += `
                    <tr>
                        <td><b>${c.name}</b></td>
                        <td>${c.address}</td>
                        <td>${c.type}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="launchClient('${c.id}')">ğŸš€ ×©×™×’×•×¨</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="delClient('${c.id}')">××—×§</button>
                        </td>
                    </tr>`;
            });
        });

        // 3. ×¤×•× ×§×¦×™×™×ª ×”×©×™×’×•×¨ (×”×—×©×•×‘×”!)
        window.launchClient = (clientId) => {
            const c = allClients.find(x => x.id === clientId);
            if (!c) { alert('×©×’×™××”: ×œ×§×•×— ×œ× × ××¦×'); return; }

            // ×¤×ª×™×—×ª ×”××•×“××œ ×•××™×œ×•×™ ×¤×¨×˜×™×
            window.openOrderModal();
            document.getElementById('o-name').value = c.name;
            document.getElementById('o-addr').value = c.address;
            document.getElementById('o-type').value = c.type;
            
            // ×ª××¨×™×š ×•×©×¢×” ××•×˜×•××˜×™×™× (×¢×›×©×™×•)
            const now = new Date();
            document.getElementById('o-date').valueAsDate = now;
            document.getElementById('o-time').value = now.toTimeString().substring(0,5);
        };

        // ×¤×•× ×§×¦×™×•×ª ××¢×¨×›×ª
        window.switchTab = (t, b) => { document.querySelectorAll('.tab-pane').forEach(e => e.style.display='none'); document.getElementById('tab-'+t).style.display='block'; document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); if(b)b.classList.add('active'); };
        
        window.openOrderModal = () => { document.getElementById('orderForm').reset(); document.getElementById('o-id').value=''; document.getElementById('o-date').valueAsDate=new Date(); new bootstrap.Modal(document.getElementById('orderModal')).show(); };
        
        window.edit = (id) => { const o=allOrders.find(x=>x.id===id); window.openOrderModal(); document.getElementById('o-id').value=id; document.getElementById('o-name').value=o.name; document.getElementById('o-oid').value=o.orgId; document.getElementById('o-addr').value=o.address; document.getElementById('o-drv').value=o.driverName; document.getElementById('o-type').value=o.deliveryType; document.getElementById('o-date').value=o.targetDate; document.getElementById('o-time').value=o.targetTime; };

        document.getElementById('orderForm').onsubmit = async(e) => { e.preventDefault(); const id=document.getElementById('o-id').value; const d={ name:document.getElementById('o-name').value, orgId:document.getElementById('o-oid').value, address:document.getElementById('o-addr').value, driverName:document.getElementById('o-drv').value, deliveryType:document.getElementById('o-type').value, targetDate:document.getElementById('o-date').value, targetTime:document.getElementById('o-time').value, lastUpdate:new Date() }; if(id) await updateDoc(doc(db,"users",id),d); else { d.status=1; await addDoc(collection(db,"users"),d); } bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide(); };
        
        window.openClientModal = () => new bootstrap.Modal(document.getElementById('clientModal')).show();
        document.getElementById('clientForm').onsubmit = async(e) => { e.preventDefault(); await addDoc(collection(db,"clients"), {name:document.getElementById('c-name').value, address:document.getElementById('c-addr').value, type:document.getElementById('c-type').value}); bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide(); };
        
        window.done = async(id) => updateDoc(doc(db,"users",id),{status:4});
        window.del = async(id) => { if(confirm('×œ××—×•×§?')) deleteDoc(doc(db,"users",id)); };
        window.delClient = async(id) => { if(confirm('×œ××—×•×§ ×œ×§×•×—?')) deleteDoc(doc(db,"clients",id)); };

        // ×¡×˜×•×“×™×•
        window.setImg = (u) => document.getElementById('pop-img').value = u;
        window.updateNews = async(c) => { let t='info'; if(c==='red')t='alert'; if(c==='green')t='success'; await setDoc(doc(db,"settings","news"),{text:document.getElementById('news-input').value, type:t}); alert('×¤×¡ ×¢×•×“×›×Ÿ'); };
        window.togglePopup = async(act) => { await setDoc(doc(db,"settings","popup"),{ active:act, title:document.getElementById('pop-title').value, text:document.getElementById('pop-body').value, icon:document.getElementById('pop-icon').value, theme:document.getElementById('pop-theme').value, imageUrl:document.getElementById('pop-img').value }); alert(act?'×©×•×“×¨':'×›×•×‘×”'); };
    </script>
</body>
</html>
