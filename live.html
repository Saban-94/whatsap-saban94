<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×—.×¡×‘×Ÿ - ××¡×š ×©×œ×™×˜×” ×¨××©×™</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body { margin: 0; background: #1e1e1e; font-family: 'Rubik', sans-serif; overflow: hidden; }

        /* --- 1. ×”×‘×¨ ×”×¢×œ×™×•×Ÿ (×œ×¤×™ ×”×ª××•× ×” ×©×œ×š) --- */
        .top-metrics-bar {
            position: absolute; top: 20px; left: 20px; right: 20px;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;
            z-index: 1000;
        }

        .metric-box {
            padding: 10px; border-radius: 12px; text-align: center; color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; justify-content: center;
            backdrop-filter: blur(5px);
        }

        .mb-dark { background: rgba(30, 60, 50, 0.9); border-bottom: 4px solid #fbc02d; }
        .mb-cyan { background: rgba(0, 200, 200, 0.9); border-bottom: 4px solid white; color: #003333; }
        .mb-green { background: rgba(20, 100, 80, 0.9); border-bottom: 4px solid #00e676; }
        .mb-teal { background: rgba(40, 140, 120, 0.9); border-bottom: 4px solid #80cbc4; }

        .m-val { font-size: 2rem; font-weight: 900; line-height: 1; }
        .m-label { font-size: 0.85rem; opacity: 0.9; margin-top: 5px; font-weight: 500; }

        /* --- 2. ××–×•×¨ ×¦×“ ×©×××œ (××§×“×•× ×œ×“×¡ + ×”×™×¡×˜×•×¨×™×”) --- */
        .sidebar-container {
            position: absolute; top: 110px; left: 20px; bottom: 20px; width: 350px;
            display: flex; flex-direction: column; gap: 15px; z-index: 1000;
        }

        /* ×¨×©×™××ª "××§×“×•× ×œ×“×¡" (×¤×¢×™×œ×™×) */
        .active-orders-panel {
            flex: 2; /* ×ª×•×¤×¡ ×™×•×ª×¨ ××§×•× */
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px; overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .panel-header {
            background: #263238; color: white; padding: 12px;
            font-weight: bold; display: flex; justify-content: space-between; align-items: center;
        }

        .active-list-scroll { flex: 1; overflow-y: auto; padding: 10px; }

        /* ×›×¨×˜×™×¡ ×”×–×× ×” ×¤×¢×™×œ×” (×¢×™×¦×•×‘ ×”××˜×‘×—) */
        .kitchen-ticket {
            background: white; border: 1px solid #ddd; margin-bottom: 8px;
            border-radius: 6px; padding: 8px; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-right: 6px solid #ccc; /* ×¦×‘×¢ ×¡×˜×˜×•×¡ */
            transition: 0.3s;
        }

        /* ×¦×‘×¢×™× ×œ×¤×™ ×–××Ÿ */
        .ticket-green { border-right-color: #00e676; }
        .ticket-yellow { border-right-color: #fbc02d; background: #fffde7; }
        .ticket-red { border-right-color: #ff3b30; background: #ffebee; animation: pulse-bg 2s infinite; }

        @keyframes pulse-bg { 0% { background: #ffebee; } 50% { background: #ffcdd2; } 100% { background: #ffebee; } }

        .k-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #555; border-bottom: 1px solid #eee; padding-bottom: 4px; margin-bottom: 4px; }
        .k-body { display: flex; justify-content: space-between; align-items: center; }
        .k-main { font-weight: bold; font-size: 1rem; color: #333; }
        .k-sub { font-size: 0.85rem; color: #666; }
        .k-driver { font-size: 0.8rem; background: #eee; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }
        
        .k-timer {
            font-family: monospace; font-size: 1.4rem; font-weight: 900;
            padding: 4px 8px; border-radius: 4px; background: #222; color: #00e676;
        }
        .ticket-yellow .k-timer { color: #fbc02d; }
        .ticket-red .k-timer { color: #ff3b30; animation: blink 1s infinite; }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* ×¨×©×™××ª "×¡×•×¤×§×•" (×œ××˜×”) */
        .completed-panel {
            flex: 1; /* ×¤×—×•×ª ××§×•× */
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .marquee-container { flex: 1; position: relative; overflow: hidden; }
        .marquee-content { position: absolute; width: 100%; top: 0; }
        .completed-item {
            padding: 8px 12px; border-bottom: 1px solid #eee; font-size: 0.85rem;
            display: flex; justify-content: space-between; color: #555;
        }

        /* --- ××¤×” --- */
        #map { width: 100vw; height: 100vh; }
        
        /* ×¡×™×›×•×ª */
        .pin-wrapper { position: relative; display: flex; justify-content: center; align-items: center; }
        .radar-blip { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #008069; position: absolute; animation: wave 2s infinite; }
        .center-dot { width: 36px; height: 36px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; position: relative; z-index: 2; border: 2px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        @keyframes wave { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }

    </style>
</head>
<body>

    <div class="top-metrics-bar">
        <div class="metric-box mb-dark">
            <div class="m-val"><i class="material-icons">history</i></div>
            <div class="m-label">××¨×›×™×•×Ÿ ×•×”×™×¡×˜×•×¨×™×”</div>
        </div>
        <div class="metric-box mb-cyan">
            <div class="m-val" id="top-next-time">--:--</div>
            <div class="m-label">××¡×¤×§×” ×§×¨×•×‘×”</div>
        </div>
        <div class="metric-box mb-green">
            <div class="m-val" id="top-clock">00:00</div>
            <div class="m-label">×©×¢×•×Ÿ ××§×•××™</div>
        </div>
        <div class="metric-box mb-teal">
            <div class="m-val" id="top-active-count">0</div>
            <div class="m-label">×¤×¢×™×œ ×›×¢×ª (05-17)</div>
        </div>
    </div>

    <div class="sidebar-container">
        <div class="active-orders-panel">
            <div class="panel-header">
                <span>ğŸ”¥ ×‘××˜×‘×— (×¤×¢×™×œ)</span>
                <span id="active-badge">0</span>
            </div>
            <div class="active-list-scroll" id="kitchen-list">
                </div>
        </div>

        <div class="completed-panel">
            <div class="panel-header" style="background:#455a64;">
                <span>âœ… ×¡×•×¤×§×• ×”×™×•×</span>
                <span id="comp-badge">0</span>
            </div>
            <div class="marquee-container">
                <div class="marquee-content" id="completed-list"></div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, updateDoc, doc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ×”×’×“×¨×•×ª Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60",
            authDomain: "app-saban94-57361.firebaseapp.com",
            projectId: "app-saban94-57361",
            storageBucket: "app-saban94-57361.firebasestorage.app",
            messagingSenderId: "275366913167",
            appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ××¤×”
        const map = L.map('map', { zoomControl: false }).setView([32.3215, 34.8532], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
        const markersLayer = L.layerGroup().addTo(map);
        const geoCache = {};

        // --- ×¢×–×¨×™× ---
        async function getCoords(address) {
            if(!address) return null;
            if(geoCache[address]) return geoCache[address];
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address+', Israel')}&limit=1`);
                const data = await res.json();
                if(data.length){
                    const c = {lat:data[0].lat, lon:data[0].lon};
                    geoCache[address]=c; return c;
                }
            }catch(e){}
            return null;
        }

        function getEmoji(type) {
            if(!type) return 'ğŸ“¦';
            if(type.includes('×× ×•×£')) return 'ğŸ—ï¸';
            if(type.includes('××›×•×œ×”')) return 'ğŸ—‘ï¸';
            if(type.includes('××©××™×ª')) return 'ğŸšš';
            return 'ğŸ“¦';
        }

        function getSecondsLeft(date, time) {
            if(!time) return 99999;
            const now = new Date();
            let target = date ? new Date(date) : new Date();
            const [h, m] = time.split(':');
            target.setHours(h, m, 0, 0);
            return Math.floor((target - now) / 1000);
        }

        function formatTimer(sec) {
            const abs = Math.abs(sec);
            const h = Math.floor(abs / 3600);
            const m = Math.floor((abs % 3600) / 60);
            const s = abs % 60;
            return `${sec<0?'-':''}${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        }

        // --- ×œ×•×’×™×§×” ×¨××©×™×ª ---
        const q = query(collection(db, "users"));
        onSnapshot(q, async (snap) => {
            markersLayer.clearLayers();
            const activeList = document.getElementById('kitchen-list');
            const compList = document.getElementById('completed-list');
            activeList.innerHTML = ''; compList.innerHTML = '';
            
            let activeCount = 0;
            let compCount = 0;
            let minSeconds = 999999;

            const promises = snap.docs.map(async docSnap => {
                const d = docSnap.data();
                const oid = d.orgId || docSnap.id.substring(0,4);
                
                // 1. ×¡×•×¤×§×•
                if(d.status === 4) {
                    compCount++;
                    const row = document.createElement('div');
                    row.className = 'completed-item';
                    row.innerHTML = `<div><b>${d.name}</b> (${d.deliveryType})</div><div><i class="material-icons" style="font-size:14px; color:green;">check</i></div>`;
                    compList.appendChild(row);
                    return;
                }

                // 2. ×¤×¢×™×œ×™×
                activeCount++;
                const seconds = getSecondsLeft(d.targetDate, d.targetTime);
                if(seconds < minSeconds) minSeconds = seconds;

                // ×™×¦×™×¨×ª ×›×¨×˜×™×¡ ×‘××˜×‘×— (×¨×©×™××” ×¢×œ×™×•× ×”)
                let colorClass = 'ticket-green';
                if(seconds < 1800) colorClass = 'ticket-yellow'; // 30 ×“×§×•×ª
                if(seconds < 0) colorClass = 'ticket-red'; // ××™×—×•×¨

                const ticket = document.createElement('div');
                ticket.className = `kitchen-ticket ${colorClass}`;
                ticket.innerHTML = `
                    <div class="k-header">
                        <span>#${oid}</span>
                        <span>${d.targetTime || '--:--'}</span>
                    </div>
                    <div class="k-body">
                        <div>
                            <div class="k-main">${d.name}</div>
                            <div class="k-sub">${d.deliveryType}</div>
                            <div class="k-driver">${d.driverName || '×œ×œ× × ×”×’'}</div>
                        </div>
                        <div class="k-timer" data-sec="${seconds}">${formatTimer(seconds)}</div>
                    </div>
                `;
                activeList.appendChild(ticket);

                // ×™×¦×™×¨×ª ×¡×™×›×” ×‘××¤×”
                if(d.address) {
                    const coords = await getCoords(d.address);
                    if(coords) {
                        const html = `
                            <div class="pin-wrapper">
                                <div class="radar-blip" style="border-color:${seconds<0?'red':'#008069'}"></div>
                                <div class="center-dot">${getEmoji(d.deliveryType)}</div>
                            </div>
                        `;
                        const icon = L.divIcon({ className:'c', html:html, iconSize:[40,40] });
                        L.marker([coords.lat,coords.lon], {icon}).addTo(markersLayer);
                    }
                }
            });

            await Promise.all(promises);
            
            // ×¢×“×›×•×Ÿ ××•× ×™× ×‘×‘×¨ ×”×¢×œ×™×•×Ÿ
            document.getElementById('top-active-count').innerText = activeCount;
            document.getElementById('active-badge').innerText = activeCount;
            document.getElementById('comp-badge').innerText = compCount;
            
            // ×–××Ÿ ×œ××¡×¤×§×” ×§×¨×•×‘×”
            if(minSeconds !== 999999) {
                const now = new Date();
                const next = new Date(now.getTime() + minSeconds*1000);
                document.getElementById('top-next-time').innerText = next.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            } else {
                document.getElementById('top-next-time').innerText = "--:--";
            }

            // ×’×œ×™×œ×” ×œ×¨×©×™××ª ×¡×•×¤×§×•
            const ch = compList.scrollHeight;
            if(ch > 200) {
                let p = 0;
                setInterval(()=>{ p--; if(Math.abs(p)>=ch) p=200; compList.style.top=p+'px'; }, 50);
            }
        });

        // ×¢×“×›×•×Ÿ ×˜×™×™××¨×™× ×—×™ (×‘×œ×™ ×§×¨×™××” ×œ×“××˜×” ×‘×™×™×¡)
        setInterval(() => {
            // ×©×¢×•×Ÿ
            document.getElementById('top-clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            
            // ×˜×™×™××¨×™× ×‘××˜×‘×—
            document.querySelectorAll('.k-timer').forEach(el => {
                let s = parseInt(el.getAttribute('data-sec'));
                s--;
                el.setAttribute('data-sec', s);
                el.innerText = formatTimer(s);
                
                // ×©×™× ×•×™ ×¦×‘×¢ ×“×™× ××™
                const card = el.closest('.kitchen-ticket');
                if(s < 0 && !card.classList.contains('ticket-red')) {
                    card.className = 'kitchen-ticket ticket-red';
                } else if (s < 1800 && s > 0 && !card.classList.contains('ticket-yellow')) {
                    card.className = 'kitchen-ticket ticket-yellow';
                }
            });
        }, 1000);

    </script>
</body>
</html>
