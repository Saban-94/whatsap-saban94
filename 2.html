<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×—.×¡×‘×Ÿ - ××¨×›×– ×©×œ×™×˜×” (Live)</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --accent: #008069;
            --alert-color: #ff3b30;
        }
        body { margin: 0; font-family: 'Heebo', sans-serif; background: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Top Metrics Bar */
        .top-bar {
            height: 80px; background: #252525; display: flex; align-items: center; padding: 0 20px; gap: 20px;
            border-bottom: 2px solid #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .metric-box {
            background: #333; padding: 10px 20px; border-radius: 8px; text-align: center; min-width: 100px;
        }
        .metric-val { font-size: 1.8rem; font-weight: bold; line-height: 1; }
        .metric-label { font-size: 0.8rem; opacity: 0.7; }
        
        #clock { font-size: 2.5rem; font-weight: 900; margin-right: auto; color: var(--accent); }

        /* Main Grid */
        .board { display: flex; flex: 1; padding: 20px; gap: 20px; overflow: hidden; }
        
        .column {
            flex: 1; background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px;
            display: flex; flex-direction: column; border: 1px solid #333;
        }
        .col-header { font-size: 1.4rem; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 10px; display: flex; justify-content: space-between; }
        
        .orders-list { flex: 1; overflow-y: auto; padding-right: 5px; }

        /* Order Card */
        .order-card {
            background: var(--card-bg); border-radius: 8px; padding: 15px; margin-bottom: 10px;
            border-right: 5px solid #555; position: relative; transition: 0.2s;
            display: grid; grid-template-columns: 1fr auto; gap: 10px;
        }
        .order-card:hover { transform: translateY(-2px); background: #2a2a2a; }
        
        /* Service Types Colors */
        .type-material { border-right-color: #2196f3; }
        .type-container { border-right-color: #ff9800; }
        
        .card-title { font-size: 1.2rem; font-weight: bold; }
        .card-sub { font-size: 0.9rem; color: #aaa; margin-top: 5px; }
        .card-time { 
            background: #333; padding: 5px 10px; border-radius: 5px; text-align: center;
            font-size: 1.2rem; font-weight: bold; min-width: 60px;
        }
        
        /* Red Alert Modal */
        .alert-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 0, 0, 0.2); z-index: 9999; display: none;
            justify-content: center; align-items: center;
            animation: bg-pulse 1s infinite alternate;
        }
        @keyframes bg-pulse { from { background: rgba(255, 0, 0, 0.1); } to { background: rgba(255, 0, 0, 0.4); } }
        
        .alert-box {
            background: #222; border: 4px solid var(--alert-color); padding: 40px; border-radius: 20px;
            text-align: center; box-shadow: 0 0 50px var(--alert-color); max-width: 600px; width: 90%;
            animation: box-shake 0.5s infinite;
        }
        /* Shake animation subtle */
        @keyframes box-shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        .alert-title { font-size: 3rem; color: var(--alert-color); margin: 0; font-weight: 900; }
        .alert-info { font-size: 2rem; margin: 20px 0; }
        .btn-ack { 
            background: var(--alert-color); color: white; border: none; padding: 15px 40px; font-size: 1.5rem; 
            font-weight: bold; cursor: pointer; border-radius: 10px; margin-top: 20px; 
        }
        .btn-ack:hover { background: #d32f2f; }

        /* Driver Input */
        .driver-input {
            background: #111; border: 1px solid #444; color: white; padding: 5px; width: 100%; margin-top: 5px;
        }
    </style>
</head>
<body>

    <audio id="sound-alert" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3" loop></audio>

    <div class="top-bar">
        <div style="font-weight:900; font-size:1.5rem; color:var(--accent);">×—.×¡×‘×Ÿ LOGISTICS</div>
        <div class="metric-box">
            <div class="metric-val" id="cnt-mat">0</div>
            <div class="metric-label">×—×•××¨×™ ×‘× ×™×™×Ÿ</div>
        </div>
        <div class="metric-box">
            <div class="metric-val" id="cnt-cont">0</div>
            <div class="metric-label">××›×•×œ×•×ª</div>
        </div>
        <div id="clock">00:00:00</div>
    </div>

    <div class="board">
        <div class="column">
            <div class="col-header">
                <span>ğŸ“¦ ×××ª×™×Ÿ ×œ×©×™×‘×•×¥ / ×™×¦×™××”</span>
                <span id="col-1-count">0</span>
            </div>
            <div id="list-pending" class="orders-list"></div>
        </div>
        
        <div class="column">
            <div class="col-header">
                <span>ğŸšš ×‘×‘×™×¦×•×¢ / ×‘×“×¨×š</span>
                <span id="col-2-count">0</span>
            </div>
            <div id="list-active" class="orders-list"></div>
        </div>
    </div>

    <div id="alert-modal" class="alert-overlay">
        <div class="alert-box">
            <h1 class="alert-title">âš ï¸ ×”×ª×¨××ª ×™×¦×™××”!</h1>
            <div class="alert-info">
                <div id="alert-client" style="font-weight:bold;">×™×•×¡×™ ×§×‘×œ×Ÿ</div>
                <div id="alert-type">×× ×•×£ 10 ××˜×¨</div>
                <div id="alert-dest" style="color:#aaa;">×ª×œ ××‘×™×‘</div>
                <div style="font-size:3rem; margin-top:10px;">â° ×”×’×™×¢ ×”×–××Ÿ!</div>
            </div>
            <button class="btn-ack" onclick="acknowledgeAlert()">×§×™×‘×œ×ª×™, ××˜×¤×œ!</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60",
            projectId: "app-saban94-57361",
            appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let activeOrdersData = [];
        let currentAlertId = null;

        // ×©×¢×•×Ÿ
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('he-IL', {hour12:false});
            checkAlerts(); // ×‘×“×™×§×ª ×”×ª×¨××•×ª ×›×œ ×©× ×™×™×”
        }, 1000);

        // ×”××–× ×” ×œ× ×ª×•× ×™×
        db.collection('users').orderBy('lastUpdate', 'desc').onSnapshot(snap => {
            const listPending = document.getElementById('list-pending');
            const listActive = document.getElementById('list-active');
            listPending.innerHTML = ''; listActive.innerHTML = '';
            
            activeOrdersData = [];
            let cMat = 0, cCont = 0;

            snap.forEach(doc => {
                const d = doc.data(); d.id = doc.id;
                
                if (d.status === 4) return; // ×”×™×¡×˜×•×¨×™×”

                activeOrdersData.push(d);
                if(d.serviceType === 'container') cCont++; else cMat++;

                const el = createCard(d);
                
                // ×œ×•×’×™×§×ª ×¢××•×“×•×ª: ×× ×™×© × ×”×’ ×•×¡×˜×˜×•×¡ > 1 ×–×” "×‘×‘×™×¦×•×¢", ××—×¨×ª "×××ª×™×Ÿ"
                if(d.status >= 2 || (d.driverName && d.driverName.length > 1)) {
                    listActive.appendChild(el);
                } else {
                    listPending.appendChild(el);
                }
            });

            document.getElementById('cnt-mat').innerText = cMat;
            document.getElementById('cnt-cont').innerText = cCont;
            document.getElementById('col-1-count').innerText = listPending.children.length;
            document.getElementById('col-2-count').innerText = listActive.children.length;
        });

        function createCard(d) {
            const div = document.createElement('div');
            const typeClass = d.serviceType === 'container' ? 'type-container' : 'type-material';
            const icon = d.serviceType === 'container' ? 'delete' : 'handyman';
            
            div.className = `order-card ${typeClass}`;
            div.innerHTML = `
                <div>
                    <div class="card-title"><i class="material-icons" style="vertical-align:middle; font-size:1.1rem;">${icon}</i> ${d.name}</div>
                    <div class="card-sub">${d.deliveryType || ''}</div>
                    <div class="card-sub">ğŸ“ ${d.address || '×œ× ×¦×•×™×Ÿ'}</div>
                    <input class="driver-input" placeholder="×©×™×‘×•×¥ × ×”×’..." value="${d.driverName || ''}" onchange="updateDriver('${d.id}', this.value)">
                </div>
                <div style="display:flex; flex-direction:column; align-items:center; gap:5px;">
                    <div class="card-time">${d.deliveryTime || '--:--'}</div>
                    <select onchange="updateStatus('${d.id}', this.value)" style="background:#333; color:white; border:none;">
                        <option value="1" ${d.status==1?'selected':''}>×××ª×™×Ÿ</option>
                        <option value="2" ${d.status==2?'selected':''}>×‘×˜×™×¤×•×œ</option>
                        <option value="3" ${d.status==3?'selected':''}>×™×¦×</option>
                        <option value="4">×¡×•×¤×§</option>
                    </select>
                </div>
            `;
            return div;
        }

        function checkAlerts() {
            const now = new Date();
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTimeVal = currentHours * 60 + currentMinutes;

            activeOrdersData.forEach(order => {
                if(!order.deliveryTime || order.status >= 3 || order.alertAck) return;

                const [h, m] = order.deliveryTime.split(':').map(Number);
                const orderTimeVal = h * 60 + m;
                const diff = orderTimeVal - currentTimeVal;

                // ×× × ×©××¨ 10 ×“×§×•×ª ××• ×¤×—×•×ª (×•×¢×“×™×™×Ÿ ×œ× ×¢×‘×¨ ×©×¢×” ×××– ×”×–××Ÿ)
                if (diff <= 10 && diff > -60) {
                    triggerAlert(order);
                }
            });
        }

        function triggerAlert(order) {
            if(document.getElementById('alert-modal').style.display === 'flex') return; // ×›×‘×¨ ××•×¦×’×ª ×”×ª×¨××”

            currentAlertId = order.id;
            document.getElementById('alert-client').innerText = order.name;
            document.getElementById('alert-type').innerText = order.deliveryType;
            document.getElementById('alert-dest').innerText = order.address;
            
            document.getElementById('alert-modal').style.display = 'flex';
            document.getElementById('sound-alert').play().catch(()=>{});
        }

        function acknowledgeAlert() {
            document.getElementById('alert-modal').style.display = 'none';
            document.getElementById('sound-alert').pause();
            document.getElementById('sound-alert').currentTime = 0;
            
            // ×¢×“×›×•×Ÿ ×‘×“××˜×”-×‘×™×™×¡ ×©×”×”×ª×¨××” ×˜×•×¤×œ×” ×›×“×™ ×œ× ×ª×¦×¤×¦×£ ×©×•×‘
            if(currentAlertId) {
                db.collection('users').doc(currentAlertId).update({ alertAck: true });
            }
        }

        function updateDriver(id, val) { db.collection('users').doc(id).update({ driverName: val }); }
        function updateStatus(id, val) { db.collection('users').doc(id).update({ status: parseInt(val) }); }
    </script>
</body>
</html>
