<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #00e676; --bg: #121212; --card: #1e1e1e; --nav: #263238; }
        body { background-color: var(--bg); color: #e0e0e0; font-family: 'Rubik', sans-serif; padding-bottom: 80px; user-select: none; }
        
        /* --- ××¡×š ×›× ×™×¡×” --- */
        #login-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center;
        }
        .login-logo { width: 80px; height: 80px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #000; margin-bottom: 20px; box-shadow: 0 0 30px var(--primary); }
        .login-input { background: #333; border: 1px solid #555; color: white; text-align: center; font-size: 1.5rem; letter-spacing: 5px; border-radius: 12px; padding: 15px; margin-bottom: 20px; width: 100%; }
        
        /* --- ×›×¨×˜×™×¡×™ ×”×–×× ×” --- */
        .order-card {
            background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 15px;
            border-left: 5px solid #555; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .st-green { border-left-color: var(--primary); }
        .st-yellow { border-left-color: #fbc02d; }
        .st-red { border-left-color: #ff3b30; }

        .oc-header { display: flex; justify-content: space-between; font-size: 0.9rem; color: #888; margin-bottom: 5px; }
        .oc-title { font-size: 1.2rem; font-weight: bold; color: white; margin-bottom: 2px; }
        .oc-meta { font-size: 0.9rem; color: #bbb; display: flex; gap: 10px; align-items: center; }
        .oc-actions { margin-top: 15px; display: flex; gap: 10px; }
        
        .btn-action { flex: 1; border-radius: 8px; padding: 8px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }

        /* --- ×ª×¤×¨×™×˜ ×ª×—×ª×•×Ÿ (App Bar) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: var(--nav); display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #333; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .nav-item { color: #90a4ae; text-align: center; font-size: 0.75rem; flex: 1; padding: 10px 0; }
        .nav-item i { font-size: 24px; display: block; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: scale(1.1); text-shadow: 0 0 10px var(--primary); }

        /* --- ×›×¤×ª×•×¨ ×¤×œ×•×¡ ×¦×£ --- */
        .fab {
            position: fixed; bottom: 85px; left: 20px;
            width: 60px; height: 60px; background: var(--primary); color: black;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 5px 20px rgba(0,230,118,0.4); font-size: 30px; z-index: 900;
            border: none;
        }

        /* --- ×¡×˜×•×“×™×• --- */
        .studio-box { background: #222; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; }
        .color-opt { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; display: inline-block; margin-left: 10px; }
        .color-opt.selected { border-color: white; transform: scale(1.1); }

        /* ×“×¤×™× */
        .page { display: none; padding: 20px; padding-top: 10px; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ××•×“××œ ×›×”×” */
        .modal-content { background: #222; color: white; border: 1px solid #444; }
        .form-control, .form-select { background: #333; border: 1px solid #555; color: white; }
        .form-control:focus { background: #444; color: white; border-color: var(--primary); box-shadow: none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-logo"><i class="material-icons">local_shipping</i></div>
        <h3 class="mb-4">×—.×¡×‘×Ÿ ×œ×•×’×™×¡×˜×™×§×”</h3>
        <p class="text-muted">× × ×œ×”×–×“×”×•×ª ×‘×××¦×¢×•×ª ××¡×¤×¨ ×¢×•×‘×“ / ×ª.×–</p>
        <input type="tel" id="user-id" class="login-input" placeholder="0000" maxlength="9">
        <button class="btn btn-success w-100 py-3 fw-bold" onclick="tryLogin()">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
        <div id="login-error" class="text-danger mt-3" style="display:none;">×¤×¨×˜×™ ×–×™×”×•×™ ×©×’×•×™×™×</div>
    </div>

    <div id="app-container" style="display:none;">
        
        <button class="fab" onclick="openOrderModal()" id="fab-btn"><i class="material-icons">add</i></button>

        <div id="page-orders" class="page active">
            <h4 class="mb-3 fw-bold"><i class="material-icons text-success" style="vertical-align:middle;">dvr</i> ×œ×•×— ×¤×¢×™×œ</h4>
            
            <div style="overflow-x: auto; white-space: nowrap; padding-bottom: 10px; margin-bottom: 10px;">
                <div id="quick-clients-row" style="display: inline-flex; gap: 10px;"></div>
            </div>

            <div id="orders-list">
                <div class="text-center mt-5 text-muted">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
            </div>
        </div>

        <div id="page-studio" class="page">
            <h4 class="mb-3 fw-bold"><i class="material-icons text-warning" style="vertical-align:middle;">palette</i> ×¡×˜×•×“×™×• ×©×™×“×•×¨</h4>
            
            <div class="studio-box">
                <h6 class="text-muted mb-3">ğŸ“¢ ×¤×¡ ×—×“×©×•×ª ×ª×—×ª×•×Ÿ</h6>
                <input id="news-in" class="form-control mb-2" placeholder="×›×ª×•×‘ ×”×•×“×¢×” ×¨×¦×”...">
                <div class="d-flex mb-3">
                    <div class="color-opt" style="background:#0078d4" onclick="setNewsColor('blue',this)"></div>
                    <div class="color-opt" style="background:#d32f2f" onclick="setNewsColor('red',this)"></div>
                    <div class="color-opt" style="background:#2e7d32" onclick="setNewsColor('green',this)"></div>
                </div>
                <button class="btn btn-outline-light w-100" onclick="updateNews()">×¢×“×›×Ÿ ×¤×¡ ×—×“×©×•×ª</button>
            </div>

            <div class="studio-box">
                <h6 class="text-muted mb-3">ğŸ’ ×¤×•×¤-××¤ ××ª×¤×¨×¥ (MEGA)</h6>
                <input id="pop-title" class="form-control mb-2" placeholder="×›×•×ª×¨×ª (×œ××©×œ: ×”×•×“×¢×” ×—×©×•×‘×”)">
                <textarea id="pop-body" class="form-control mb-2" rows="3" placeholder="×ª×•×›×Ÿ ×”×”×•×“×¢×”..."></textarea>
                <select id="pop-theme" class="form-select mb-3">
                    <option value="neon">×¢×™×¦×•×‘ × ×™××•×Ÿ</option>
                    <option value="gold">×¢×™×¦×•×‘ ×–×”×‘</option>
                    <option value="alert">×¢×™×¦×•×‘ ×—×™×¨×•×</option>
                </select>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary flex-fill" onclick="togglePopup(true)">×©×“×¨ ğŸš€</button>
                    <button class="btn btn-dark flex-fill" onclick="togglePopup(false)">×›×‘×” ğŸ›‘</button>
                </div>
            </div>
        </div>

        <div id="page-history" class="page">
            <h4 class="mb-3 fw-bold"><i class="material-icons text-secondary" style="vertical-align:middle;">history</i> ××¨×›×™×•×Ÿ</h4>
            <div id="history-list"></div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="nav('orders', this)">
                <i class="material-icons">list_alt</i>
                <span>×”×–×× ×•×ª</span>
            </div>
            <div class="nav-item" onclick="nav('studio', this)">
                <i class="material-icons">campaign</i>
                <span>×¡×˜×•×“×™×•</span>
            </div>
            <div class="nav-item" onclick="nav('history', this)">
                <i class="material-icons">history</i>
                <span>××¨×›×™×•×Ÿ</span>
            </div>
        </nav>
    </div>

    <div class="modal fade" id="orderModal">
        <div class="modal-dialog modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">×¤×¨×˜×™ ×”×–×× ×”</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="orderForm">
                        <input type="hidden" id="o-id">
                        <div class="mb-2"><label>×œ×§×•×—</label><input id="o-name" class="form-control" required></div>
                        <div class="mb-2"><label>×›×ª×•×‘×ª (×œ××¤×”)</label><input id="o-addr" class="form-control" placeholder="×¢×™×¨ ×•×¨×—×•×‘"></div>
                        <div class="row g-2 mb-2">
                            <div class="col-6"><label>×ª×¢×•×“×” #</label><input id="o-oid" class="form-control" type="number"></div>
                            <div class="col-6"><label>× ×”×’</label><input id="o-drv" class="form-control"></div>
                        </div>
                        <div class="mb-2"><label>×¡×•×’</label>
                            <select id="o-type" class="form-select">
                                <option>×× ×•×£ 10 ××˜×¨</option><option>×× ×•×£ 15 ××˜×¨</option><option>××›×•×œ×” 8 ×§×•×‘</option><option>××©××™×ª ×—×•××¨×™×</option>
                            </select>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label>×ª××¨×™×š</label><input type="date" id="o-date" class="form-control"></div>
                            <div class="col-6"><label>×©×¢×”</label><input type="time" id="o-time" class="form-control"></div>
                        </div>
                        <button type="submit" class="btn btn-success w-100 py-3">×©××•×¨ ×•×©×œ×—</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, setDoc, doc, onSnapshot, query, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyBGYsZylsIyeWudp8_SlnLBelkgoNXjU60", projectId: "app-saban94-57361", appId: "1:275366913167:web:f0c6f808e12f2aeb58fcfa" }));
        
        let newsColor = 'blue';
        let allOrders = [];

        // --- ×œ×•×’×™×§×ª ×›× ×™×¡×” ---
        window.tryLogin = () => {
            const id = document.getElementById('user-id').value;
            // ×‘×“×™×§×” ×¤×©×•×˜×”: ×× ×™×© ××©×”×• ×•×”×•× ×‘××•×¨×š ×”×’×™×•× ×™ (××• ×¨×©×™××” ×¡×’×•×¨×” ×©×œ×š)
            if(id && id.length >= 4) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        };

        // --- × ×™×•×•×˜ ---
        window.nav = (pageId, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');

            // ×”×¡×ª×¨×ª ×›×¤×ª×•×¨ ×¤×œ×•×¡ ×‘×¢××•×“×™× ×©×œ× ×¨×œ×•×•× ×˜×™×™×
            document.getElementById('fab-btn').style.display = pageId === 'orders' ? 'flex' : 'none';
        };

        // --- ×˜×¢×™× ×ª × ×ª×•× ×™× ---
        onSnapshot(query(collection(db, "users"), orderBy("lastUpdate", "desc")), (snap) => {
            const list = document.getElementById('orders-list');
            const hist = document.getElementById('history-list');
            list.innerHTML = ''; hist.innerHTML = '';
            allOrders = [];

            snap.forEach(docSnap => {
                const d = docSnap.data(); d.id = docSnap.id; allOrders.push(d);
                const oid = d.orgId || '---';

                if(d.status === 4) {
                    // ×”×™×¡×˜×•×¨×™×”
                    hist.innerHTML += `
                    <div class="order-card" style="border-color:#555; opacity:0.7;">
                        <div class="oc-header"><span>${d.targetDate}</span><span>#${oid}</span></div>
                        <div class="oc-title">${d.name}</div>
                        <div class="oc-meta">${d.deliveryType} â€¢ ${d.driverName||'-'}</div>
                        <div class="oc-actions">
                             <div class="btn-action bg-danger text-white" onclick="del('${d.id}')"><i class="material-icons">delete</i> ××—×§ ×œ×¦××™×ª×•×ª</div>
                        </div>
                    </div>`;
                } else {
                    // ×¤×¢×™×œ
                    // ×—×™×©×•×‘ ×¦×‘×¢ ×œ×¤×™ ×–××Ÿ
                    let st = 'st-green';
                    // ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×ª ×–××Ÿ ×›××• ×‘××¤×”, ××‘×œ × ×©××•×¨ ×¤×©×•×˜ ×›×¨×’×¢
                    
                    list.innerHTML += `
                    <div class="order-card ${st}">
                        <div class="oc-header"><span>${d.targetTime}</span><span>#${oid}</span></div>
                        <div class="oc-title">${d.name}</div>
                        <div class="oc-meta">
                            <i class="material-icons" style="font-size:16px">location_on</i> ${d.address || '×—×¡×¨×” ×›×ª×•×‘×ª'}
                        </div>
                        <div class="oc-meta mt-1">
                            <i class="material-icons" style="font-size:16px">person</i> ${d.driverName || '×œ×œ× × ×”×’'} | ${d.deliveryType}
                        </div>
                        <div class="oc-actions">
                            <div class="btn-action bg-secondary text-white" onclick="edit('${d.id}')">×¢×¨×•×š</div>
                            <div class="btn-action bg-success text-white" onclick="done('${d.id}')">×¡×•×¤×§</div>
                        </div>
                    </div>`;
                }
            });
        });

        // --- ×œ×§×•×—×•×ª (×©×™×’×•×¨ ××”×™×¨) ---
        onSnapshot(collection(db, "clients"), (snap) => {
            const row = document.getElementById('quick-clients-row');
            row.innerHTML = '';
            snap.forEach(s => {
                const c = s.data();
                row.innerHTML += `
                <div onclick="quickLaunch('${c.name}','${c.address}','${c.type}')" 
                     style="background:#333; padding:10px 15px; border-radius:20px; border:1px solid #555; display:flex; align-items:center; gap:5px;">
                    <i class="material-icons text-success" style="font-size:18px">person</i> ${c.name}
                </div>`;
            });
        });

        // --- ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ ---
        window.openOrderModal = () => {
            document.getElementById('orderForm').reset();
            document.getElementById('o-id').value = '';
            document.getElementById('o-date').valueAsDate = new Date();
            new bootstrap.Modal(document.getElementById('orderModal')).show();
        };

        window.quickLaunch = (name, addr, type) => {
            openOrderModal();
            document.getElementById('o-name').value = name;
            document.getElementById('o-addr').value = addr;
            document.getElementById('o-type').value = type;
        };

        window.edit = (id) => {
            const o = allOrders.find(x => x.id === id);
            document.getElementById('o-id').value = id;
            document.getElementById('o-name').value = o.name;
            document.getElementById('o-addr').value = o.address;
            document.getElementById('o-oid').value = o.orgId;
            document.getElementById('o-drv').value = o.driverName;
            document.getElementById('o-type').value = o.deliveryType;
            document.getElementById('o-date').value = o.targetDate;
            document.getElementById('o-time').value = o.targetTime;
            new bootstrap.Modal(document.getElementById('orderModal')).show();
        };

        document.getElementById('orderForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('o-id').value;
            const d = {
                name: document.getElementById('o-name').value,
                address: document.getElementById('o-addr').value,
                orgId: document.getElementById('o-oid').value,
                driverName: document.getElementById('o-drv').value,
                deliveryType: document.getElementById('o-type').value,
                targetDate: document.getElementById('o-date').value,
                targetTime: document.getElementById('o-time').value,
                lastUpdate: new Date()
            };
            if(id) await updateDoc(doc(db,"users",id), d);
            else { d.status=1; await addDoc(collection(db,"users"), d); }
            bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
        };

        window.done = async (id) => updateDoc(doc(db,"users",id), {status:4});
        window.del = async (id) => { if(confirm('×œ××—×•×§?')) deleteDoc(doc(db,"users",id)); };

        // --- ×¡×˜×•×“×™×• ---
        window.setNewsColor = (c, el) => {
            newsColor = c;
            document.querySelectorAll('.color-opt').forEach(x => x.style.borderColor='transparent');
            el.style.borderColor='white';
        };

        window.updateNews = async () => {
            const txt = document.getElementById('news-in').value;
            let type='info'; 
            if(newsColor==='red') type='alert'; 
            if(newsColor==='green') type='success';
            await setDoc(doc(db, "settings", "news"), { text:txt, type:type, timestamp:new Date() });
            alert('×¤×¡ ×—×“×©×•×ª ×¢×•×“×›×Ÿ');
        };

        window.togglePopup = async (active) => {
            const data = {
                active: active,
                title: document.getElementById('pop-title').value,
                text: document.getElementById('pop-body').value,
                theme: document.getElementById('pop-theme').value
            };
            await setDoc(doc(db, "settings", "popup"), data);
            alert(active ? '×¤×•×¤-××¤ ×©×•×“×¨' : '×¤×•×¤-××¤ ×›×•×‘×”');
        };

    </script>
</body>
</html>
